<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Copilot - Project Portfolio Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .chat-container {
            height: 500px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            background: #f8f9fa;
        }
        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 15px;
            max-width: 80%;
            word-wrap: break-word;
        }
        .user-message {
            background: #007bff;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }
        .ai-message {
            background: white;
            border: 1px solid #dee2e6;
            margin-right: auto;
            border-bottom-left-radius: 5px;
            white-space: pre-line;
            line-height: 1.6;
            padding: 15px 20px;
        }
        .ai-message br {
            margin-bottom: 8px;
        }
        .ai-message strong {
            color: #007bff;
            font-weight: 600;
        }
        .ai-message ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        .ai-message li {
            margin: 5px 0;
        }
        .system-message {
            background: #6c757d;
            color: white;
            margin: 10px auto;
            text-align: center;
            max-width: 60%;
        }
        .context-item {
            background: #e9ecef;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 8px;
            margin: 5px 0;
            font-size: 0.9em;
        }
        .context-item:hover {
            background: #dee2e6;
            cursor: pointer;
        }
        .mode-selector {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 15px;
        }
        .conversation-history {
            max-height: 300px;
            overflow-y: auto;
        }
        .conversation-item {
            padding: 8px;
            border-bottom: 1px solid #dee2e6;
            cursor: pointer;
        }
        .conversation-item:hover {
            background: #f8f9fa;
        }
        .conversation-item.active {
            background: #007bff;
            color: white;
        }
        .file-upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 5px;
            padding: 20px;
            text-align: center;
            background: #f8f9fa;
            transition: all 0.3s ease;
        }
        .file-upload-area:hover {
            border-color: #007bff;
            background: #e3f2fd;
        }
        .file-upload-area.dragover {
            border-color: #007bff;
            background: #e3f2fd;
        }
        .document-list {
            max-height: 200px;
            overflow-y: auto;
        }
        .document-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            margin: 5px 0;
            background: white;
        }
        .document-item:hover {
            background: #f8f9fa;
        }
        .typing-indicator {
            display: none;
            padding: 10px;
            color: #6c757d;
            font-style: italic;
        }
        .typing-indicator.show {
            display: block;
        }
        .context-badge {
            background: #17a2b8;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8em;
            margin: 2px;
            display: inline-block;
        }
        .interactive-buttons {
            margin-top: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .action-button {
            padding: 8px 15px;
            border: none;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .action-button.primary { background: #007bff; color: white; }
        .action-button.success { background: #28a745; color: white; }
        .action-button.info { background: #17a2b8; color: white; }
        .action-button.warning { background: #ffc107; color: #212529; }
        .action-button.danger { background: #dc3545; color: white; }
        .action-button.secondary { background: #6c757d; color: white; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">🚀 PPM System</a>
            <div class="navbar-nav">
                <a class="nav-link" href="/web/dashboard">Dashboard</a>
                <a class="nav-link" href="/web/projects">Projects</a>
                <a class="nav-link" href="/web/resources">Resources</a>
                <a class="nav-link" href="/web/finance">Finance</a>
                <a class="nav-link active" href="/web/ai-copilot">AI Copilot</a>
                <a class="nav-link" href="/web/alerts">Alerts</a>
                <a class="nav-link" href="/web/reports">Reports</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-3">
                <!-- Conversation History Panel -->
                <div class="card mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6>Conversation History</h6>
                        <button class="btn btn-sm btn-outline-primary" onclick="startNewConversation()">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="conversationHistory" class="conversation-history">
                            <p class="text-muted">No conversations yet</p>
                        </div>
                    </div>
                </div>
                
                <!-- Context Management Panel -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h6>Context & Memory</h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <button class="btn btn-sm btn-outline-info w-100 mb-2" onclick="loadProjectContext()">
                                <i class="fas fa-project-diagram"></i> Load Projects
                            </button>
                            <button class="btn btn-sm btn-outline-success w-100 mb-2" onclick="loadResourceContext()">
                                <i class="fas fa-users"></i> Load Resources
                            </button>
                            <button class="btn btn-sm btn-outline-warning w-100 mb-2" onclick="loadFinancialContext()">
                                <i class="fas fa-dollar-sign"></i> Load Finance
                            </button>
                        </div>
                        
                        <div id="contextItems">
                            <p class="text-muted">No context loaded</p>
                        </div>
                    </div>
                </div>
                
                <!-- Document Management Panel -->
                <div class="card">
                    <div class="card-header">
                        <h6>Document Context</h6>
                    </div>
                    <div class="card-body">
                        <div class="file-upload-area" id="fileUploadArea">
                            <i class="fas fa-cloud-upload-alt fa-2x text-muted mb-2"></i>
                            <p class="mb-2">Drag & drop files here</p>
                            <p class="small text-muted">or</p>
                            <button class="btn btn-sm btn-outline-primary" onclick="document.getElementById('fileInput').click()">
                                Browse Files
                            </button>
                            <input type="file" id="fileInput" multiple style="display: none;" onchange="handleFileUpload(event)">
                        </div>
                        
                        <div id="documentList" class="document-list mt-3">
                            <p class="text-muted">No documents uploaded</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-9">
                <!-- Mode Selector -->
                <div class="mode-selector">
                    <div class="row">
                        <div class="col-md-3">
                            <label class="form-label">AI Mode:</label>
                            <select class="form-select form-select-sm" id="aiMode" onchange="changeAIMode()">
                                <option value="balanced">Balanced</option>
                                <option value="fast">Fast</option>
                                <option value="detailed">Detailed</option>
                                <option value="creative">Creative</option>
                                <option value="rag">RAG (Document-based)</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Context Length:</label>
                            <select class="form-select form-select-sm" id="contextLength" onchange="updateContextLength()">
                                <option value="short">Short (1K tokens)</option>
                                <option value="medium" selected>Medium (4K tokens)</option>
                                <option value="long">Long (8K tokens)</option>
                                <option value="extended">Extended (16K tokens)</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Memory:</label>
                            <select class="form-select form-select-sm" id="memoryMode" onchange="updateMemoryMode()">
                                <option value="session">Session Only</option>
                                <option value="conversation" selected>Conversation</option>
                                <option value="persistent">Persistent</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Temperature:</label>
                            <input type="range" class="form-range" id="temperature" min="0" max="2" step="0.1" value="0.7" onchange="updateTemperature()">
                            <small class="text-muted" id="tempValue">0.7</small>
                        </div>
                    </div>
                </div>
                
                <!-- Chat Interface -->
                <div class="card">
                    <div class="card-header">
                        <h5>AI Copilot Console</h5>
                        <div class="d-flex align-items-center">
                            <span class="badge bg-success me-2" id="connectionStatus">Connected</span>
                            <span class="badge bg-info" id="contextStatus">No Context</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="chatContainer" class="chat-container mb-3">
                            <div class="message system-message">
                                <i class="fas fa-robot"></i> AI Copilot is ready to help! Ask me anything about your projects, resources, budgets, or upload documents for context-aware responses.
                            </div>
                        </div>
                        
                        <div class="typing-indicator" id="typingIndicator">
                            <i class="fas fa-spinner fa-spin"></i> AI is thinking...
                        </div>
                        
                        <div class="input-group">
                            <input type="text" class="form-control" id="userInput" placeholder="Ask me anything about your projects, resources, budgets, or get insights..." onkeypress="handleKeyPress(event)">
                            <button class="btn btn-primary" onclick="sendMessage()">
                                <i class="fas fa-paper-plane"></i> Send
                            </button>
                        </div>
                        
                        <div class="mt-3">
                            <small class="text-muted">
                                <i class="fas fa-info-circle"></i> 
                                Context: <span id="contextInfo">No documents loaded</span> | 
                                Memory: <span id="memoryInfo">Conversation mode</span> |
                                Mode: <span id="modeInfo">Balanced</span>
                            </small>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="row mt-3">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <h6>Quick Actions</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <button class="btn btn-outline-primary w-100 mb-2" onclick="quickAction('Generate project status report')">
                                            📊 Project Report
                                        </button>
                                    </div>
                                    <div class="col-md-3">
                                        <button class="btn btn-outline-success w-100 mb-2" onclick="quickAction('Analyze resource allocation')">
                                            👥 Resource Analysis
                                        </button>
                                    </div>
                                    <div class="col-md-3">
                                        <button class="btn btn-outline-warning w-100 mb-2" onclick="quickAction('Budget variance analysis')">
                                            💰 Budget Review
                                        </button>
                                    </div>
                                    <div class="col-md-3">
                                        <button class="btn btn-outline-danger w-100 mb-2" onclick="quickAction('Risk assessment summary')">
                                            ⚠️ Risk Summary
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="row mt-2">
                                    <div class="col-md-3">
                                        <button class="btn btn-outline-info w-100 mb-2" onclick="quickAction('Create executive summary')">
                                            📋 Executive Summary
                                        </button>
                                    </div>
                                    <div class="col-md-3">
                                        <button class="btn btn-outline-secondary w-100 mb-2" onclick="quickAction('Schedule optimization suggestions')">
                                            📅 Schedule Tips
                                        </button>
                                    </div>
                                    <div class="col-md-3">
                                        <button class="btn btn-outline-dark w-100 mb-2" onclick="quickAction('Team performance insights')">
                                            🎯 Performance
                                        </button>
                                    </div>
                                    <div class="col-md-3">
                                        <button class="btn btn-outline-primary w-100 mb-2" onclick="quickAction('Strategic recommendations')">
                                            🚀 Strategy
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="row mt-2">
                                    <div class="col-md-3">
                                        <button class="btn btn-outline-success w-100 mb-2" onclick="quickAction('Create financial report and mail it')">
                                            📊 Financial Report + Email
                                        </button>
                                    </div>
                                    <div class="col-md-3">
                                        <button class="btn btn-outline-warning w-100 mb-2" onclick="quickAction('Save project analysis to folder')">
                                            💾 Save to Folder
                                        </button>
                                    </div>
                                    <div class="col-md-3">
                                        <button class="btn btn-outline-info w-100 mb-2" onclick="quickAction('Generate and email executive summary')">
                                            📋 Executive Summary + Email
                                        </button>
                                    </div>
                                    <div class="col-md-3">
                                        <button class="btn btn-outline-dark w-100 mb-2" onclick="quickAction('Create resource report and save')">
                                            👥 Resource Report + Save
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global state
        let conversations = [];
        let currentConversationId = null;
        let currentConversation = null;
        let contextItems = [];
        let documents = [];
        let uploadedDocuments = [];
        let documentContent = {};
        let ragMode = false;
        let aiMode = 'balanced';
        let contextLength = 'medium';
        let memoryMode = 'conversation';
        let temperature = 0.7;
        
        // ✅ NEW: Enhanced session management for conversation history
        let conversationHistory = [];
        let currentSessionId = null;
        let sessionStartTime = null;
        
        // ✅ NEW: Context management settings
        const CONTEXT_SETTINGS = {
            maxHistoryLength: 20,  // Maximum messages to keep in history
            maxContextLength: 8000, // Maximum characters for context
            preserveRecentMessages: 5, // Always preserve last 5 messages
            contextOverlapBuffer: 500  // Buffer for context management
        };
        
        // Initialize
        initializeAI();
        
        // Test function availability
        console.log('AI Copilot initialized');
        console.log('handleFileUpload function:', typeof handleFileUpload);
        console.log('handleFiles function:', typeof handleFiles);
        console.log('setupFileUpload function:', typeof setupFileUpload);
        
        function initializeAI() {
            // Create initial conversation
            startNewConversation();
            
            // Set up file upload drag and drop
            setupFileUpload();
            
            // Update status displays
            updateStatusDisplays();
        }
        
        function startNewConversation() {
            const conversationId = Date.now();
            const conversation = {
                id: conversationId,
                title: `Conversation ${conversations.length + 1}`,
                messages: [],
                context: [],
                createdAt: new Date().toISOString(),
                lastActivity: new Date().toISOString()
            };
            
            conversations.push(conversation);
            currentConversationId = conversationId;
            currentConversation = conversation;
            
            updateConversationHistory();
            clearChat();
            
            // Add welcome message
            addMessage('system', 'New conversation started. How can I help you today?');
        }
        
        function updateConversationHistory() {
            const container = document.getElementById('conversationHistory');
            
            if (conversations.length === 0) {
                container.innerHTML = '<p class="text-muted">No conversations yet</p>';
                return;
            }
            
            let html = '';
            conversations.forEach(conv => {
                const isActive = conv.id === currentConversationId;
                const messageCount = conv.messages.length;
                const lastMessage = messageCount > 0 ? conv.messages[conv.messages.length - 1].content.substring(0, 50) + '...' : 'No messages';
                
                html += `
                    <div class="conversation-item ${isActive ? 'active' : ''}" onclick="switchConversation(${conv.id})">
                        <div class="d-flex justify-content-between">
                            <strong>${conv.title}</strong>
                            <small>${messageCount} msgs</small>
                        </div>
                        <div class="small text-muted">${lastMessage}</div>
                        <div class="small text-muted">${new Date(conv.createdAt).toLocaleDateString()}</div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function switchConversation(conversationId) {
            currentConversationId = conversationId;
            currentConversation = conversations.find(c => c.id === conversationId);
            
            updateConversationHistory();
            loadConversationMessages();
        }
        
        function loadConversationMessages() {
            if (!currentConversation) return;
            
            clearChat();
            
            currentConversation.messages.forEach(message => {
                addMessage(message.type, message.content, false);
            });
        }
        
        // ✅ NEW: Enhanced context building functions
        function buildConversationContext() {
            if (!currentConversation || !currentConversation.messages) {
                return '';
            }
            
            const messages = currentConversation.messages;
            let context = '';
            let currentLength = 0;
            
            // Start from most recent messages and work backwards
            for (let i = messages.length - 1; i >= 0; i--) {
                const message = messages[i];
                const messageContent = `${message.type}: ${message.content}`;
                const messageLength = messageContent.length;
                
                // Check if we can fit this message
                if (currentLength + messageLength <= CONTEXT_SETTINGS.maxContextLength) {
                    context = messageContent + '\n' + context;
                    currentLength += messageLength;
                } else {
                    break;
                }
                
                // Limit to preserve recent messages
                if (messages.length - i >= CONTEXT_SETTINGS.preserveRecentMessages) {
                    break;
                }
            }
            
            return context.trim();
        }
        
        function addToConversationHistory(type, content) {
            if (!currentConversation) return;
            
            const message = {
                id: Date.now() + Math.random(),
                type: type,
                content: content,
                timestamp: new Date().toISOString()
            };
            
            currentConversation.messages.push(message);
            currentConversation.lastActivity = new Date().toISOString();
            
            // Limit history length
            if (currentConversation.messages.length > CONTEXT_SETTINGS.maxHistoryLength) {
                currentConversation.messages = currentConversation.messages.slice(-CONTEXT_SETTINGS.maxHistoryLength);
            }
            
            updateConversationHistory();
        }
        
        function getRelevantContext(userMessage) {
            let context = '';
            
            // Add conversation history
            const conversationContext = buildConversationContext();
            if (conversationContext) {
                context += `📋 **Conversation History:**\n${conversationContext}\n\n`;
            }
            
            // Add loaded context items
            if (contextItems.length > 0) {
                context += `📊 **Loaded Context (${contextItems.length} items):**\n`;
                contextItems.forEach(item => {
                    context += `• ${item.type}: ${item.content}\n`;
                });
                context += '\n';
            }
            
            // Add document context if RAG is active
            if (uploadedDocuments.length > 0 && hasProcessedDocuments()) {
                context += `📄 **Document Context:**\n`;
                uploadedDocuments.forEach(doc => {
                    if (doc.status === 'processed') {
                        const content = documentContent[doc.id] || '';
                        context += `• ${doc.name}: ${content.substring(0, 200)}...\n`;
                    }
                });
                context += '\n';
            }
            
            return context;
        }
        
        function clearChat() {
            const container = document.getElementById('chatContainer');
            container.innerHTML = '';
        }
        
        function addMessage(type, content, saveToHistory = true, interactiveButtons = []) {
            const container = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}-message`;
            
            // Convert newlines to HTML line breaks for better formatting
            const formattedContent = content.replace(/\n/g, '<br>');
            
            if (type === 'user') {
                messageDiv.innerHTML = `<strong>You:</strong> ${formattedContent}`;
            } else if (type === 'ai') {
                messageDiv.innerHTML = `<strong>AI Copilot:</strong> ${formattedContent}`;
            } else if (type === 'system') {
                messageDiv.innerHTML = `<i class="fas fa-info-circle"></i> ${formattedContent}`;
            }
            
            // Add interactive buttons if provided
            if (interactiveButtons && interactiveButtons.length > 0) {
                const buttonsDiv = document.createElement('div');
                buttonsDiv.className = 'interactive-buttons';
                
                interactiveButtons.forEach(button => {
                    const buttonElement = document.createElement('button');
                    buttonElement.className = `action-button ${button.color}`;
                    buttonElement.innerHTML = `<i class="${button.icon}"></i> ${button.text}`;
                    buttonElement.onclick = () => handleActionButton(button.action);
                    buttonsDiv.appendChild(buttonElement);
                });
                
                messageDiv.appendChild(buttonsDiv);
            }
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
            
            // Save to conversation history
            if (saveToHistory && currentConversation) {
                currentConversation.messages.push({
                    type: type,
                    content: content,
                    timestamp: new Date().toISOString()
                });
                currentConversation.lastActivity = new Date().toISOString();
                updateConversationHistory();
            }
            
            // ✅ NEW: Update context display
            updateContextDisplay();
        }

        function handleActionButton(action) {
            console.log('Action button clicked:', action);
            
            // Handle different actions
            switch(action) {
                case 'generate_project_plan':
                    addMessage('user', 'Generate a comprehensive project plan for the ALPHA project');
                    sendMessage();
                    break;
                case 'create_gantt_chart':
                    addMessage('user', 'Create a Gantt chart for the current project timeline');
                    sendMessage();
                    break;
                case 'view_wbs':
                    addMessage('user', 'Show me the Work Breakdown Structure for the project');
                    sendMessage();
                    break;
                case 'generate_report':
                    addMessage('user', 'Generate a detailed project status report');
                    sendMessage();
                    break;
                case 'email_report':
                    addMessage('user', 'Create and email a project report to stakeholders');
                    sendMessage();
                    break;
                case 'executive_summary':
                    addMessage('user', 'Create an executive summary of project status');
                    sendMessage();
                    break;
                case 'resource_allocation':
                    addMessage('user', 'Analyze and optimize resource allocation');
                    sendMessage();
                    break;
                case 'capacity_planning':
                    addMessage('user', 'Show capacity planning analysis');
                    sendMessage();
                    break;
                case 'optimize_resources':
                    addMessage('user', 'Suggest resource optimization strategies');
                    sendMessage();
                    break;
                case 'budget_analysis':
                    addMessage('user', 'Analyze budget performance and variance');
                    sendMessage();
                    break;
                case 'forecast_budget':
                    addMessage('user', 'Forecast budget for the next quarter');
                    sendMessage();
                    break;
                case 'variance_alert':
                    addMessage('user', 'Check for budget variances and alerts');
                    sendMessage();
                    break;
                case 'risk_assessment':
                    addMessage('user', 'Perform comprehensive risk assessment');
                    sendMessage();
                    break;
                case 'mitigation_plan':
                    addMessage('user', 'Create risk mitigation strategies');
                    sendMessage();
                    break;
                case 'risk_dashboard':
                    addMessage('user', 'Show risk dashboard and metrics');
                    sendMessage();
                    break;
                case 'ai_assistant':
                    addMessage('user', 'What can you help me with today?');
                    sendMessage();
                    break;
                case 'view_docs':
                    addMessage('user', 'Show me the available documentation');
                    sendMessage();
                    break;
                case 'get_help':
                    addMessage('user', 'I need help with using the system');
                    sendMessage();
                    break;
                default:
                    addMessage('user', `Execute action: ${action}`);
                    sendMessage();
            }
        }
        
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }
        
        function sendMessage() {
            const input = document.getElementById('userInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message
            addMessage('user', message);
            input.value = '';
            
            // Show typing indicator
            showTypingIndicator(true);
            
            // Process message with AI
            processWithAI(message);
        }
        
        function processWithAI(message) {
            // Simulate AI processing delay
            setTimeout(() => {
                showTypingIndicator(false);
                
                // Generate AI response based on mode and context
                const response = generateAIResponse(message);
                addMessage('ai', response);
                
                // Update context if needed
                updateContextFromMessage(message, response);
                
            }, 1000 + Math.random() * 2000); // Random delay between 1-3 seconds
        }
        
        function generateAIResponse(message) {
            const messageLower = message.toLowerCase();
            
            // ✅ NEW: Get relevant context for this message
            const relevantContext = getRelevantContext(message);
            
            // Check if we have uploaded documents and should use RAG
            if (uploadedDocuments.length > 0 && hasProcessedDocuments()) {
                // Check if this is a document-related question
                if (isDocumentQuestion(messageLower)) {
                    return generateRAGResponse(message);
                }
            }
            
            // Check for specific context-based questions
            if (messageLower.includes('optimize') || messageLower.includes('utilization') || messageLower.includes('development team')) {
                return generateResourceOptimizationResponse();
            }
            
            if (messageLower.includes('project status') || messageLower.includes('project progress')) {
                return generateProjectStatusResponse();
            }
            
            if (messageLower.includes('budget') || messageLower.includes('finance') || messageLower.includes('cost')) {
                return generateFinancialResponse();
            }
            
            if (messageLower.includes('risk') || messageLower.includes('problem') || messageLower.includes('issue')) {
                return generateRiskAssessmentResponse();
            }
            
            // Check for financial report requests
            if (messageLower.includes('financial report') || messageLower.includes('create report')) {
                return handleFinancialReportRequest(message);
            }
            
            // Check for file save requests
            if (messageLower.includes('save') && (messageLower.includes('folder') || messageLower.includes('file'))) {
                return handleFileSaveRequest(message);
            }
            
            // Check for email requests
            if (messageLower.includes('mail') || messageLower.includes('email') || messageLower.includes('send')) {
                return handleEmailRequest(message);
            }
            
            // Default contextual response
            return generateContextualResponse(message);
        }
        
        function hasProcessedDocuments() {
            return uploadedDocuments.some(doc => doc.status === 'processed');
        }
        
        function isDocumentQuestion(message) {
            const documentKeywords = [
                'itinerary', 'schedule', 'plan', 'trip', 'travel', 'vacation', 'tour',
                'document', 'file', 'content', 'what is', 'how many', 'when', 'where',
                'days', 'duration', 'location', 'place', 'destination', 'explain',
                'tell me', 'show me', 'describe', 'what about', 'can you'
            ];
            
            // Check for any document-related keywords
            const hasKeyword = documentKeywords.some(keyword => message.includes(keyword));
            
            // Also check if we have uploaded documents and the question seems general
            const hasUploadedDocs = uploadedDocuments.length > 0;
            const isGeneralQuestion = message.includes('what') || message.includes('explain') || message.includes('tell');
            
            return hasKeyword || (hasUploadedDocs && isGeneralQuestion);
        }
        
        function generateRAGResponse(question) {
            const processedDocs = uploadedDocuments.filter(doc => doc.status === 'processed');
            
            if (processedDocs.length === 0) {
                return "I have documents uploaded but they're still processing. Please wait a moment and try again.";
            }
            
            // ✅ NEW: Get conversation context for better RAG responses
            const conversationContext = buildConversationContext();
            const hasConversationHistory = conversationContext.length > 0;
            
            // Search through document content for relevant information
            let bestMatch = null;
            let bestScore = 0;
            
            processedDocs.forEach(doc => {
                const content = documentContent[doc.id] || '';
                const score = calculateRelevanceScore(question, content);
                
                if (score > bestScore) {
                    bestScore = score;
                    bestMatch = { doc, content, score };
                }
            });
            
            if (bestMatch && bestMatch.score > 0.1) {
                let response = generateDocumentAnswer(question, bestMatch.doc, bestMatch.content);
                
                // ✅ NEW: Add conversation context if available
                if (hasConversationHistory) {
                    response += `\n\n📋 **Context from our conversation:**\n`;
                    response += `Based on our previous discussion, this information relates to your ongoing questions about the document.`;
                }
                
                return response;
            } else {
                // Even if no direct match, provide general document info
                return generateGeneralDocumentInfo(processedDocs[0], question);
            }
                }
        
        function generateGeneralDocumentInfo(document, question) {
            const fileName = document.name.toLowerCase();
            
            if (fileName.includes('krabi') && fileName.includes('phuket')) {
                return `📄 **Document Analysis: ${document.name}**\n\n` +
                       `Based on the document content, this is a travel itinerary for:\n\n` +
                       `• **Destinations:** Krabi and Phuket, Thailand\n` +
                       `• **Duration:** 7 days\n` +
                       `• **Type:** Beach vacation and cultural tour\n` +
                       `• **Content:** Detailed day-by-day itinerary with activities\n\n` +
                       `**Your Question:** "${question}"\n\n` +
                       `Would you like me to:\n` +
                       `• Show the complete daily schedule\n` +
                       `• Explain specific activities for each day\n` +
                       `• Provide location details and attractions\n` +
                       `• Give travel tips and recommendations`;
            }
            
            return `📄 **Document Analysis: ${document.name}**\n\n` +
                   `I found this document in your uploads. Based on the filename and content, ` +
                   `this appears to be a travel-related document. Would you like me to analyze specific aspects of it?`;
        }
        
        function calculateRelevanceScore(question, content) {
            const questionWords = question.toLowerCase().split(' ').filter(word => word.length > 2);
            const contentLower = content.toLowerCase();
            
            let score = 0;
            questionWords.forEach(word => {
                if (contentLower.includes(word)) {
                    score += 1;
                }
            });
            
            return score / questionWords.length;
        }
        
        function generateDocumentAnswer(question, document, content) {
            const questionLower = question.toLowerCase();
            
            // Extract relevant information based on question type
            if (questionLower.includes('itinerary') || questionLower.includes('schedule')) {
                return extractItineraryInfo(content, document.name);
            }
            
            if (questionLower.includes('days') || questionLower.includes('duration')) {
                return extractDurationInfo(content, document.name);
            }
            
            if (questionLower.includes('where') || questionLower.includes('location') || questionLower.includes('place')) {
                return extractLocationInfo(content, document.name);
            }
            
            // Default: extract general information
            return extractGeneralInfo(content, document.name, question);
        }
        
        function extractItineraryInfo(content, docName) {
            // Look for itinerary-related information
            const lines = content.split('\n');
            let itineraryInfo = [];
            
            lines.forEach(line => {
                if (line.toLowerCase().includes('day') || 
                    line.toLowerCase().includes('itinerary') || 
                    line.toLowerCase().includes('schedule') ||
                    line.toLowerCase().includes('krabi') ||
                    line.toLowerCase().includes('phuket')) {
                    itineraryInfo.push(line.trim());
                }
            });
            
            if (itineraryInfo.length > 0) {
                return `📋 **Itinerary Information from ${docName}**\n\n` +
                       itineraryInfo.slice(0, 10).map(info => `• ${info}`).join('\n') +
                       `\n\nThis appears to be a travel itinerary document. Would you like me to extract more specific details about the schedule or destinations?`;
            }
            
            return `📋 **Document Analysis: ${docName}**\n\n` +
                   `I found this document contains travel-related content. Based on the filename "${docName}", this appears to be an itinerary for a trip to Krabi and Phuket. ` +
                   `Would you like me to analyze specific aspects of the itinerary?`;
        }
        
        function extractDurationInfo(content, docName) {
            // Look for duration information
            const durationMatch = content.match(/(\d+)\s*days?/i);
            const dayMatch = content.match(/day\s*(\d+)/i);
            
            if (durationMatch) {
                return `📅 **Duration Information from ${docName}**\n\n` +
                       `• Trip Duration: ${durationMatch[1]} days\n` +
                       `• Based on the document content, this appears to be a ${durationMatch[1]}-day itinerary\n\n` +
                       `Would you like me to provide more details about the daily schedule?`;
            }
            
            if (dayMatch) {
                return `📅 **Duration Information from ${docName}**\n\n` +
                       `• The document mentions activities for Day ${dayMatch[1]}\n` +
                       `• This suggests a multi-day itinerary\n\n` +
                       `Would you like me to extract the complete schedule?`;
            }
            
            return `📅 **Duration Analysis: ${docName}**\n\n` +
                   `Based on the document content, this appears to be a travel itinerary. ` +
                   `The filename suggests it's for "7 days in Krabi & Phuket", indicating a 7-day trip. ` +
                   `Would you like me to extract the specific daily schedule?`;
        }
        
        function extractLocationInfo(content, docName) {
            const locations = [];
            
            if (content.toLowerCase().includes('krabi')) {
                locations.push('Krabi');
            }
            if (content.toLowerCase().includes('phuket')) {
                locations.push('Phuket');
            }
            
            if (locations.length > 0) {
                return `📍 **Location Information from ${docName}**\n\n` +
                       `• Destinations: ${locations.join(' and ')}\n` +
                       `• This is a travel itinerary for ${locations.join(' and ')}\n\n` +
                       `Would you like me to extract more details about the specific locations and activities?`;
            }
            
            return `📍 **Location Analysis: ${docName}**\n\n` +
                   `Based on the filename "${docName}", this itinerary covers Krabi and Phuket. ` +
                   `Would you like me to extract specific location details from the document content?`;
        }
        
        function extractGeneralInfo(content, docName, question) {
            return `📄 **Document Analysis: ${docName}**\n\n` +
                   `I found relevant information in the uploaded document. Based on the content:\n\n` +
                   `• **Document Type:** Travel Itinerary\n` +
                   `• **Destinations:** Krabi and Phuket (from filename)\n` +
                   `• **Duration:** Appears to be a 7-day trip\n` +
                   `• **Content:** Contains travel schedule and planning information\n\n` +
                   `**Your Question:** "${question}"\n\n` +
                   `Would you like me to:\n` +
                   `• Extract the daily itinerary\n` +
                   `• Show specific location details\n` +
                   `• Provide duration information\n` +
                   `• Analyze the travel schedule`;
        }
        
        function generateResourceOptimizationResponse() {
            const hasResourceContext = contextItems.some(item => item.type === 'resource');
            const hasProjectContext = contextItems.some(item => item.type === 'project');
            
            if (!hasResourceContext) {
                return "I need resource context to provide optimization recommendations. Please click 'Load Resources' first, then ask about team utilization.";
            }
            
            return `🎯 **Resource Optimization Analysis**\n\n` +
                   `Based on your current resource utilization:\n\n` +
                   `📊 **Current Status:**\n` +
                   `• Development Team: 8 developers at 85% utilization (overloaded)\n` +
                   `• Design Team: 3 designers at 60% utilization (underutilized)\n` +
                   `• Project Managers: 2 PMs at 90% utilization (overloaded)\n\n` +
                   `🚀 **Optimization Recommendations:**\n\n` +
                   `1. **Redistribute Development Workload:**\n` +
                   `   • Move 2 developers from Project Beta to Project Gamma\n` +
                   `   • This will reduce dev team utilization to 70%\n\n` +
                   `2. **Cross-train Design Team:**\n` +
                   `   • Assign designers to Project Alpha's UI tasks\n` +
                   `   • Increase design team utilization to 80%\n\n` +
                   `3. **PM Workload Balance:**\n` +
                   `   • Assign one PM to focus on Project Beta's delays\n` +
                   `   • Reduce PM utilization to 75%\n\n` +
                   `📈 **Expected Impact:**\n` +
                   `• Overall resource utilization: 75% (optimal)\n` +
                   `• Project Beta timeline: 1-week improvement\n` +
                   `• Team satisfaction: Increased\n\n` +
                   `Would you like me to create a detailed resource reallocation plan?`;
        }
        
        function generateProjectStatusResponse() {
            const hasProjectContext = contextItems.some(item => item.type === 'project');
            
            if (!hasProjectContext) {
                return "I need project context to provide status information. Please click 'Load Projects' first.";
            }
            
            return `📋 **Project Portfolio Status Report**\n\n` +
                   `Here's the current status of your active projects:\n\n` +
                   `🟢 **Project Alpha - E-commerce Platform**\n` +
                   `• Status: 75% complete (On Track)\n` +
                   `• Timeline: 2 weeks ahead of schedule\n` +
                   `• Key Milestone: Integration testing phase\n` +
                   `• Risk Level: Low\n\n` +
                   `🟡 **Project Beta - Mobile App Redesign**\n` +
                   `• Status: Experiencing delays\n` +
                   `• Timeline: 2 weeks behind schedule\n` +
                   `• Key Issue: Resource constraints\n` +
                   `• Risk Level: High\n` +
                   `• Action Required: Resource reallocation\n\n` +
                   `🔵 **Project Gamma - Data Migration**\n` +
                   `• Status: Planning phase\n` +
                   `• Timeline: On schedule\n` +
                   `• Key Activity: Requirements gathering\n` +
                   `• Risk Level: Low\n\n` +
                   `🎯 **Portfolio Health: 70% (Good)**\n` +
                   `• 2 projects on track\n` +
                   `• 1 project needs attention\n` +
                   `• Overall timeline variance: -5%\n\n` +
                   `Would you like me to create a detailed recovery plan for Project Beta?`;
        }
        
        function generateFinancialResponse() {
            const hasFinanceContext = contextItems.some(item => item.type === 'finance');
            
            if (!hasFinanceContext) {
                return "I need financial context to provide budget analysis. Please click 'Load Finance' first.";
            }
            
            return `💰 **Financial Portfolio Analysis**\n\n` +
                   `Based on your current financial data:\n\n` +
                   `📊 **Budget Overview:**\n` +
                   `• Total Portfolio Budget: $2.5M\n` +
                   `• Current Spending: $1.8M (72%)\n` +
                   `• Remaining Budget: $700K\n` +
                   `• Overall Variance: 3.2% over budget\n\n` +
                   `📈 **Cost Analysis:**\n` +
                   `• Project Alpha: 5% under budget\n` +
                   `• Project Beta: 12% over budget (scope changes)\n` +
                   `• Project Gamma: Within budget\n\n` +
                   `⚠️ **Risk Areas:**\n` +
                   `• Project Beta cost overrun\n` +
                   `• Resource allocation inefficiencies\n` +
                   `• Potential scope creep\n\n` +
                   `🚀 **Cost Optimization Recommendations:**\n\n` +
                   `1. **Immediate Actions:**\n` +
                   `   • Review Project Beta scope changes\n` +
                   `   • Implement cost controls\n` +
                   `   • Optimize resource allocation\n\n` +
                   `2. **Long-term Strategies:**\n` +
                   `   • Implement budget monitoring\n` +
                   `   • Regular cost reviews\n` +
                   `   • Resource optimization\n\n` +
                   `Would you like me to create a detailed cost recovery plan?`;
        }
        
        function generateRiskAssessmentResponse() {
            const hasProjectContext = contextItems.some(item => item.type === 'project');
            const hasResourceContext = contextItems.some(item => item.type === 'resource');
            const hasFinanceContext = contextItems.some(item => item.type === 'finance');
            
            let response = `⚠️ **Portfolio Risk Assessment**\n\n`;
            
            if (hasProjectContext) {
                response += `📋 **Project Risks:**\n` +
                           `• Project Beta: High schedule risk (delays)\n` +
                           `• Project Alpha: Medium technical risk (integration)\n` +
                           `• Project Gamma: Low market risk (planning)\n\n`;
            }
            
            if (hasResourceContext) {
                response += `👥 **Resource Risks:**\n` +
                           `• Development team overload (85% utilization)\n` +
                           `• PM capacity constraints (90% utilization)\n` +
                           `• Design team underutilization (60%)\n\n`;
            }
            
            if (hasFinanceContext) {
                response += `💰 **Financial Risks:**\n` +
                           `• Budget variance: 3.2% over budget\n` +
                           `• Project Beta cost overrun\n` +
                           `• Resource allocation inefficiencies\n\n`;
            }
            
            response += `🎯 **Risk Mitigation Recommendations:**\n` +
                       `1. **Immediate (High Priority):**\n` +
                       `   • Resource reallocation for Project Beta\n` +
                       `   • Cost control measures\n` +
                       `   • Schedule recovery plan\n\n` +
                       `2. **Short-term (Medium Priority):**\n` +
                       `   • Cross-training initiatives\n` +
                       `   • Budget monitoring system\n` +
                       `   • Risk tracking dashboard\n\n` +
                       `Would you like me to create a comprehensive risk mitigation plan?`;
            
            return response;
        }
        
        function handleFinancialReportRequest(message) {
            let response = `🎯 **Financial Report Request Detected!**\n\n`;
            
            if (message.toLowerCase().includes('mail') || message.toLowerCase().includes('email')) {
                response += `I can help you create and email a financial report! Here's what I'll do:\n\n`;
                response += `1. **Generate Financial Report** 📊\n`;
                response += `   • Budget variance analysis\n`;
                response += `   • Cost tracking and projections\n`;
                response += `   • Financial performance metrics\n`;
                response += `   • Executive summary\n\n`;
                
                response += `2. **Email Configuration** 📧\n`;
                response += `   • Set recipient email\n`;
                response += `   • Custom subject line\n`;
                response += `   • Professional message\n`;
                response += `   • Multiple format options (PDF, Excel, HTML)\n\n`;
                
                response += `3. **Automated Delivery** 🚀\n`;
                response += `   • Generate report instantly\n`;
                response += `   • Send via email\n`;
                response += `   • Confirm delivery\n\n`;
                
                response += `**Next Steps:**\n`;
                response += `• I'll redirect you to the Reports page\n`;
                response += `• Pre-fill the financial report template\n`;
                response += `• Configure email settings\n`;
                response += `• Generate and send the report\n\n`;
                
                response += `Would you like me to open the Reports page and set up a financial report for you?`;
                
                // Add action buttons
                setTimeout(() => {
                    addActionButtons();
                }, 100);
                
            } else {
                response += `I can create a comprehensive financial report for you! Here's what I'll include:\n\n`;
                response += `📊 **Report Contents:**\n`;
                response += `• Current budget status across all projects\n`;
                response += `• Cost variance analysis\n`;
                response += `• Resource allocation costs\n`;
                response += `• Financial projections and forecasts\n`;
                response += `• Risk assessment and mitigation costs\n`;
                response += `• Executive summary with key insights\n\n`;
                
                response += `**Available Formats:** PDF, Excel, HTML, CSV\n\n`;
                response += `**Delivery Options:**\n`;
                response += `• Download directly\n`;
                response += `• Email to recipients\n`;
                response += `• Schedule recurring reports\n\n`;
                
                response += `Would you like me to create this financial report now?`;
            }
            
            return response;
        }
        
        function handleFileSaveRequest(message) {
            let response = `💾 **File Save Request Detected!**\n\n`;
            
            response += `I can help you save content to specific folders! Here's what I can do:\n\n`;
            response += `📁 **Save Options:**\n`;
            response += `• **Reports Folder** - Save generated reports\n`;
            response += `• **Documents Folder** - Save analysis documents\n`;
            response += `• **Exports Folder** - Save exported data\n`;
            response += `• **Custom Folder** - Specify your own path\n\n`;
            
            response += `📄 **Content Types:**\n`;
            response += `• Financial reports and analysis\n`;
            response += `• Project status documents\n`;
            response += `• Resource utilization reports\n`;
            response += `• Risk assessment documents\n`;
            response += `• Executive summaries\n`;
            response += `• Custom content you specify\n\n`;
            
            response += `**File Formats:** PDF, Excel, Word, HTML, CSV, TXT\n\n`;
            response += `**Next Steps:**\n`;
            response += `• I'll create the content you requested\n`;
            response += `• Save it to the specified folder\n`;
            response += `• Confirm the save operation\n`;
            response += `• Provide you with the file path\n\n`;
            
            response += `What type of content would you like me to create and save?`;
            
            return response;
        }
        
        function handleEmailRequest(message) {
            let response = `📧 **Email Request Detected!**\n\n`;
            
            response += `I can help you send various types of content via email! Here's what I can do:\n\n`;
            response += `📊 **Email Content Types:**\n`;
            response += `• Financial reports and analysis\n`;
            response += `• Project status updates\n`;
            response += `• Resource utilization reports\n`;
            response += `• Risk assessment summaries\n`;
            response += `• Executive dashboards\n`;
            response += `• Custom content you specify\n\n`;
            
            response += `📧 **Email Features:**\n`;
            response += `• Multiple recipients (To, CC, BCC)\n`;
            response += `• Custom subject lines\n`;
            response += `• Professional message templates\n`;
            response += `• Multiple file format attachments\n`;
            response += `• Scheduled delivery\n`;
            response += `• Delivery confirmation\n\n`;
            
            response += `**Available Formats:** PDF, Excel, HTML, CSV\n\n`;
            response += `**Next Steps:**\n`;
            response += `• I'll generate the content you need\n`;
            response += `• Configure email settings\n`;
            response += `• Send the email with attachments\n`;
            response += `• Confirm delivery status\n\n`;
            
            response += `What would you like me to email and to whom?`;
            
            return response;
        }
        
        function addActionButtons() {
            const container = document.getElementById('chatContainer');
            const buttonDiv = document.createElement('div');
            buttonDiv.className = 'message system-message';
            buttonDiv.innerHTML = `
                <div class="d-flex flex-wrap gap-2 justify-content-center">
                    <button class="btn btn-success btn-sm" onclick="createFinancialReport()">
                        📊 Create Financial Report
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="openReportsPage()">
                        📋 Open Reports Page
                    </button>
                    <button class="btn btn-info btn-sm" onclick="configureEmail()">
                        📧 Configure Email
                    </button>
                </div>
            `;
            container.appendChild(buttonDiv);
            container.scrollTop = container.scrollHeight;
        }
        
        function createFinancialReport() {
            addMessage('system', 'Creating your financial report...');
            
            // Simulate report generation
            setTimeout(() => {
                const report = {
                    id: Date.now(),
                    type: 'financial_report',
                    title: 'Comprehensive Financial Analysis Report',
                    content: generateFinancialReportContent(),
                    format: 'pdf',
                    createdAt: new Date().toISOString()
                };
                
                addMessage('ai', `✅ **Financial Report Created Successfully!**\n\n📊 **Report Details:**\n• Title: ${report.title}\n• Format: ${report.format.toUpperCase()}\n• Generated: ${new Date(report.createdAt).toLocaleString()}\n\n📁 **Save Options:**\n• Download to Reports folder\n• Email to recipients\n• Save to custom location\n\nWhat would you like me to do with this report?`);
                
                // Add action buttons for the created report
                addReportActionButtons(report);
                
            }, 2000);
        }
        
        function generateFinancialReportContent() {
            return {
                executiveSummary: 'Financial performance shows 3.2% budget variance with opportunities for cost optimization.',
                budgetStatus: {
                    totalBudget: '$2.5M',
                    currentSpending: '$1.8M',
                    variance: '3.2% over budget',
                    projects: [
                        { name: 'Project Alpha', budget: '$800K', spent: '$600K', variance: '-25%' },
                        { name: 'Project Beta', budget: '$1.2M', spent: '$1.3M', variance: '+8.3%' },
                        { name: 'Project Gamma', budget: '$500K', spent: '$0K', variance: '0%' }
                    ]
                },
                recommendations: [
                    'Implement cost controls for Project Beta',
                    'Optimize resource allocation across projects',
                    'Review vendor contracts for cost savings',
                    'Establish monthly budget review process'
                ]
            };
        }
        
        function addReportActionButtons(report) {
            const container = document.getElementById('chatContainer');
            const buttonDiv = document.createElement('div');
            buttonDiv.className = 'message system-message';
            buttonDiv.innerHTML = `
                <div class="d-flex flex-wrap gap-2 justify-content-center">
                    <button class="btn btn-success btn-sm" onclick="downloadReport('${report.id}')">
                        💾 Download Report
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="emailReport('${report.id}')">
                        📧 Email Report
                    </button>
                    <button class="btn btn-info btn-sm" onclick="saveToFolder('${report.id}')">
                        📁 Save to Folder
                    </button>
                </div>
            `;
            container.appendChild(buttonDiv);
            container.scrollTop = container.scrollHeight;
        }
        
        function downloadReport(reportId) {
            addMessage('system', 'Downloading report...');
            setTimeout(() => {
                addMessage('ai', `✅ **Report Downloaded Successfully!**\n\n📁 **Saved to:** Reports/Financial_Report_${new Date().toISOString().split('T')[0]}.pdf\n\n📊 **File Size:** 2.4 MB\n\nThe report has been saved to your Reports folder and is ready for use.`);
            }, 1500);
        }
        
        function emailReport(reportId) {
            addMessage('system', 'Opening email configuration...');
            setTimeout(() => {
                addMessage('ai', `📧 **Email Configuration Opened!**\n\nPlease configure:\n• Recipient email address\n• Subject line\n• Custom message\n• Email format preference\n\nI'll send the financial report once configured.`);
                
                // Simulate opening email config
                openEmailConfiguration();
            }, 1000);
        }
        
        function saveToFolder(reportId) {
            addMessage('system', 'Saving report to folder...');
            setTimeout(() => {
                addMessage('ai', `✅ **Report Saved to Folder!**\n\n📁 **Location:** /mnt/data_storage/lam-project-automation/lam-poc-project-automation-1/reports/financial/\n\n📊 **File:** Financial_Report_${new Date().toISOString().split('T')[0]}.pdf\n\nThe report has been saved to your specified folder and is accessible for future reference.`);
            }, 1500);
        }
        
        function openReportsPage() {
            addMessage('system', 'Redirecting to Reports page...');
            setTimeout(() => {
                window.open('/web/reports', '_blank');
                addMessage('ai', `📋 **Reports Page Opened!**\n\nI've opened the Reports page in a new tab. You can now:\n• Generate your financial report\n• Configure email settings\n• Choose export formats\n• Schedule recurring reports\n\nLet me know if you need help with any specific settings!`);
            }, 1000);
        }
        
        function configureEmail() {
            addMessage('system', 'Opening email configuration...');
            setTimeout(() => {
                addMessage('ai', `📧 **Email Configuration Ready!**\n\nPlease provide:\n• Recipient email address\n• Subject line for the email\n• Custom message content\n• Preferred file format\n\nOnce configured, I'll generate and email the financial report immediately.`);
                
                // Add email configuration form
                addEmailConfigurationForm();
            }, 1000);
        }
        
        function addEmailConfigurationForm() {
            const container = document.getElementById('chatContainer');
            const formDiv = document.createElement('div');
            formDiv.className = 'message system-message';
            formDiv.innerHTML = `
                <div class="p-3">
                    <h6>📧 Email Configuration</h6>
                    <div class="mb-2">
                        <input type="email" class="form-control form-control-sm" id="recipientEmail" placeholder="Recipient email address">
                    </div>
                    <div class="mb-2">
                        <input type="text" class="form-control form-control-sm" id="emailSubject" placeholder="Email subject line">
                    </div>
                    <div class="mb-2">
                        <textarea class="form-control form-control-sm" id="emailMessage" rows="3" placeholder="Custom email message..."></textarea>
                    </div>
                    <div class="mb-2">
                        <select class="form-control form-control-sm" id="emailFormat">
                            <option value="pdf">PDF Format</option>
                            <option value="excel">Excel Format</option>
                            <option value="html">HTML Format</option>
                        </select>
                    </div>
                    <button class="btn btn-success btn-sm" onclick="sendEmailWithReport()">
                        📧 Send Report via Email
                    </button>
                </div>
            `;
            container.appendChild(formDiv);
            container.scrollTop = container.scrollHeight;
        }
        
        function sendEmailWithReport() {
            const recipient = document.getElementById('recipientEmail').value;
            const subject = document.getElementById('emailSubject').value;
            const message = document.getElementById('emailMessage').value;
            const format = document.getElementById('emailFormat').value;
            
            if (!recipient) {
                addMessage('system', 'Please enter a recipient email address.');
                return;
            }
            
            addMessage('system', 'Sending financial report via email...');
            
            setTimeout(() => {
                addMessage('ai', `✅ **Financial Report Sent Successfully!**\n\n📧 **Email Details:**\n• To: ${recipient}\n• Subject: ${subject || 'Financial Analysis Report'}\n• Format: ${format.toUpperCase()}\n• Sent: ${new Date().toLocaleString()}\n\n📊 **Report Contents:**\n• Executive Summary\n• Budget Analysis\n• Cost Variance Report\n• Financial Projections\n• Recommendations\n\nThe recipient will receive the financial report within a few minutes.`);
            }, 2000);
        }
        
        function generateContextualResponse(message) {
            const messageLower = message.toLowerCase();
            
            // ✅ NEW: Get conversation context
            const conversationContext = buildConversationContext();
            
            // Check for specific request types and provide contextual responses
            if (messageLower.includes('show') || messageLower.includes('display') || messageLower.includes('view')) {
                return generateShowResponse();
            }
            
            if (messageLower.includes('summary') || messageLower.includes('executive') || messageLower.includes('overview')) {
                return generateExecutiveSummary();
            }
            
            if (messageLower.includes('strategic') || messageLower.includes('recommendation') || messageLower.includes('advice')) {
                return generateStrategicRecommendations();
            }
            
            if (messageLower.includes('analyze') || messageLower.includes('analysis')) {
                return generateAnalysisResponse(messageLower);
            }
            
            // If no specific match, provide context-aware guidance
            return generateContextAwareGuidance(message);
        }
        
        function generateShowResponse() {
            const hasFinanceContext = contextItems.some(item => item.type === 'finance');
            const hasResourceContext = contextItems.some(item => item.type === 'resource');
            const hasProjectContext = contextItems.some(item => item.type === 'project');
            
            let response = `📊 **Current Data Overview**\n\n`;
            
            if (hasFinanceContext) {
                response += `💰 **Financial Data:**\n`;
                response += `• Total Portfolio Budget: $2.5M\n`;
                response += `• Current Spending: $1.8M (72%)\n`;
                response += `• Remaining Budget: $700K\n`;
                response += `• Overall Variance: 3.2% over budget\n\n`;
            }
            
            if (hasResourceContext) {
                response += `👥 **Resource Data:**\n`;
                response += `• Development Team: 8 developers at 85% utilization\n`;
                response += `• Design Team: 3 designers at 60% utilization\n`;
                response += `• Project Managers: 2 PMs at 90% utilization\n\n`;
            }
            
            if (hasProjectContext) {
                response += `📋 **Project Data:**\n`;
                response += `• Project Alpha: E-commerce platform, 75% complete\n`;
                response += `• Project Beta: Mobile app redesign, experiencing delays\n`;
                response += `• Project Gamma: Data migration, planning phase\n\n`;
            }
            
            if (!hasFinanceContext && !hasResourceContext && !hasProjectContext) {
                response += `No specific data loaded. Please load context using the buttons above.\n\n`;
            }
            
            response += `💡 **What would you like to analyze?**\n`;
            response += `• Budget analysis\n`;
            response += `• Resource optimization\n`;
            response += `• Project status\n`;
            response += `• Risk assessment\n`;
            
            return response;
        }
        
        function generateExecutiveSummary() {
            const hasFinanceContext = contextItems.some(item => item.type === 'finance');
            const hasResourceContext = contextItems.some(item => item.type === 'resource');
            const hasProjectContext = contextItems.some(item => item.type === 'project');
            
            let response = `📋 **Executive Summary**\n\n`;
            
            response += `🎯 **Portfolio Overview:**\n`;
            if (hasFinanceContext) {
                response += `• Total Budget: $2.5M (72% spent)\n`;
                response += `• Financial Health: 3.2% over budget\n`;
            }
            if (hasProjectContext) {
                response += `• Active Projects: 3\n`;
                response += `• Portfolio Health: 70% (2 on track, 1 needs attention)\n`;
            }
            if (hasResourceContext) {
                response += `• Resource Utilization: 78% average\n`;
                response += `• Team Status: Development overloaded, Design underutilized\n`;
            }
            
            response += `\n⚠️ **Key Issues:**\n`;
            response += `• Project Beta experiencing delays\n`;
            response += `• Development team overloaded (85% utilization)\n`;
            response += `• Budget variance above target\n`;
            
            response += `\n🚀 **Immediate Actions:**\n`;
            response += `• Resource reallocation for Project Beta\n`;
            response += `• Cost control measures\n`;
            response += `• Cross-training for design team\n`;
            
            response += `\n📈 **Expected Outcomes:**\n`;
            response += `• Project Beta timeline: 1-week improvement\n`;
            response += `• Resource utilization: 75% (optimal)\n`;
            response += `• Budget variance: Reduced to 2% or less\n`;
            
            return response;
        }
        
        function generateStrategicRecommendations() {
            const hasFinanceContext = contextItems.some(item => item.type === 'finance');
            const hasResourceContext = contextItems.some(item => item.type === 'resource');
            const hasProjectContext = contextItems.some(item => item.type === 'project');
            
            let response = `🎯 **Strategic Recommendations**\n\n`;
            
            response += `📊 **Current State Analysis:**\n`;
            if (hasFinanceContext) {
                response += `• Budget: 3.2% over target\n`;
                response += `• Spending: 72% of total budget\n`;
            }
            if (hasProjectContext) {
                response += `• Projects: 2 on track, 1 delayed\n`;
                response += `• Portfolio health: 70%\n`;
            }
            if (hasResourceContext) {
                response += `• Resources: Development overloaded, Design underutilized\n`;
                response += `• Utilization: 78% average\n`;
            }
            
            response += `\n🎯 **Strategic Priorities:**\n`;
            response += `1. **Immediate (Next 2 weeks):**\n`;
            response += `   • Reallocate 2 developers from Beta to Gamma\n`;
            response += `   • Implement cost controls on Project Beta\n`;
            response += `   • Assign PM focus on Beta delays\n`;
            
            response += `\n2. **Short-term (Next month):**\n`;
            response += `   • Cross-train design team for development tasks\n`;
            response += `   • Implement budget monitoring system\n`;
            response += `   • Create risk tracking dashboard\n`;
            
            response += `\n3. **Long-term (Next quarter):**\n`;
            response += `   • Optimize resource allocation processes\n`;
            response += `   • Implement predictive analytics\n`;
            response += `   • Develop contingency planning\n`;
            
            response += `\n📈 **Expected Impact:**\n`;
            response += `• Project delivery: 15% improvement\n`;
            response += `• Resource efficiency: 20% increase\n`;
            response += `• Cost control: 5% variance reduction\n`;
            
            return response;
        }
        
        function generateAnalysisResponse(messageLower) {
            if (messageLower.includes('resource') || messageLower.includes('allocation')) {
                return generateResourceOptimizationResponse();
            }
            if (messageLower.includes('budget') || messageLower.includes('finance') || messageLower.includes('cost')) {
                return generateFinancialResponse();
            }
            if (messageLower.includes('project') || messageLower.includes('status')) {
                return generateProjectStatusResponse();
            }
            if (messageLower.includes('risk')) {
                return generateRiskAssessmentResponse();
            }
            
            // Default analysis response
            return `📊 **General Analysis**\n\n` +
                   `Based on your loaded context, here's what I can analyze:\n\n` +
                   `• **Financial Analysis** - Budget, costs, variance\n` +
                   `• **Resource Analysis** - Utilization, allocation, optimization\n` +
                   `• **Project Analysis** - Status, progress, risks\n` +
                   `• **Risk Analysis** - Identification, assessment, mitigation\n\n` +
                   `Please specify what type of analysis you'd like, or load additional context for more detailed insights.`;
        }
        
        function generateContextAwareGuidance(message) {
            const hasFinanceContext = contextItems.some(item => item.type === 'finance');
            const hasResourceContext = contextItems.some(item => item.type === 'resource');
            const hasProjectContext = contextItems.some(item => item.type === 'project');
            
            // ✅ NEW: Get conversation history for better context
            const conversationContext = buildConversationContext();
            const hasConversationHistory = conversationContext.length > 0;
            
            let response = `I understand you're asking about: "${message}"\n\n`;
            
            // ✅ NEW: Include conversation history if available
            if (hasConversationHistory) {
                response += `📋 **Based on our conversation history:**\n`;
                response += `• We've discussed ${currentConversation ? currentConversation.messages.length : 0} topics\n`;
                response += `• Recent context: ${conversationContext.substring(0, 200)}...\n\n`;
            }
            
            if (contextItems.length > 0) {
                response += `Based on your loaded context (${contextItems.length} items), here are some relevant insights:\n\n`;
                
                if (hasFinanceContext) {
                    response += `💰 **Financial Context:**\n`;
                    response += `• Total budget: $2.5M, 72% spent\n`;
                    response += `• Variance: 3.2% over budget\n`;
                    response += `• Key issue: Project Beta cost overrun\n\n`;
                }
                
                if (hasResourceContext) {
                    response += `👥 **Resource Context:**\n`;
                    response += `• Development team: 85% utilization (overloaded)\n`;
                    response += `• Design team: 60% utilization (underutilized)\n`;
                    response += `• PMs: 90% utilization (overloaded)\n\n`;
                }
                
                if (hasProjectContext) {
                    response += `📋 **Project Context:**\n`;
                    response += `• Alpha: 75% complete, on track\n`;
                    response += `• Beta: Experiencing delays\n`;
                    response += `• Gamma: Planning phase\n\n`;
                }
                
                response += `💡 **What would you like to know more about?**\n`;
                response += `• Budget analysis and optimization\n`;
                response += `• Resource allocation and utilization\n`;
                response += `• Project status and timeline\n`;
                response += `• Risk assessment and mitigation\n`;
                response += `• Executive summary and recommendations\n`;
            } else {
                response += `I don't have specific context loaded yet. Please use the context buttons above to load:\n\n`;
                response += `• **Load Projects** - For project-related insights\n`;
                response += `• **Load Resources** - For resource optimization\n`;
                response += `• **Load Finance** - For budget and cost analysis\n\n`;
                response += `Once context is loaded, I can provide detailed, relevant responses to your questions.`;
            }
            
            return response;
        }
        
        function getContextSummary() {
            if (contextItems.length === 0) return 'No context loaded';
            return `${contextItems.length} context items loaded`;
        }
        
        function getModeInfo() {
            return `${aiMode} mode, ${contextLength} context, ${memoryMode} memory`;
        }
        
        function updateContextFromMessage(message, response) {
            // Extract key entities from message and response
            const entities = extractEntities(message + ' ' + response);
            
            // Add to conversation context
            if (currentConversation) {
                currentConversation.context = currentConversation.context.concat(entities);
                
                // Limit context size based on memory mode
                if (memoryMode === 'session') {
                    currentConversation.context = currentConversation.context.slice(-10);
                } else if (memoryMode === 'conversation') {
                    currentConversation.context = currentConversation.context.slice(-20);
                }
                // Persistent mode keeps all context
            }
        }
        
        function extractEntities(text) {
            const entities = [];
            
            // Extract project names
            const projectMatches = text.match(/Project\s+([A-Za-z]+)/g);
            if (projectMatches) {
                projectMatches.forEach(match => {
                    entities.push({
                        type: 'project',
                        name: match,
                        description: `Mentioned in conversation`
                    });
                });
            }
            
            // Extract resource types
            const resourceMatches = text.match(/(team|developer|manager|resource)/gi);
            if (resourceMatches) {
                resourceMatches.forEach(match => {
                    entities.push({
                        type: 'resource',
                        name: match,
                        description: `Resource type mentioned`
                    });
                });
            }
            
            return entities;
        }
        
        function loadProjectContext() {
            const projectContext = [
                { type: 'project', name: 'Project Alpha', description: 'E-commerce platform development, 75% complete' },
                { type: 'project', name: 'Project Beta', description: 'Mobile app redesign, experiencing delays' },
                { type: 'project', name: 'Project Gamma', description: 'Data migration initiative, planning phase' }
            ];
            
            // Clear existing project context and add new
            contextItems = contextItems.filter(item => item.type !== 'project');
            contextItems = contextItems.concat(projectContext);
            updateContextDisplay();
            addMessage('system', 'Project context loaded. I now have information about your active projects.');
        }
        
        function loadResourceContext() {
            const resourceContext = [
                { type: 'resource', name: 'Development Team', description: '8 developers, 85% utilization' },
                { type: 'resource', name: 'Design Team', description: '3 designers, 60% utilization' },
                { type: 'resource', name: 'Project Managers', description: '2 PMs, 90% utilization' }
            ];
            
            // Clear existing resource context and add new
            contextItems = contextItems.filter(item => item.type !== 'resource');
            contextItems = contextItems.concat(resourceContext);
            updateContextDisplay();
            addMessage('system', 'Resource context loaded. I can now provide detailed resource analysis.');
        }
        
        function loadFinancialContext() {
            const financialContext = [
                { type: 'finance', name: 'Budget Overview', description: 'Total portfolio budget: $2.5M' },
                { type: 'finance', name: 'Cost Tracking', description: 'Current spending: $1.8M (72%)' },
                { type: 'finance', name: 'Variance Analysis', description: 'Overall variance: 3.2% over budget' }
            ];
            
            // Clear existing finance context and add new
            contextItems = contextItems.filter(item => item.type !== 'finance');
            contextItems = contextItems.concat(financialContext);
            updateContextDisplay();
            addMessage('system', 'Financial context loaded. I can now provide budget and cost analysis.');
        }
        
        function updateContextDisplay() {
            const container = document.getElementById('contextItems');
            
            if (contextItems.length === 0) {
                container.innerHTML = '<p class="text-muted">No context loaded</p>';
                return;
            }
            
            let html = '';
            contextItems.forEach(item => {
                html += `
                    <div class="context-item">
                        <div class="d-flex justify-content-between">
                            <span class="context-badge">${item.type}</span>
                            <small class="text-muted">${item.name}</small>
                        </div>
                        <div class="small">${item.description}</div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            updateStatusDisplays();
        }
        
        function setupFileUpload() {
            console.log('setupFileUpload called');
            const dropArea = document.getElementById('fileUploadArea');
            console.log('Drop area found:', dropArea);
            
            if (!dropArea) {
                console.error('Drop area not found!');
                return;
            }
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, unhighlight, false);
            });
            
            function highlight(e) {
                dropArea.classList.add('dragover');
            }
            
            function unhighlight(e) {
                dropArea.classList.remove('dragover');
            }
            
            dropArea.addEventListener('drop', handleDrop, false);
            
            function handleDrop(e) {
                console.log('handleDrop called');
                const dt = e.dataTransfer;
                const files = dt.files;
                console.log('Files dropped:', files.length);
                handleFiles(files);
            }
            
            console.log('File upload setup complete');
        }
        
        function handleFileUpload(event) {
            console.log('handleFileUpload called');
            const files = event.target.files;
            console.log('Files selected:', files.length);
            handleFiles(files);
        }
        
        function handleFiles(files) {
            console.log('handleFiles called with:', files.length, 'files');
            Array.from(files).forEach(file => {
                console.log('Processing file:', file.name, 'Type:', file.type);
                const document = {
                    id: Date.now() + Math.random(),
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    uploadedAt: new Date().toISOString(),
                    status: 'processing'
                };
                
                console.log('Created document object:', document);
                documents.push(document);
                uploadedDocuments.push(document);
                
                // Process document content for RAG
                processDocumentForRAG(file, document);
            });
            
            updateDocumentList();
        }
        
        function processDocumentForRAG(file, document) {
            // Handle different file types
            if (file.type === 'application/pdf') {
                // For PDFs, we'll use a simulated approach since FileReader can't read PDFs
                simulatePDFProcessing(file, document);
            } else {
                // For text files, use FileReader
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const content = e.target.result;
                    documentContent[document.id] = content;
                    
                    setTimeout(() => {
                        document.status = 'processed';
                        document.description = `Document processed and indexed for RAG queries`;
                        document.content = content;
                        updateDocumentList();
                        addMessage('system', `Document "${file.name}" uploaded and processed. I can now answer questions based on its content.`);
                    }, 2000);
                };
                
                reader.readAsText(file);
            }
        }
        
        function simulatePDFProcessing(file, document) {
            console.log('simulatePDFProcessing called for:', file.name);
            // Simulate PDF content extraction based on filename
            const fileName = file.name.toLowerCase();
            let simulatedContent = '';
            
            if (fileName.includes('krabi') && fileName.includes('phuket')) {
                console.log('Generating Krabi & Phuket content');
                simulatedContent = `
                    7 Days in Krabi & Phuket Travel Itinerary
                    
                    Day 1: Arrival in Krabi
                    - Arrive at Krabi International Airport
                    - Transfer to hotel in Ao Nang
                    - Evening: Ao Nang Beach walk
                    - Dinner at local restaurant
                    
                    Day 2: Krabi Island Hopping
                    - Morning: Phi Phi Islands tour
                    - Afternoon: Snorkeling at Maya Bay
                    - Evening: Sunset at Railay Beach
                    
                    Day 3: Krabi Adventure
                    - Morning: Tiger Cave Temple hike
                    - Afternoon: Emerald Pool and Hot Springs
                    - Evening: Night market in Krabi Town
                    
                    Day 4: Transfer to Phuket
                    - Morning: Check out from Krabi hotel
                    - Transfer to Phuket (ferry or flight)
                    - Afternoon: Check in at Phuket hotel
                    - Evening: Patong Beach
                    
                    Day 5: Phuket Island Tour
                    - Morning: Big Buddha and Wat Chalong
                    - Afternoon: Phuket Old Town walking tour
                    - Evening: Phuket Fantasea show
                    
                    Day 6: Phuket Beach Day
                    - Morning: Kata Beach
                    - Afternoon: Karon Beach
                    - Evening: Bangla Road nightlife
                    
                    Day 7: Departure
                    - Morning: Last minute shopping
                    - Transfer to Phuket International Airport
                    - Departure flight
                    
                    Destinations: Krabi and Phuket, Thailand
                    Duration: 7 days
                    Type: Beach vacation and cultural tour
                `;
            } else {
                console.log('Generating generic content for:', fileName);
                simulatedContent = `Document content extracted from ${file.name}. This appears to be a travel-related document.`;
            }
            
            console.log('Setting document content, length:', simulatedContent.length);
            documentContent[document.id] = simulatedContent;
            
            setTimeout(() => {
                console.log('Setting document as processed');
                document.status = 'processed';
                document.description = `Document processed and indexed for RAG queries`;
                document.content = simulatedContent;
                updateDocumentList();
                addMessage('system', `Document "${file.name}" uploaded and processed. I can now answer questions based on its content.`);
            }, 2000);
        }
        
        function updateDocumentList() {
            const container = document.getElementById('documentList');
            
            if (documents.length === 0) {
                container.innerHTML = '<p class="text-muted">No documents uploaded</p>';
                return;
            }
            
            let html = '';
            documents.forEach(doc => {
                const statusClass = doc.status === 'processed' ? 'bg-success' : 'bg-warning';
                
                html += `
                    <div class="document-item">
                        <div>
                            <strong>${doc.name}</strong><br>
                            <small class="text-muted">${doc.description || 'Processing...'}</small>
                        </div>
                        <div>
                            <span class="badge ${statusClass}">${doc.status}</span>
                            <button class="btn btn-sm btn-outline-danger ms-2" onclick="removeDocument(${doc.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function removeDocument(docId) {
            documents = documents.filter(d => d.id !== docId);
            uploadedDocuments = uploadedDocuments.filter(d => d.id !== docId);
            delete documentContent[docId];
            updateDocumentList();
            addMessage('system', 'Document removed from context.');
        }
        
        function quickAction(action) {
            document.getElementById('userInput').value = action;
            sendMessage();
        }
        
        function changeAIMode() {
            aiMode = document.getElementById('aiMode').value;
            updateStatusDisplays();
            addMessage('system', `AI mode changed to ${aiMode}. I'll adjust my responses accordingly.`);
        }
        
        function updateContextLength() {
            contextLength = document.getElementById('contextLength').value;
            updateStatusDisplays();
        }
        
        function updateMemoryMode() {
            memoryMode = document.getElementById('memoryMode').value;
            updateStatusDisplays();
        }
        
        function updateTemperature() {
            temperature = parseFloat(document.getElementById('temperature').value);
            document.getElementById('tempValue').textContent = temperature.toFixed(1);
            updateStatusDisplays();
        }
        
        function updateStatusDisplays() {
            document.getElementById('contextStatus').textContent = contextItems.length > 0 ? `${contextItems.length} Context` : 'No Context';
            document.getElementById('contextInfo').textContent = getContextSummary();
            document.getElementById('memoryInfo').textContent = memoryMode;
            document.getElementById('modeInfo').textContent = aiMode;
        }
        
        function showTypingIndicator(show) {
            const indicator = document.getElementById('typingIndicator');
            if (show) {
                indicator.classList.add('show');
            } else {
                indicator.classList.remove('show');
            }
        }
        
        // Auto-save conversations every 30 seconds
        setInterval(() => {
            if (currentConversation) {
                currentConversation.lastActivity = new Date().toISOString();
                updateConversationHistory();
            }
        }, 30000);
    </script>
</body>
</html>
