<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plan from Document Wizard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .wizard-step {
            display: none;
        }
        .wizard-step.active {
            display: block;
        }
        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
        }
        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #e9ecef;
            color: #6c757d;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 1rem;
            font-weight: bold;
        }
        .step-circle.active {
            background-color: #007bff;
            color: white;
        }
        .step-circle.completed {
            background-color: #28a745;
            color: white;
        }
        .upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 3rem;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.3s;
        }
        .upload-area:hover {
            border-color: #007bff;
        }
        .upload-area.dragover {
            border-color: #007bff;
            background-color: #f8f9fa;
        }
        .file-preview {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 1rem;
            background-color: #f8f9fa;
        }
        .wbs-tree {
            max-height: 500px;
            overflow-y: auto;
        }
        .wbs-item {
            padding: 0.5rem;
            margin: 0.25rem 0;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            background-color: white;
        }
        .wbs-item.epic {
            background-color: #e3f2fd;
            border-left: 4px solid #2196f3;
        }
        .wbs-item.feature {
            background-color: #f3e5f5;
            border-left: 4px solid #9c27b0;
            margin-left: 1rem;
        }
        .wbs-item.task {
            background-color: #fff3e0;
            border-left: 4px solid #ff9800;
            margin-left: 2rem;
        }
        .progress-bar {
            height: 8px;
            border-radius: 4px;
            background-color: #e9ecef;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background-color: #007bff;
            transition: width 0.3s;
        }
        .btn-group-vertical .btn {
            margin-bottom: 0.5rem;
        }
        .dependency-line {
            position: absolute;
            height: 2px;
            background-color: #6c757d;
            z-index: 1;
        }
        .gantt-preview {
            height: 300px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            overflow: hidden;
        }
        .loading-spinner {
            display: none;
        }
        .loading-spinner.show {
            display: inline-block;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <div class="row bg-primary text-white p-3">
            <div class="col">
                <h2><i class="fas fa-magic"></i> Plan from Document Wizard</h2>
                <p class="mb-0">Transform your documents into structured project plans</p>
            </div>
        </div>

        <!-- Step Indicators -->
        <div class="step-indicator mt-3">
            <div class="step-circle active" data-step="1">
                <i class="fas fa-upload"></i>
            </div>
            <div class="step-circle" data-step="2">
                <i class="fas fa-eye"></i>
            </div>
            <div class="step-circle" data-step="3">
                <i class="fas fa-edit"></i>
            </div>
            <div class="step-circle" data-step="4">
                <i class="fas fa-check"></i>
            </div>
        </div>

        <!-- Step 1: Upload Document -->
        <div class="wizard-step active" id="step-1">
            <div class="row justify-content-center">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h4><i class="fas fa-upload"></i> Step 1: Upload Document</h4>
                        </div>
                        <div class="card-body">
                            <div class="upload-area" id="upload-area">
                                <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                <h5>Drag & Drop your document here</h5>
                                <p class="text-muted">or click to browse files</p>
                                <p class="text-muted small">Supported formats: PDF, DOCX, TXT, MD</p>
                                <input type="file" id="file-input" accept=".pdf,.docx,.txt,.md" style="display: none;">
                            </div>
                            
                            <div class="file-preview mt-3" id="file-preview" style="display: none;">
                                <h6>Document Preview:</h6>
                                <div id="file-content"></div>
                            </div>
                            
                            <div class="mt-3">
                                <button class="btn btn-primary" id="extract-btn" disabled>
                                    <span class="loading-spinner" id="extract-spinner">
                                        <i class="fas fa-spinner fa-spin"></i>
                                    </span>
                                    Extract Plan
                                </button>
                                <button class="btn btn-secondary" onclick="resetWizard()">Reset</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 2: Review Extraction -->
        <div class="wizard-step" id="step-2">
            <div class="row">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h4><i class="fas fa-eye"></i> Step 2: Review Extraction</h4>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Document Type:</h6>
                                    <span class="badge bg-info" id="doc-type">Unknown</span>
                                </div>
                                <div class="col-md-6">
                                    <h6>AI Model Used:</h6>
                                    <span class="badge bg-secondary" id="ai-model">Unknown</span>
                                </div>
                            </div>
                            
                            <div class="mt-3">
                                <h6>Extracted Work Breakdown Structure:</h6>
                                <div class="wbs-tree" id="wbs-tree"></div>
                            </div>
                            
                            <div class="mt-3">
                                <h6>Dependencies:</h6>
                                <div id="dependencies-list"></div>
                            </div>
                            
                            <div class="mt-3">
                                <h6>Risk Assessment:</h6>
                                <div id="risks-list"></div>
                            </div>
                            
                            <div class="mt-3">
                                <h6>Effort Estimates:</h6>
                                <div id="efforts-list"></div>
                            </div>
                            
                            <div class="mt-3">
                                <button class="btn btn-success" onclick="nextStep()">Continue to Edit</button>
                                <button class="btn btn-secondary" onclick="previousStep()">Back</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h6>Extraction Summary</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label>Epics: <span id="epic-count">0</span></label>
                                <div class="progress-bar">
                                    <div class="progress-fill" id="epic-progress" style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label>Features: <span id="feature-count">0</span></label>
                                <div class="progress-bar">
                                    <div class="progress-fill" id="feature-progress" style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label>Tasks: <span id="task-count">0</span></label>
                                <div class="progress-bar">
                                    <div class="progress-fill" id="task-progress" style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label>Total Estimated Hours: <span id="total-hours">0</span></label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 3: Edit WBS -->
        <div class="wizard-step" id="step-3">
            <div class="row">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h4><i class="fas fa-edit"></i> Step 3: Edit Work Breakdown Structure</h4>
                        </div>
                        <div class="card-body">
                            <div class="btn-group-vertical w-100 mb-3">
                                <button class="btn btn-outline-primary" onclick="addEpic()">
                                    <i class="fas fa-plus"></i> Add Epic
                                </button>
                                <button class="btn btn-outline-success" onclick="addFeature()">
                                    <i class="fas fa-plus"></i> Add Feature
                                </button>
                                <button class="btn btn-outline-warning" onclick="addTask()">
                                    <i class="fas fa-plus"></i> Add Task
                                </button>
                            </div>
                            
                            <div class="wbs-tree" id="editable-wbs-tree"></div>
                            
                            <div class="mt-3">
                                <button class="btn btn-success" onclick="nextStep()">Continue to Confirm</button>
                                <button class="btn btn-secondary" onclick="previousStep()">Back</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h6>Dependency Editor</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label>From Task:</label>
                                <select class="form-select" id="dependency-from"></select>
                            </div>
                            <div class="mb-3">
                                <label>To Task:</label>
                                <select class="form-select" id="dependency-to"></select>
                            </div>
                            <div class="mb-3">
                                <label>Dependency Type:</label>
                                <select class="form-select" id="dependency-type">
                                    <option value="finish_to_start">Finish to Start</option>
                                    <option value="start_to_start">Start to Start</option>
                                    <option value="finish_to_finish">Finish to Finish</option>
                                    <option value="start_to_finish">Start to Finish</option>
                                </select>
                            </div>
                            <button class="btn btn-primary btn-sm" onclick="addDependency()">
                                <i class="fas fa-plus"></i> Add Dependency
                            </button>
                            
                            <hr>
                            
                            <h6>Current Dependencies:</h6>
                            <div id="current-dependencies"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 4: Confirm & Generate -->
        <div class="wizard-step" id="step-4">
            <div class="row">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h4><i class="fas fa-check"></i> Step 4: Confirm & Generate Plan</h4>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Project Details:</h6>
                                    <div class="mb-3">
                                        <label>Project Name:</label>
                                        <input type="text" class="form-control" id="project-name" placeholder="Enter project name">
                                    </div>
                                    <div class="mb-3">
                                        <label>Project Description:</label>
                                        <textarea class="form-control" id="project-description" rows="3" placeholder="Enter project description"></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label>Project Manager:</label>
                                        <select class="form-select" id="project-manager"></select>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <h6>Plan Settings:</h6>
                                    <div class="mb-3">
                                        <label>Baseline Name:</label>
                                        <input type="text" class="form-control" id="baseline-name" placeholder="e.g., Initial Baseline v1.0">
                                    </div>
                                    <div class="mb-3">
                                        <label>Start Date:</label>
                                        <input type="date" class="form-control" id="project-start-date">
                                    </div>
                                    <div class="mb-3">
                                        <label>Target End Date:</label>
                                        <input type="date" class="form-control" id="project-end-date">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-3">
                                <h6>Gantt Chart Preview:</h6>
                                <div class="gantt-preview" id="gantt-preview">
                                    <div class="text-center text-muted p-5">
                                        <i class="fas fa-chart-bar fa-3x mb-3"></i>
                                        <p>Gantt chart preview will appear here</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-3">
                                <button class="btn btn-success btn-lg" onclick="generatePlan()">
                                    <span class="loading-spinner" id="generate-spinner">
                                        <i class="fas fa-spinner fa-spin"></i>
                                    </span>
                                    Generate Project Plan
                                </button>
                                <button class="btn btn-secondary" onclick="previousStep()">Back</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h6>Plan Summary</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <strong>Total Tasks:</strong> <span id="summary-tasks">0</span>
                            </div>
                            <div class="mb-3">
                                <strong>Estimated Duration:</strong> <span id="summary-duration">0 days</span>
                            </div>
                            <div class="mb-3">
                                <strong>Total Effort:</strong> <span id="summary-effort">0 hours</span>
                            </div>
                            <div class="mb-3">
                                <strong>Dependencies:</strong> <span id="summary-dependencies">0</span>
                            </div>
                            <div class="mb-3">
                                <strong>Risk Level:</strong> <span id="summary-risk">Low</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="modal fade" id="successModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Plan Generated Successfully!</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center">
                        <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                        <h6>Your project plan has been created successfully!</h6>
                        <p class="text-muted">Project ID: <span id="created-project-id"></span></p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="viewProject()">View Project</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentStep = 1;
        let extractedPlan = null;
        let currentWBS = null;
        let dependencies = [];

        // File upload handling
        document.getElementById('upload-area').addEventListener('click', () => {
            document.getElementById('file-input').click();
        });

        document.getElementById('file-input').addEventListener('change', handleFileSelect);

        // Drag and drop handling
        const uploadArea = document.getElementById('upload-area');
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        function handleFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                document.getElementById('file-content').textContent = content.substring(0, 500) + '...';
                document.getElementById('file-preview').style.display = 'block';
                document.getElementById('extract-btn').disabled = false;
            };
            reader.readAsText(file);
        }

        // Extract plan from document
        document.getElementById('extract-btn').addEventListener('click', async () => {
            const spinner = document.getElementById('extract-spinner');
            const btn = document.getElementById('extract-btn');
            
            spinner.classList.add('show');
            btn.disabled = true;

            try {
                // Simulate API call to extract plan
                await simulateExtraction();
                
                // Move to next step
                nextStep();
            } catch (error) {
                console.error('Extraction failed:', error);
                alert('Failed to extract plan from document. Please try again.');
            } finally {
                spinner.classList.remove('show');
                btn.disabled = false;
            }
        });

        async function simulateExtraction() {
            // Simulate API delay
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // Mock extracted plan
            extractedPlan = {
                document_type: "SRS",
                ai_model: "llama3.1",
                extraction: {
                    epics: [
                        {
                            id: 1,
                            name: "User Management System",
                            description: "Complete user management functionality",
                            features: [
                                {
                                    id: 1,
                                    name: "User Registration",
                                    description: "Allow users to register accounts",
                                    tasks: [
                                        { id: 1, name: "Design registration form", estimated_hours: 4 },
                                        { id: 2, name: "Implement validation", estimated_hours: 6 },
                                        { id: 3, name: "Add email verification", estimated_hours: 8 }
                                    ]
                                },
                                {
                                    id: 2,
                                    name: "User Authentication",
                                    description: "Secure login and session management",
                                    tasks: [
                                        { id: 4, name: "Implement login system", estimated_hours: 10 },
                                        { id: 5, name: "Add password reset", estimated_hours: 6 },
                                        { id: 6, name: "Session management", estimated_hours: 8 }
                                    ]
                                }
                            ]
                        }
                    ]
                },
                dependencies: [
                    { from: 1, to: 4, type: "finish_to_start" },
                    { from: 2, to: 5, type: "finish_to_start" }
                ],
                risks: [
                    { description: "Security vulnerabilities in authentication", level: "high" },
                    { description: "User data privacy concerns", level: "medium" }
                ],
                efforts: {
                    total_hours: 42,
                    breakdown: "4+6+8+10+6+8 = 42 hours"
                }
            };
            
            currentWBS = JSON.parse(JSON.stringify(extractedPlan.extraction));
            dependencies = extractedPlan.dependencies;
        }

        function nextStep() {
            if (currentStep < 4) {
                document.getElementById(`step-${currentStep}`).classList.remove('active');
                currentStep++;
                document.getElementById(`step-${currentStep}`).classList.add('active');
                updateStepIndicators();
                
                if (currentStep === 2) {
                    displayExtractionResults();
                } else if (currentStep === 3) {
                    displayEditableWBS();
                } else if (currentStep === 4) {
                    displayConfirmation();
                }
            }
        }

        function previousStep() {
            if (currentStep > 1) {
                document.getElementById(`step-${currentStep}`).classList.remove('active');
                currentStep--;
                document.getElementById(`step-${currentStep}`).classList.add('active');
                updateStepIndicators();
            }
        }

        function updateStepIndicators() {
            document.querySelectorAll('.step-circle').forEach((circle, index) => {
                circle.classList.remove('active', 'completed');
                if (index + 1 === currentStep) {
                    circle.classList.add('active');
                } else if (index + 1 < currentStep) {
                    circle.classList.add('completed');
                }
            });
        }

        function displayExtractionResults() {
            if (!extractedPlan) return;
            
            document.getElementById('doc-type').textContent = extractedPlan.document_type;
            document.getElementById('ai-model').textContent = extractedPlan.ai_model;
            
            // Display WBS
            const wbsTree = document.getElementById('wbs-tree');
            wbsTree.innerHTML = '';
            
            extractedPlan.extraction.epics.forEach(epic => {
                const epicDiv = document.createElement('div');
                epicDiv.className = 'wbs-item epic';
                epicDiv.innerHTML = `<strong>${epic.name}</strong><br><small>${epic.description}</small>`;
                wbsTree.appendChild(epicDiv);
                
                epic.features.forEach(feature => {
                    const featureDiv = document.createElement('div');
                    featureDiv.className = 'wbs-item feature';
                    featureDiv.innerHTML = `<strong>${feature.name}</strong><br><small>${feature.description}</small>`;
                    wbsTree.appendChild(featureDiv);
                    
                    feature.tasks.forEach(task => {
                        const taskDiv = document.createElement('div');
                        taskDiv.className = 'wbs-item task';
                        taskDiv.innerHTML = `${task.name} (${task.estimated_hours}h)`;
                        wbsTree.appendChild(taskDiv);
                    });
                });
            });
            
            // Display dependencies
            const depsList = document.getElementById('dependencies-list');
            depsList.innerHTML = '';
            extractedPlan.dependencies.forEach(dep => {
                const depDiv = document.createElement('div');
                depDiv.className = 'alert alert-info';
                depDiv.textContent = `Task ${dep.from} → Task ${dep.to} (${dep.type})`;
                depsList.appendChild(depDiv);
            });
            
            // Display risks
            const risksList = document.getElementById('risks-list');
            risksList.innerHTML = '';
            extractedPlan.risks.forEach(risk => {
                const riskDiv = document.createElement('div');
                riskDiv.className = `alert alert-${risk.level === 'high' ? 'danger' : 'warning'}`;
                riskDiv.textContent = risk.description;
                risksList.appendChild(riskDiv);
            });
            
            // Display efforts
            const effortsList = document.getElementById('efforts-list');
            effortsList.innerHTML = `<div class="alert alert-success">Total: ${extractedPlan.efforts.total_hours} hours</div>`;
            
            // Update summary
            updateSummary();
        }

        function updateSummary() {
            if (!extractedPlan) return;
            
            let totalTasks = 0;
            let totalHours = 0;
            
            extractedPlan.extraction.epics.forEach(epic => {
                epic.features.forEach(feature => {
                    feature.tasks.forEach(task => {
                        totalTasks++;
                        totalHours += task.estimated_hours;
                    });
                });
            });
            
            document.getElementById('epic-count').textContent = extractedPlan.extraction.epics.length;
            document.getElementById('feature-count').textContent = extractedPlan.extraction.epics.reduce((sum, epic) => sum + epic.features.length, 0);
            document.getElementById('task-count').textContent = totalTasks;
            document.getElementById('total-hours').textContent = totalHours;
            
            // Update progress bars
            document.getElementById('epic-progress').style.width = '100%';
            document.getElementById('feature-progress').style.width = '100%';
            document.getElementById('task-progress').style.width = '100%';
        }

        function displayEditableWBS() {
            const editableTree = document.getElementById('editable-wbs-tree');
            editableTree.innerHTML = '';
            
            // Similar to displayExtractionResults but with edit buttons
            currentWBS.epics.forEach(epic => {
                const epicDiv = document.createElement('div');
                epicDiv.className = 'wbs-item epic';
                epicDiv.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${epic.name}</strong><br><small>${epic.description}</small>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteItem('epic', ${epic.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                editableTree.appendChild(epicDiv);
                
                epic.features.forEach(feature => {
                    const featureDiv = document.createElement('div');
                    featureDiv.className = 'wbs-item feature';
                    featureDiv.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${feature.name}</strong><br><small>${feature.description}</small>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteItem('feature', ${feature.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    editableTree.appendChild(featureDiv);
                    
                    feature.tasks.forEach(task => {
                        const taskDiv = document.createElement('div');
                        taskDiv.className = 'wbs-item task';
                        taskDiv.innerHTML = `
                            <div class="d-flex justify-content-between align-items-center">
                                <div>${task.name} (${task.estimated_hours}h)</div>
                                <div>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteItem('task', ${task.id})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                        editableTree.appendChild(taskDiv);
                    });
                });
            });
            
            updateDependencyDropdowns();
            displayCurrentDependencies();
        }

        function addEpic() {
            const name = prompt('Enter epic name:');
            if (name) {
                const newEpic = {
                    id: Date.now(),
                    name: name,
                    description: prompt('Enter epic description:') || '',
                    features: []
                };
                currentWBS.epics.push(newEpic);
                displayEditableWBS();
            }
        }

        function addFeature() {
            const epicId = prompt('Enter epic ID to add feature to:');
            const epic = currentWBS.epics.find(e => e.id == epicId);
            if (epic) {
                const name = prompt('Enter feature name:');
                if (name) {
                    const newFeature = {
                        id: Date.now(),
                        name: name,
                        description: prompt('Enter feature description:') || '',
                        tasks: []
                    };
                    epic.features.push(newFeature);
                    displayEditableWBS();
                }
            }
        }

        function addTask() {
            const featureId = prompt('Enter feature ID to add task to:');
                for (const epic of currentWBS.epics) {
                    const feature = epic.features.find(f => f.id == featureId);
                    if (feature) {
                        const name = prompt('Enter task name:');
                        if (name) {
                            const hours = prompt('Enter estimated hours:') || 0;
                            const newTask = {
                                id: Date.now(),
                                name: name,
                                estimated_hours: parseFloat(hours)
                            };
                            feature.tasks.push(newTask);
                            displayEditableWBS();
                            break;
                        }
                    }
                }
        }

        function deleteItem(type, id) {
            if (confirm('Are you sure you want to delete this item?')) {
                if (type === 'epic') {
                    currentWBS.epics = currentWBS.epics.filter(e => e.id !== id);
                } else if (type === 'feature') {
                    for (const epic of currentWBS.epics) {
                        epic.features = epic.features.filter(f => f.id !== id);
                    }
                } else if (type === 'task') {
                    for (const epic of currentWBS.epics) {
                        for (const feature of epic.features) {
                            feature.tasks = feature.tasks.filter(t => t.id !== id);
                        }
                    }
                }
                displayEditableWBS();
            }
        }

        function updateDependencyDropdowns() {
            const fromSelect = document.getElementById('dependency-from');
            const toSelect = document.getElementById('dependency-to');
            
            fromSelect.innerHTML = '<option value="">Select task...</option>';
            toSelect.innerHTML = '<option value="">Select task...</option>';
            
            let taskId = 1;
            for (const epic of currentWBS.epics) {
                for (const feature of epic.features) {
                    for (const task of feature.tasks) {
                        const option1 = document.createElement('option');
                        option1.value = taskId;
                        option1.textContent = `${taskId}: ${task.name}`;
                        fromSelect.appendChild(option1);
                        
                        const option2 = document.createElement('option');
                        option2.value = taskId;
                        option2.textContent = `${taskId}: ${task.name}`;
                        toSelect.appendChild(option2);
                        
                        taskId++;
                    }
                }
            }
        }

        function addDependency() {
            const from = document.getElementById('dependency-from').value;
            const to = document.getElementById('dependency-to').value;
            const type = document.getElementById('dependency-type').value;
            
            if (from && to && from !== to) {
                dependencies.push({
                    from: parseInt(from),
                    to: parseInt(to),
                    type: type
                });
                displayCurrentDependencies();
            }
        }

        function displayCurrentDependencies() {
            const depsDiv = document.getElementById('current-dependencies');
            depsDiv.innerHTML = '';
            
            dependencies.forEach((dep, index) => {
                const depDiv = document.createElement('div');
                depDiv.className = 'alert alert-info d-flex justify-content-between align-items-center';
                depDiv.innerHTML = `
                    <span>Task ${dep.from} → Task ${dep.to} (${dep.type})</span>
                    <button class="btn btn-sm btn-outline-danger" onclick="removeDependency(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                depsDiv.appendChild(depDiv);
            });
        }

        function removeDependency(index) {
            dependencies.splice(index, 1);
            displayCurrentDependencies();
        }

        function displayConfirmation() {
            // Set default values
            document.getElementById('project-name').value = 'New Project from Document';
            document.getElementById('project-description').value = 'Project created from document using AI extraction';
            document.getElementById('baseline-name').value = 'Initial Baseline v1.0';
            
            const today = new Date();
            document.getElementById('project-start-date').value = today.toISOString().split('T')[0];
            
            const endDate = new Date(today);
            endDate.setDate(today.getDate() + 30);
            document.getElementById('project-end-date').value = endDate.toISOString().split('T')[0];
            
            // Update summary
            updateFinalSummary();
        }

        function updateFinalSummary() {
            let totalTasks = 0;
            let totalHours = 0;
            
            for (const epic of currentWBS.epics) {
                for (const feature of epic.features) {
                    for (const task of feature.tasks) {
                        totalTasks++;
                        totalHours += task.estimated_hours;
                    }
                }
            }
            
            document.getElementById('summary-tasks').textContent = totalTasks;
            document.getElementById('summary-duration').textContent = '30 days';
            document.getElementById('summary-effort').textContent = `${totalHours} hours`;
            document.getElementById('summary-dependencies').textContent = dependencies.length;
            document.getElementById('summary-risk').textContent = 'Medium';
        }

        async function generatePlan() {
            const spinner = document.getElementById('generate-spinner');
            const btn = document.querySelector('#step-4 .btn-success');
            
            spinner.classList.add('show');
            btn.disabled = true;

            try {
                // Simulate API call to create project
                await simulateProjectCreation();
                
                // Show success modal
                const modal = new bootstrap.Modal(document.getElementById('successModal'));
                modal.show();
            } catch (error) {
                console.error('Project creation failed:', error);
                alert('Failed to create project. Please try again.');
            } finally {
                spinner.classList.remove('show');
                btn.disabled = false;
            }
        }

        async function simulateProjectCreation() {
            // Simulate API delay
            await new Promise(resolve => setTimeout(resolve, 3000));
            
            // Mock project creation
            const projectId = Math.floor(Math.random() * 1000) + 1;
            document.getElementById('created-project-id').textContent = projectId;
        }

        function viewProject() {
            // Redirect to project page
            window.location.href = '/projects';
        }

        function resetWizard() {
            currentStep = 1;
            extractedPlan = null;
            currentWBS = null;
            dependencies = [];
            
            // Reset UI
            document.querySelectorAll('.wizard-step').forEach(step => step.classList.remove('active'));
            document.getElementById('step-1').classList.add('active');
            
            document.getElementById('file-preview').style.display = 'none';
            document.getElementById('extract-btn').disabled = true;
            document.getElementById('file-input').value = '';
            
            updateStepIndicators();
        }
    </script>
</body>
</html>
