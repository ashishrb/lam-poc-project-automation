<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finance - Project Portfolio Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">ðŸš€ PPM System</a>
            <div class="navbar-nav">
                <a class="nav-link" href="/web/dashboard">Dashboard</a>
                <a class="nav-link" href="/web/projects">Projects</a>
                <a class="nav-link" href="/web/resources">Resources</a>
                <a class="nav-link active" href="/web/finance">Finance</a>
                <a class="nav-link" href="/web/ai-copilot">AI Copilot</a>
                <a class="nav-link" href="/web/alerts">Alerts</a>
                <a class="nav-link" href="/web/reports">Reports</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center">
            <h1>ðŸ’° Finance</h1>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newBudgetModal">
                <i class="fas fa-plus"></i> New Budget
            </button>
        </div>
        
        <!-- Finance Overview -->
        <div class="row mt-4">
            <div class="col-md-3">
                <div class="card text-white bg-primary">
                    <div class="card-body">
                        <h5 class="card-title">Total Budget</h5>
                        <p class="card-text display-6" id="totalBudget">${{ finance.total_budget|default(0)|int|round(0) }}</p>
                        <p class="card-text">All Projects</p>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3">
                <div class="card text-white bg-success">
                    <div class="card-body">
                        <h5 class="card-title">Spent</h5>
                        <p class="card-text display-6" id="totalSpent">${{ finance.spent|default(0)|int|round(0) }}</p>
                        <p class="card-text">Actual Costs</p>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3">
                <div class="card text-white bg-warning">
                    <div class="card-body">
                        <h5 class="card-title">Remaining</h5>
                        <p class="card-text display-6" id="totalRemaining">${{ finance.remaining|default(0)|int|round(0) }}</p>
                        <p class="card-text">Available</p>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3">
                <div class="card text-white bg-info">
                    <div class="card-body">
                        <h5 class="card-title">Variance</h5>
                        <p class="card-text display-6" id="totalVariance">0%</p>
                        <p class="card-text">Budget vs Actual</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Budget List -->
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Budget Overview</h5>
                    </div>
                    <div class="card-body">
                        <div id="budgetList">
                            {% if finance.projects %}
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Project</th>
                                                <th>Budget</th>
                                                <th>Spent</th>
                                                <th>Remaining</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for project in finance.projects %}
                                            <tr>
                                                <td><strong>{{ project.name }}</strong></td>
                                                <td>${{ project.budget|int|round(0) }}</td>
                                                <td>${{ project.spent|int|round(0) }}</td>
                                                <td>${{ (project.budget - project.spent)|int|round(0) }}</td>
                                                <td><span class="badge bg-success">{{ project.status }}</span></td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <p class="text-muted">No budgets found. Create your first budget to get started.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- New Budget Modal -->
    <div class="modal fade" id="newBudgetModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Budget</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="newBudgetForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Budget Name *</label>
                                    <input type="text" class="form-control" name="budgetName" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Project</label>
                                    <select class="form-select" name="projectId">
                                        <option value="">Select Project (Optional)</option>
                                        <option value="general">General Operations</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Fiscal Year *</label>
                                    <select class="form-select" name="fiscalYear" required>
                                        <option value="">Select Year</option>
                                        <option value="2024">2024</option>
                                        <option value="2025" selected>2025</option>
                                        <option value="2026">2026</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Budget Type</label>
                                    <select class="form-select" name="budgetType">
                                        <option value="operational">Operational</option>
                                        <option value="capital">Capital</option>
                                        <option value="project">Project Specific</option>
                                        <option value="departmental">Departmental</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Total Budget Amount ($) *</label>
                                    <input type="number" class="form-control" name="totalAmount" min="0" step="1000" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Currency</label>
                                    <select class="form-select" name="currency">
                                        <option value="USD" selected>USD ($)</option>
                                        <option value="EUR">EUR (â‚¬)</option>
                                        <option value="GBP">GBP (Â£)</option>
                                        <option value="CAD">CAD (C$)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" name="description" rows="3" placeholder="Budget description and purpose..."></textarea>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h6>Budget Categories</h6>
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="addBudgetCategory()">
                                    <i class="fas fa-plus"></i> Add Category
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="budgetCategories">
                                    <!-- Categories will be added here dynamically -->
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveBudget()">Create Budget</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Budget Details Modal -->
    <div class="modal fade" id="budgetDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Budget Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="budgetDetailsContent">
                        <!-- Content will be populated dynamically -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let budgets = [];
        let currentBudgetId = 0;
        let categoryCounter = 0;

        function addBudgetCategory() {
            categoryCounter++;
            const categoriesDiv = document.getElementById('budgetCategories');
            
            const categoryHtml = `
                <div class="row mb-2" id="category-${categoryCounter}">
                    <div class="col-md-4">
                        <input type="text" class="form-control" name="categoryName[]" placeholder="Category Name" required>
                    </div>
                    <div class="col-md-3">
                        <input type="number" class="form-control" name="categoryAmount[]" placeholder="Amount" min="0" step="100" required>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" name="categoryType[]">
                            <option value="expense">Expense</option>
                            <option value="revenue">Revenue</option>
                            <option value="investment">Investment</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeCategory(${categoryCounter})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            
            categoriesDiv.insertAdjacentHTML('beforeend', categoryHtml);
        }

        function removeCategory(categoryId) {
            const categoryElement = document.getElementById(`category-${categoryId}`);
            if (categoryElement) {
                categoryElement.remove();
            }
        }

        function saveBudget() {
            const form = document.getElementById('newBudgetForm');
            const formData = new FormData(form);
            
            // Collect categories
            const categories = [];
            const categoryNames = formData.getAll('categoryName[]');
            const categoryAmounts = formData.getAll('categoryAmount[]');
            const categoryTypes = formData.getAll('categoryType[]');
            
            for (let i = 0; i < categoryNames.length; i++) {
                if (categoryNames[i] && categoryAmounts[i]) {
                    categories.push({
                        name: categoryNames[i],
                        amount: parseFloat(categoryAmounts[i]),
                        type: categoryTypes[i] || 'expense'
                    });
                }
            }
            
            const budget = {
                id: ++currentBudgetId,
                name: formData.get('budgetName'),
                projectId: formData.get('projectId'),
                fiscalYear: formData.get('fiscalYear'),
                budgetType: formData.get('budgetType'),
                totalAmount: parseFloat(formData.get('totalAmount')),
                currency: formData.get('currency'),
                description: formData.get('description'),
                categories: categories,
                createdAt: new Date().toISOString(),
                actuals: [],
                forecasts: [],
                approvals: []
            };
            
            budgets.push(budget);
            updateBudgetList();
            updateFinanceOverview();
            
            // Close modal and reset form
            bootstrap.Modal.getInstance(document.getElementById('newBudgetModal')).hide();
            form.reset();
            
            // Clear categories
            document.getElementById('budgetCategories').innerHTML = '';
            categoryCounter = 0;
            
            // Show success message
            showAlert('Budget created successfully!', 'success');
        }

        function updateBudgetList() {
            const container = document.getElementById('budgetList');
            
            if (budgets.length === 0) {
                container.innerHTML = '<p class="text-muted">No budgets found. Create your first budget to get started.</p>';
                return;
            }
            
            let html = '<div class="table-responsive"><table class="table table-hover">';
            html += '<thead><tr><th>Budget</th><th>Type</th><th>Amount</th><th>Spent</th><th>Remaining</th><th>Variance</th><th>Actions</th></tr></thead><tbody>';
            
            budgets.forEach(budget => {
                const spent = calculateSpent(budget);
                const remaining = budget.totalAmount - spent;
                const variance = ((spent / budget.totalAmount) * 100).toFixed(1);
                const varianceClass = variance > 100 ? 'text-danger' : variance > 90 ? 'text-warning' : 'text-success';
                
                html += `
                    <tr>
                        <td>
                            <strong>${budget.name}</strong><br>
                            <small class="text-muted">${budget.fiscalYear} - ${budget.budgetType}</small>
                        </td>
                        <td><span class="badge bg-info">${budget.budgetType}</span></td>
                        <td>$${budget.totalAmount.toLocaleString()}</td>
                        <td>$${spent.toLocaleString()}</td>
                        <td>$${remaining.toLocaleString()}</td>
                        <td class="${varianceClass}">${variance}%</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="viewBudgetDetails(${budget.id})">
                                <i class="fas fa-eye"></i> View
                            </button>
                            <button class="btn btn-sm btn-outline-success" onclick="addActual(${budget.id})">
                                <i class="fas fa-plus"></i> Actual
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        function calculateSpent(budget) {
            return budget.actuals.reduce((sum, actual) => sum + actual.amount, 0);
        }

        function updateFinanceOverview() {
            const totalBudget = budgets.reduce((sum, budget) => sum + budget.totalAmount, 0);
            const totalSpent = budgets.reduce((sum, budget) => sum + calculateSpent(budget), 0);
            const totalRemaining = totalBudget - totalSpent;
            const totalVariance = totalBudget > 0 ? ((totalSpent / totalBudget) * 100).toFixed(1) : 0;
            
            document.getElementById('totalBudget').textContent = `$${totalBudget.toLocaleString()}`;
            document.getElementById('totalSpent').textContent = `$${totalSpent.toLocaleString()}`;
            document.getElementById('totalRemaining').textContent = `$${totalRemaining.toLocaleString()}`;
            document.getElementById('totalVariance').textContent = `${totalVariance}%`;
            
            // Update variance color
            const varianceElement = document.getElementById('totalVariance');
            if (totalVariance > 100) {
                varianceElement.className = 'card-text display-6 text-danger';
            } else if (totalVariance > 90) {
                varianceElement.className = 'card-text display-6 text-warning';
            } else {
                varianceElement.className = 'card-text display-6 text-success';
            }
        }

        function viewBudgetDetails(budgetId) {
            const budget = budgets.find(b => b.id === budgetId);
            if (!budget) return;
            
            const modal = document.getElementById('budgetDetailsModal');
            const content = document.getElementById('budgetDetailsContent');
            
            const spent = calculateSpent(budget);
            const remaining = budget.totalAmount - spent;
            const variance = ((spent / budget.totalAmount) * 100).toFixed(1);
            
            content.innerHTML = `
                <div class="row">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h6>Budget Information</h6>
                            </div>
                            <div class="card-body">
                                <p><strong>Name:</strong> ${budget.name}</p>
                                <p><strong>Type:</strong> ${budget.budgetType}</p>
                                <p><strong>Fiscal Year:</strong> ${budget.fiscalYear}</p>
                                <p><strong>Total Amount:</strong> $${budget.totalAmount.toLocaleString()}</p>
                                <p><strong>Currency:</strong> ${budget.currency}</p>
                                <p><strong>Description:</strong> ${budget.description || 'No description'}</p>
                            </div>
                        </div>
                        
                        <div class="card mt-3">
                            <div class="card-header">
                                <h6>Financial Summary</h6>
                            </div>
                            <div class="card-body text-center">
                                <div class="row text-center">
                                    <div class="col-6">
                                        <h5 class="text-success">$${spent.toLocaleString()}</h5>
                                        <small>Spent</small>
                                    </div>
                                    <div class="col-6">
                                        <h5 class="text-primary">$${remaining.toLocaleString()}</h5>
                                        <small>Remaining</small>
                                    </div>
                                </div>
                                <hr>
                                <h4 class="${variance > 100 ? 'text-danger' : variance > 90 ? 'text-warning' : 'text-success'}">${variance}%</h4>
                                <small>Utilization</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-8">
                        <div class="card mb-3">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6>Budget Categories</h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Category</th>
                                                <th>Type</th>
                                                <th>Budgeted</th>
                                                <th>Spent</th>
                                                <th>Remaining</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${budget.categories.map(cat => {
                                                const categorySpent = budget.actuals
                                                    .filter(actual => actual.category === cat.name)
                                                    .reduce((sum, actual) => sum + actual.amount, 0);
                                                const categoryRemaining = cat.amount - categorySpent;
                                                return `
                                                    <tr>
                                                        <td>${cat.name}</td>
                                                        <td><span class="badge bg-${cat.type === 'expense' ? 'danger' : cat.type === 'revenue' ? 'success' : 'info'}">${cat.type}</span></td>
                                                        <td>$${cat.amount.toLocaleString()}</td>
                                                        <td>$${categorySpent.toLocaleString()}</td>
                                                        <td class="${categoryRemaining < 0 ? 'text-danger' : ''}">$${categoryRemaining.toLocaleString()}</td>
                                                    </tr>
                                                `;
                                            }).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card mb-3">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6>Actual Expenses</h6>
                                <button class="btn btn-sm btn-primary" onclick="addActual(${budget.id})">
                                    <i class="fas fa-plus"></i> Add Actual
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="actuals-${budget.id}">
                                    ${renderActuals(budget.actuals)}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            bootstrap.Modal.getInstance(modal).show();
        }

        function renderActuals(actuals) {
            if (actuals.length === 0) {
                return '<p class="text-muted">No actual expenses recorded yet.</p>';
            }
            
            let html = '';
            actuals.slice(-10).reverse().forEach(actual => {
                html += `
                    <div class="border-bottom pb-2 mb-2">
                        <div class="d-flex justify-content-between">
                            <strong>${actual.description}</strong>
                            <span class="text-danger">$${actual.amount.toLocaleString()}</span>
                        </div>
                        <p class="mb-1">Category: ${actual.category}</p>
                        <small class="text-muted">Date: ${actual.date} | Recorded by: ${actual.recordedBy}</small>
                    </div>
                `;
            });
            return html;
        }

        function addActual(budgetId) {
            const budget = budgets.find(b => b.id === budgetId);
            if (!budget) return;
            
            const description = prompt('Enter expense description:');
            if (!description) return;
            
            const amount = prompt('Enter amount ($):');
            if (!amount || isNaN(amount) || parseFloat(amount) <= 0) return;
            
            const category = prompt('Enter category:');
            if (!category) return;
            
            const recordedBy = prompt('Recorded by (name):');
            
            const actual = {
                id: Date.now(),
                description: description,
                amount: parseFloat(amount),
                category: category,
                date: new Date().toLocaleDateString(),
                recordedBy: recordedBy || 'Unknown',
                createdAt: new Date().toISOString()
            };
            
            budget.actuals.push(actual);
            
            // Update the display if modal is open
            const actualsDiv = document.getElementById(`actuals-${budgetId}`);
            if (actualsDiv) {
                actualsDiv.innerHTML = renderActuals(budget.actuals);
            }
            
            // Update budget list and overview
            updateBudgetList();
            updateFinanceOverview();
            
            showAlert('Actual expense added successfully!', 'success');
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.top = '20px';
            alertDiv.style.right = '20px';
            alertDiv.style.zIndex = '9999';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 3000);
        }

        // Initialize
        updateBudgetList();
        updateFinanceOverview();
    </script>
</body>
</html>
