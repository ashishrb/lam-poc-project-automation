<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Projects - Project Portfolio Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .timeline {
            position: relative;
            padding: 20px 0;
        }
        .timeline-item {
            position: relative;
            padding-left: 30px;
            margin-bottom: 20px;
        }
        .timeline-marker {
            position: absolute;
            left: 0;
            top: 0;
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        .timeline-content {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        .timeline-content h6 {
            margin-bottom: 5px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">ðŸš€ PPM System</a>
            <div class="navbar-nav">
                <a class="nav-link" href="/web/dashboard">Dashboard</a>
                <a class="nav-link active" href="/web/projects">Projects</a>
                <a class="nav-link" href="/web/resources">Resources</a>
                <a class="nav-link" href="/web/finance">Finance</a>
                <a class="nav-link" href="/web/ai-copilot">AI Copilot</a>
                <a class="nav-link" href="/web/alerts">Alerts</a>
                <a class="nav-link" href="/web/reports">Reports</a>
                <a class="nav-link" href="/web/admin">Admin</a>
                <a class="nav-link" href="/web/developer-workbench">Developer</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center">
            <h1>ðŸ“‹ Projects</h1>
            <div>
                <button class="btn btn-secondary me-2" onclick="testButtonClick()">
                    <i class="fas fa-bug"></i> Test JS
                </button>
                <a href="/web/project-plan-creator" class="btn btn-success me-2">
                    <i class="fas fa-project-diagram"></i> Create Plan
                </a>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newProjectModal">
                    <i class="fas fa-plus"></i> New Project
                </button>
            </div>
        </div>
        
        <!-- Project List -->
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Project List</h5>
                    </div>
                    <div class="card-body">
                                <div id="projectList">
            {% if projects %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Project</th>
                                <th>Manager</th>
                                <th>Status</th>
                                <th>Priority</th>
                                <th>Progress</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for project in projects %}
                            <tr>
                                <td>
                                    <strong>{{ project.name }}</strong><br>
                                    <small class="text-muted">{{ project.code or 'N/A' }}</small>
                                </td>
                                <td>{{ project.project_manager_id or 'N/A' }}</td>
                                <td><span class="badge bg-primary">{{ project.status }}</span></td>
                                <td><span class="badge bg-warning">{{ project.priority }}</span></td>
                                <td>
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar" role="progressbar" style="width: 75%">75%</div>
                                    </div>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" onclick="viewProjectDetails({{ project.id }})">
                                        <i class="fas fa-eye"></i> View
                                    </button>
                                    <button class="btn btn-sm btn-outline-success" onclick="addTask({{ project.id }})">
                                        <i class="fas fa-plus"></i> Task
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="text-muted">No projects found. Create your first project to get started.</p>
                <!-- DEBUG: This means projects is empty or None -->
            {% endif %}
        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- New Project Modal -->
    <div class="modal fade" id="newProjectModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Project</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="newProjectForm">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label class="form-label">Project Name *</label>
                                    <input type="text" class="form-control" name="projectName" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Project Code</label>
                                    <input type="text" class="form-control" name="projectCode" placeholder="e.g., PRJ-001">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Start Date *</label>
                                    <input type="date" class="form-control" name="startDate" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">End Date</label>
                                    <input type="date" class="form-control" name="endDate">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Project Manager *</label>
                                    <input type="text" class="form-control" name="projectManager" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Priority</label>
                                    <select class="form-select" name="priority">
                                        <option value="low">Low</option>
                                        <option value="medium" selected>Medium</option>
                                        <option value="high">High</option>
                                        <option value="critical">Critical</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Budget ($)</label>
                                    <input type="number" class="form-control" name="budget" min="0" step="1000">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Status</label>
                                    <select class="form-select" name="status">
                                        <option value="planning">Planning</option>
                                        <option value="active" selected>Active</option>
                                        <option value="on_hold">On Hold</option>
                                        <option value="completed">Completed</option>
                                        <option value="cancelled">Cancelled</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" name="description" rows="3" placeholder="Project description and objectives..."></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Key Stakeholders (comma separated)</label>
                            <input type="text" class="form-control" name="stakeholders" placeholder="e.g., Client, Sponsor, Team Lead">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Technologies & Tools</label>
                            <input type="text" class="form-control" name="technologies" placeholder="e.g., Python, React, AWS, Docker">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveProject()">Create Project</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Project Details Modal -->
    <div class="modal fade" id="projectDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Project Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="projectDetailsContent">
                        <!-- Content will be populated dynamically -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Import Modal -->
    <div class="modal fade" id="quickImportModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Quick Task Import</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Paste your tasks (one per line, or comma-separated)</label>
                        <textarea class="form-control" id="quickImportText" rows="8" placeholder="Example:
â€¢ Design user interface
â€¢ Implement authentication
â€¢ Set up database
â€¢ Write unit tests

Or paste from Excel:
Task 1, Task 2, Task 3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Default Priority</label>
                        <select class="form-select" id="defaultPriority">
                            <option value="low">Low</option>
                            <option value="medium" selected>Medium</option>
                            <option value="high">High</option>
                            <option value="critical">Critical</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Default Assignee</label>
                        <select class="form-select" id="defaultAssignee">
                            <option value="">Select Assignee</option>
                            <option value="john@company.com">John Developer</option>
                            <option value="sarah@company.com">Sarah Designer</option>
                            <option value="mike@company.com">Mike Architect</option>
                            <option value="lisa@company.com">Lisa Tester</option>
                            <option value="alex@company.com">Alex DevOps</option>
                        </select>
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>AI-Powered Import:</strong> The system will automatically parse your input and create structured tasks with estimated effort and dependencies.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="processQuickImport()">
                        <i class="fas fa-magic"></i> Process with AI
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Task Creation Modal -->
    <div class="modal fade" id="taskModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Task</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="taskForm">
                        <input type="hidden" id="taskProjectId" name="projectId">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label class="form-label">Task Title *</label>
                                    <input type="text" class="form-control" name="taskTitle" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Priority</label>
                                    <select class="form-select" name="taskPriority">
                                        <option value="low">Low</option>
                                        <option value="medium" selected>Medium</option>
                                        <option value="high">High</option>
                                        <option value="critical">Critical</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Start Date</label>
                                    <input type="date" class="form-control" name="taskStartDate">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="label">Due Date</label>
                                    <input type="date" class="form-control" name="taskDueDate">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Assigned To</label>
                                    <select class="form-select" name="taskAssignee">
                                        <option value="">Select Assignee</option>
                                        <option value="john@company.com">John Developer</option>
                                        <option value="sarah@company.com">Sarah Designer</option>
                                        <option value="mike@company.com">Mike Architect</option>
                                        <option value="lisa@company.com">Lisa Tester</option>
                                        <option value="alex@company.com">Alex DevOps</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Estimated Hours</label>
                                    <input type="number" class="form-control" name="taskHours" min="1" step="0.5">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" name="taskDescription" rows="3" placeholder="Describe the task requirements..."></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Dependencies</label>
                            <input type="text" class="form-control" name="taskDependencies" placeholder="Task IDs separated by commas (e.g., 1,3,5)">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveTask()">Create Task</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Store projects data for JavaScript access
        window.templateProjects = {{ projects | tojson }};
        
        let projects = [];
        let currentProjectId = 0;

        function saveProject() {
            const form = document.getElementById('newProjectForm');
            const formData = new FormData(form);
            
            const project = {
                id: ++currentProjectId,
                name: formData.get('projectName'),
                code: formData.get('projectCode') || `PRJ-${String(currentProjectId).padStart(3, '0')}`,
                startDate: formData.get('startDate'),
                endDate: formData.get('endDate'),
                projectManager: formData.get('projectManager'),
                priority: formData.get('priority'),
                budget: parseFloat(formData.get('budget')) || 0,
                status: formData.get('status'),
                description: formData.get('description'),
                stakeholders: formData.get('stakeholders').split(',').map(s => s.trim()).filter(s => s),
                technologies: formData.get('technologies').split(',').map(t => t.trim()).filter(t => t),
                createdAt: new Date().toISOString(),
                tasks: [],
                risks: [],
                milestones: []
            };
            
            projects.push(project);
            // updateProjectList(); // Disabled - using template data
            
            // Close modal and reset form
            bootstrap.Modal.getInstance(document.getElementById('newProjectModal')).hide();
            form.reset();
            
            // Show success message
            showAlert('Project created successfully!', 'success');
        }

        function updateProjectList() {
            // This function is now disabled - using template data instead
            console.log('updateProjectList called - using template data');
        }

        function calculateProgress(project) {
            if (project.tasks.length === 0) return 0;
            const completedTasks = project.tasks.filter(task => task.status === 'completed').length;
            return Math.round((completedTasks / project.tasks.length) * 100);
        }

        function getStatusClass(status) {
            const classes = {
                'planning': 'bg-secondary',
                'active': 'bg-primary',
                'on_hold': 'bg-warning',
                'completed': 'bg-success',
                'cancelled': 'bg-danger'
            };
            return classes[status] || 'bg-secondary';
        }

        function getPriorityClass(priority) {
            const classes = {
                'low': 'bg-success',
                'medium': 'bg-primary',
                'high': 'bg-warning',
                'critical': 'bg-danger'
            };
            return classes[priority] || 'bg-secondary';
        }

        function viewProjectDetails(projectId) {
            console.log('viewProjectDetails called with projectId:', projectId);
            console.log('templateProjects:', window.templateProjects);
            
            // Get project data from the template (stored in a global variable)
            const projectData = window.templateProjects ? window.templateProjects.find(p => p.id === projectId) : null;
            if (!projectData) {
                showAlert('Project data not found', 'danger');
                return;
            }
            
            // Get tasks from localStorage
            const tasks = JSON.parse(localStorage.getItem('projectTasks') || '{}')[projectId] || [];
            
            const content = document.getElementById('projectDetailsContent');
            
            content.innerHTML = `
                <div class="row">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h6>Project Information</h6>
                            </div>
                            <div class="card-body">
                                <p><strong>Name:</strong> ${projectData.name}</p>
                                <p><strong>Code:</strong> ${projectData.code}</p>
                                <p><strong>Manager:</strong> ${projectData.project_manager_id}</p>
                                <p><strong>Status:</strong> <span class="badge ${getStatusClass(projectData.status)}">${projectData.status}</span></p>
                                <p><strong>Priority:</strong> <span class="badge ${getPriorityClass(projectData.priority)}">${projectData.priority}</span></p>
                                <p><strong>Progress:</strong> ${projectData.progress || 75}%</p>
                                <p><strong>Budget:</strong> $${projectData.budget ? projectData.budget.toLocaleString() : 'N/A'}</p>
                                <p><strong>Start Date:</strong> ${projectData.start_date || 'N/A'}</p>
                                <p><strong>End Date:</strong> ${projectData.end_date || 'N/A'}</p>
                            </div>
                        </div>
                        
                        <div class="card mt-3">
                            <div class="card-header">
                                <h6>Progress Overview</h6>
                            </div>
                            <div class="card-body text-center">
                                <h2 class="text-primary">${projectData.progress || 75}%</h2>
                                <p class="text-muted">Complete</p>
                                <div class="row text-center">
                                    <div class="col-4">
                                        <h5>${tasks.length}</h5>
                                        <small>Total Tasks</small>
                                    </div>
                                    <div class="col-4">
                                        <h5>${tasks.filter(t => t.status === 'completed').length}</h5>
                                        <small>Completed</small>
                                    </div>
                                    <div class="col-4">
                                        <h5>0</h5>
                                        <small>Risks</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-8">
                        <!-- Project Tabs -->
                        <div class="card">
                            <div class="card-header">
                                <ul class="nav nav-tabs card-header-tabs" id="projectTabs-${projectId}">
                                    <li class="nav-item">
                                        <a class="nav-link active" data-bs-toggle="tab" href="#tasks-${projectId}">
                                            <i class="fas fa-tasks"></i> Tasks
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" data-bs-toggle="tab" href="#dependencies-${projectId}">
                                            <i class="fas fa-project-diagram"></i> Dependencies
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" data-bs-toggle="tab" href="#risks-${projectId}">
                                            <i class="fas fa-exclamation-triangle"></i> Risks
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" data-bs-toggle="tab" href="#files-${projectId}">
                                            <i class="fas fa-file"></i> Files
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" data-bs-toggle="tab" href="#history-${projectId}">
                                            <i class="fas fa-history"></i> History
                                        </a>
                                    </li>
                                </ul>
                            </div>
                            <div class="card-body">
                                <div class="tab-content">
                                    <!-- Tasks Tab -->
                                    <div class="tab-pane fade show active" id="tasks-${projectId}">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h6>Project Tasks</h6>
                                            <div>
                                                <button class="btn btn-sm btn-outline-secondary me-2" onclick="showQuickImport(${projectId})">
                                                    <i class="fas fa-paste"></i> Quick Import
                                                </button>
                                                <button class="btn btn-sm btn-primary" onclick="addTask(${projectId})">
                                                    <i class="fas fa-plus"></i> Add Task
                                                </button>
                                            </div>
                                        </div>
                                        <div id="tasks-content-${projectId}">
                                            ${renderTasks(tasks)}
                                        </div>
                                    </div>
                                    
                                    <!-- Dependencies Tab -->
                                    <div class="tab-pane fade" id="dependencies-${projectId}">
                                        <h6>Task Dependencies</h6>
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle"></i> Dependencies view shows task relationships and critical path analysis.
                                        </div>
                                        <div class="table-responsive">
                                            <table class="table table-sm">
                                                <thead>
                                                    <tr>
                                                        <th>Task</th>
                                                        <th>Depends On</th>
                                                        <th>Duration</th>
                                                        <th>Critical Path</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr>
                                                        <td>Setup Development Environment</td>
                                                        <td>-</td>
                                                        <td>2 days</td>
                                                        <td><span class="badge bg-danger">Yes</span></td>
                                                    </tr>
                                                    <tr>
                                                        <td>Database Design</td>
                                                        <td>Setup Development Environment</td>
                                                        <td>3 days</td>
                                                        <td><span class="badge bg-danger">Yes</span></td>
                                                    </tr>
                                                    <tr>
                                                        <td>API Development</td>
                                                        <td>Database Design</td>
                                                        <td>5 days</td>
                                                        <td><span class="badge bg-danger">Yes</span></td>
                                                    </tr>
                                                    <tr>
                                                        <td>Frontend Development</td>
                                                        <td>API Development</td>
                                                        <td>4 days</td>
                                                        <td><span class="badge bg-secondary">No</span></td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    
                                    <!-- Risks Tab -->
                                    <div class="tab-pane fade" id="risks-${projectId}">
                                        <h6>Project Risks</h6>
                                        <div class="mb-3">
                                            <button class="btn btn-sm btn-warning" onclick="addRisk(${projectId})">
                                                <i class="fas fa-plus"></i> Add Risk
                                            </button>
                                        </div>
                                        <div class="table-responsive">
                                            <table class="table table-sm">
                                                <thead>
                                                    <tr>
                                                        <th>Risk</th>
                                                        <th>Probability</th>
                                                        <th>Impact</th>
                                                        <th>Mitigation</th>
                                                        <th>Status</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr>
                                                        <td>Key developer leaves</td>
                                                        <td><span class="badge bg-warning">Medium</span></td>
                                                        <td><span class="badge bg-danger">High</span></td>
                                                        <td>Cross-training, documentation</td>
                                                        <td><span class="badge bg-warning">Active</span></td>
                                                    </tr>
                                                    <tr>
                                                        <td>Technology stack changes</td>
                                                        <td><span class="badge bg-success">Low</span></td>
                                                        <td><span class="badge bg-warning">Medium</span></td>
                                                        <td>Flexible architecture</td>
                                                        <td><span class="badge bg-success">Mitigated</span></td>
                                                    </tr>
                                                    <tr>
                                                        <td>Scope creep</td>
                                                        <td><span class="badge bg-warning">Medium</span></td>
                                                        <td><span class="badge bg-warning">Medium</span></td>
                                                        <td>Change control process</td>
                                                        <td><span class="badge bg-warning">Active</span></td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    
                                    <!-- Files Tab -->
                                    <div class="tab-pane fade" id="files-${projectId}">
                                        <h6>Project Files</h6>
                                        <div class="mb-3">
                                            <button class="btn btn-sm btn-primary" onclick="uploadFile(${projectId})">
                                                <i class="fas fa-upload"></i> Upload File
                                            </button>
                                        </div>
                                        <div class="table-responsive">
                                            <table class="table table-sm">
                                                <thead>
                                                    <tr>
                                                        <th>File Name</th>
                                                        <th>Type</th>
                                                        <th>Size</th>
                                                        <th>Uploaded By</th>
                                                        <th>Date</th>
                                                        <th>Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr>
                                                        <td><i class="fas fa-file-pdf text-danger"></i> Project_Requirements.pdf</td>
                                                        <td>PDF</td>
                                                        <td>2.3 MB</td>
                                                        <td>john.doe@company.com</td>
                                                        <td>2024-01-10</td>
                                                        <td>
                                                            <button class="btn btn-sm btn-outline-primary">Download</button>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td><i class="fas fa-file-word text-primary"></i> Technical_Spec.docx</td>
                                                        <td>Word</td>
                                                        <td>1.8 MB</td>
                                                        <td>sarah.lead@company.com</td>
                                                        <td>2024-01-12</td>
                                                        <td>
                                                            <button class="btn btn-sm btn-outline-primary">Download</button>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td><i class="fas fa-file-excel text-success"></i> Budget_Plan.xlsx</td>
                                                        <td>Excel</td>
                                                        <td>856 KB</td>
                                                        <td>mike.director@company.com</td>
                                                        <td>2024-01-14</td>
                                                        <td>
                                                            <button class="btn btn-sm btn-outline-primary">Download</button>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    
                                    <!-- History Tab -->
                                    <div class="tab-pane fade" id="history-${projectId}">
                                        <h6>Project History</h6>
                                        <div class="timeline">
                                            <div class="timeline-item">
                                                <div class="timeline-marker bg-success"></div>
                                                <div class="timeline-content">
                                                    <h6>Project Created</h6>
                                                    <p class="text-muted">Project ${projectData.name} was created by ${projectData.project_manager_id}</p>
                                                    <small class="text-muted">2024-01-15 09:00:00</small>
                                                </div>
                                            </div>
                                            <div class="timeline-item">
                                                <div class="timeline-marker bg-info"></div>
                                                <div class="timeline-content">
                                                    <h6>Requirements Documented</h6>
                                                    <p class="text-muted">Project requirements were documented and approved</p>
                                                    <small class="text-muted">2024-01-16 14:30:00</small>
                                                </div>
                                            </div>
                                            <div class="timeline-item">
                                                <div class="timeline-marker bg-warning"></div>
                                                <div class="timeline-content">
                                                    <h6>Risk Identified</h6>
                                                    <p class="text-muted">Key developer departure risk was identified</p>
                                                    <small class="text-muted">2024-01-17 11:15:00</small>
                                                </div>
                                            </div>
                                            <div class="timeline-item">
                                                <div class="timeline-marker bg-primary"></div>
                                                <div class="timeline-content">
                                                    <h6>Development Started</h6>
                                                    <p class="text-muted">Development phase officially started</p>
                                                    <small class="text-muted">2024-01-18 08:00:00</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card mt-3">
                            <div class="card-header">
                                <h6>Project Plan</h6>
                            </div>
                            <div class="card-body">
                                <p class="text-muted">AI-generated project plan will be displayed here.</p>
                                <button class="btn btn-sm btn-outline-primary" onclick="generateAIPlan(${projectId})">
                                    <i class="fas fa-magic"></i> Generate AI Plan
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Show the modal using Bootstrap 5 API
            const modal = new bootstrap.Modal(document.getElementById('projectDetailsModal'));
            modal.show();
        }

        function renderTasks(tasks) {
            if (tasks.length === 0) {
                return '<p class="text-muted">No tasks created yet.</p>';
            }
            
            let html = '';
            tasks.forEach(task => {
                const statusClass = task.status === 'completed' ? 'bg-success' : 
                                  task.status === 'in_progress' ? 'bg-primary' : 'bg-secondary';
                
                html += `
                    <div class="border-bottom pb-2 mb-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <strong>${task.title}</strong>
                            <span class="badge ${statusClass}">${task.status}</span>
                        </div>
                        <p class="mb-1">${task.description}</p>
                        <small class="text-muted">Assigned to: ${task.assignedTo || 'Unassigned'} | Due: ${task.dueDate || 'No due date'}</small>
                    </div>
                `;
            });
            return html;
        }

        function renderRisks(risks) {
            if (risks.length === 0) {
                return '<p class="text-muted">No risks identified yet.</p>';
            }
            
            let html = '';
            risks.forEach(risk => {
                const severityClass = risk.severity === 'high' ? 'bg-danger' : 
                                    risk.severity === 'medium' ? 'bg-warning' : 'bg-info';
                
                html += `
                    <div class="border-bottom pb-2 mb-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <strong>${risk.title}</strong>
                            <span class="badge ${severityClass}">${risk.severity}</span>
                        </div>
                        <p class="mb-1">${risk.description}</p>
                        <small class="text-muted">Mitigation: ${risk.mitigation || 'No mitigation plan'}</small>
                    </div>
                `;
            });
            return html;
        }

        function addTask(projectId) {
            // Set the project ID in the hidden field
            document.getElementById('taskProjectId').value = projectId;
            
            // Show the task creation modal
            const taskModal = new bootstrap.Modal(document.getElementById('taskModal'));
            taskModal.show();
        }

        function saveTask() {
            const form = document.getElementById('taskForm');
            const formData = new FormData(form);
            
            const task = {
                id: Date.now(),
                projectId: parseInt(formData.get('projectId')),
                title: formData.get('taskTitle'),
                description: formData.get('taskDescription'),
                priority: formData.get('taskPriority'),
                assignedTo: formData.get('taskAssignee'),
                startDate: formData.get('taskStartDate'),
                dueDate: formData.get('taskDueDate'),
                estimatedHours: parseFloat(formData.get('taskHours')) || 0,
                dependencies: formData.get('taskDependencies').split(',').map(d => d.trim()).filter(d => d),
                status: 'pending',
                createdAt: new Date().toISOString()
            };
            
            // Store task in localStorage for demo purposes
            let tasks = JSON.parse(localStorage.getItem('projectTasks') || '{}');
            if (!tasks[task.projectId]) {
                tasks[task.projectId] = [];
            }
            tasks[task.projectId].push(task);
            localStorage.setItem('projectTasks', JSON.stringify(tasks));
            
            // Close modal and reset form
            bootstrap.Modal.getInstance(document.getElementById('taskModal')).hide();
            form.reset();
            
            showAlert('Task created successfully!', 'success');
        }

        function addRisk(projectId) {
            const project = projects.find(p => p.id === projectId);
            if (!project) return;
            
            const title = prompt('Enter risk title:');
            if (!title) return;
            
            const description = prompt('Enter risk description:');
            if (!description) return;
            
            const severity = prompt('Severity (low/medium/high):');
            if (!severity || !['low', 'medium', 'high'].includes(severity.toLowerCase())) return;
            
            const mitigation = prompt('Mitigation strategy:');
            
            const risk = {
                id: Date.now(),
                title: title,
                description: description,
                severity: severity.toLowerCase(),
                mitigation: mitigation,
                createdAt: new Date().toISOString()
            };
            
            project.risks.push(risk);
            
            // Update the display if modal is open
            const risksDiv = document.getElementById(`risks-${projectId}`);
            if (risksDiv) {
                risksDiv.innerHTML = renderRisks(project.risks);
            }
            
            showAlert('Risk added successfully!', 'success');
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.top = '20px';
            alertDiv.style.right = '20px';
            alertDiv.style.zIndex = '9999';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 3000);
        }

        // Initialize template data from the backend
        // window.templateProjects is already set from the template: {{ projects | tojson }}
        
        // Debug: Log the template data
        console.log('Projects page loaded. Template data:', window.templateProjects);
        
        // Debug: Test if functions are accessible
        console.log('viewProjectDetails function:', typeof viewProjectDetails);
        
        // Debug: Test button click
        function testButtonClick() {
            console.log('Button click test function called');
            alert('Button click is working!');
        }

        async function generateAIPlan(projectId) {
            const projectData = window.templateProjects.find(p => p.id === projectId);
            if (!projectData) return;
            
            // Show loading state
            showAlert('Generating AI Plan...', 'info');
            
            try {
                // Call the real AI endpoint
                const params = new URLSearchParams({
                    project_id: projectId.toString()
                });
                
                const response = await fetch(`/api/v1/ai-first/autoplan?${params}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        document_content: `Project: ${projectData.name}\nDescription: ${projectData.description || 'AI-First Project Management System'}`,
                        constraints: {
                            max_duration_weeks: 16,
                            max_budget: 500000,
                            team_size: 5
                        }
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    // Update the project plan section with real AI data
                    const planSection = document.querySelector(`#projectDetailsContent .card:last-child .card-body`);
                    if (planSection) {
                        planSection.innerHTML = generateRealAIPlan(result.data, projectData);
                    }
                    
                    showAlert('AI Plan generated successfully!', 'success');
                } else {
                    throw new Error(result.error || 'AI planning failed');
                }
                
            } catch (error) {
                console.error('AI Plan generation error:', error);
                
                // Fallback to sample plan if AI fails
                showAlert('AI service unavailable, using sample plan', 'warning');
                const aiPlan = generateSampleAIPlan(projectData);
                
                const planSection = document.querySelector(`#projectDetailsContent .card:last-child .card-body`);
                if (planSection) {
                    planSection.innerHTML = aiPlan;
                }
            }
        }
        
        function generateRealAIPlan(aiData, project) {
            // Handle real AI response data
            let html = `
                <div class="ai-plan">
                    <h6 class="text-primary mb-3">AI-Generated Project Plan</h6>
                    <div class="mb-3">
                        <strong>Project:</strong> ${project.name}<br>
                        <strong>AI Confidence:</strong> <span class="badge bg-success">${aiData.confidence_score || '85%'}</span><br>
                        <strong>Generated At:</strong> ${new Date().toLocaleString()}
                    </div>`;
            
            if (aiData.wbs && aiData.wbs.phases) {
                html += `<div class="phases">`;
                
                aiData.wbs.phases.forEach((phase, index) => {
                    html += `
                        <div class="phase mb-3 p-3 border rounded">
                            <h6 class="mb-2">Phase ${index + 1}: ${phase.name}</h6>
                            <p class="text-muted mb-2">Duration: ${phase.duration}</p>
                            <ul class="mb-0">
                                ${phase.tasks.map(task => `<li>${task.title} (${task.estimated_hours}h)</li>`).join('')}
                            </ul>
                        </div>`;
                });
                
                html += `</div>`;
            } else {
                html += `<p class="text-muted">AI plan structure not available</p>`;
            }
            
            html += `
                <div class="mt-3">
                    <button class="btn btn-sm btn-outline-success me-2" onclick="approveAIPlan(${project.id})">
                        <i class="fas fa-check"></i> Approve Plan
                    </button>
                    <button class="btn btn-sm btn-outline-warning me-2" onclick="refineAIPlan(${project.id})">
                        <i class="fas fa-edit"></i> Refine Plan
                    </button>
                    <button class="btn btn-sm btn-outline-info" onclick="exportAIPlan(${project.id})">
                        <i class="fas fa-download"></i> Export
                    </button>
                </div>
            </div>`;
            
            return html;
        }

        function generateSampleAIPlan(project) {
            const phases = [
                { name: 'Planning & Analysis', duration: '2 weeks', tasks: ['Requirements gathering', 'Stakeholder interviews', 'Technical feasibility study'] },
                { name: 'Design & Architecture', duration: '3 weeks', tasks: ['System architecture design', 'Database schema design', 'UI/UX mockups'] },
                { name: 'Development', duration: '6 weeks', tasks: ['Core functionality development', 'Integration development', 'Unit testing'] },
                { name: 'Testing & QA', duration: '2 weeks', tasks: ['Integration testing', 'User acceptance testing', 'Performance testing'] },
                { name: 'Deployment', duration: '1 week', tasks: ['Production deployment', 'User training', 'Go-live support'] }
            ];
            
            let html = `
                <div class="ai-plan">
                    <h6 class="text-primary mb-3">AI-Generated Project Plan</h6>
                    <div class="mb-3">
                        <strong>Project:</strong> ${project.name}<br>
                        <strong>Estimated Duration:</strong> 14 weeks<br>
                        <strong>Total Effort:</strong> 560 hours<br>
                        <strong>Confidence Score:</strong> <span class="badge bg-success">85%</span>
                    </div>
                    <div class="phases">`;
            
            phases.forEach((phase, index) => {
                html += `
                    <div class="phase mb-3 p-3 border rounded">
                        <h6 class="mb-2">Phase ${index + 1}: ${phase.name}</h6>
                        <p class="text-muted mb-2">Duration: ${phase.duration}</p>
                        <ul class="mb-0">
                            ${phase.tasks.map(task => `<li>${task}</li>`).join('')}
                        </ul>
                    </div>`;
            });
            
            html += `
                    </div>
                    <div class="mt-3">
                        <button class="btn btn-sm btn-outline-success me-2" onclick="approveAIPlan(${project.id})">
                            <i class="fas fa-check"></i> Approve Plan
                        </button>
                        <button class="btn btn-sm btn-outline-warning me-2" onclick="refineAIPlan(${project.id})">
                            <i class="fas fa-edit"></i> Refine Plan
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="exportAIPlan(${project.id})">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                </div>`;
            
            return html;
        }
        
        function approveAIPlan(projectId) {
            showAlert('AI Plan approved! Creating tasks and schedule...', 'success');
            // Here you would integrate with the backend to create actual tasks
        }
        
        function refineAIPlan(projectId) {
            showAlert('AI Plan refinement coming soon!', 'info');
        }
        
        function exportAIPlan(projectId) {
            showAlert('AI Plan export coming soon!', 'info');
        }
        
        function showQuickImport(projectId) {
            // Store the project ID for the import
            window.currentImportProjectId = projectId;
            
            // Show the quick import modal
            const quickImportModal = new bootstrap.Modal(document.getElementById('quickImportModal'));
            quickImportModal.show();
        }
        
        function processQuickImport() {
            const text = document.getElementById('quickImportText').value.trim();
            if (!text) {
                showAlert('Please enter some tasks to import', 'warning');
                return;
            }
            
            const projectId = window.currentImportProjectId;
            const defaultPriority = document.getElementById('defaultPriority').value;
            const defaultAssignee = document.getElementById('defaultAssignee').value;
            
            // Show processing state
            showAlert('Processing tasks with AI...', 'info');
            
            // Simulate AI processing
            setTimeout(() => {
                const tasks = parseTasksWithAI(text, defaultPriority, defaultAssignee);
                
                // Store the imported tasks
                let allTasks = JSON.parse(localStorage.getItem('projectTasks') || '{}');
                if (!allTasks[projectId]) {
                    allTasks[projectId] = [];
                }
                allTasks[projectId].push(...tasks);
                localStorage.setItem('projectTasks', JSON.stringify(allTasks));
                
                // Close modal and show success
                bootstrap.Modal.getInstance(document.getElementById('quickImportModal')).hide();
                document.getElementById('quickImportText').value = '';
                
                showAlert(`Successfully imported ${tasks.length} tasks!`, 'success');
                
                // Refresh the project details if open
                const projectDetailsModal = document.getElementById('projectDetailsModal');
                if (projectDetailsModal.classList.contains('show')) {
                    viewProjectDetails(projectId);
                }
            }, 2000);
        }
        
        function parseTasksWithAI(text, defaultPriority, defaultAssignee) {
            // Parse the input text (simulating AI processing)
            const lines = text.split('\n').filter(line => line.trim());
            const tasks = [];
            
            lines.forEach((line, index) => {
                // Clean up the line
                let cleanLine = line.trim();
                if (cleanLine.startsWith('â€¢')) cleanLine = cleanLine.substring(1).trim();
                if (cleanLine.startsWith('-')) cleanLine = cleanLine.substring(1).trim();
                if (cleanLine.startsWith('*')) cleanLine = cleanLine.substring(1).trim();
                
                if (cleanLine) {
                    const task = {
                        id: Date.now() + index,
                        projectId: window.currentImportProjectId,
                        title: cleanLine,
                        description: `Imported task: ${cleanLine}`,
                        priority: defaultPriority,
                        assignedTo: defaultAssignee,
                        status: 'pending',
                        estimatedHours: Math.floor(Math.random() * 8) + 2, // Random 2-10 hours
                        createdAt: new Date().toISOString()
                    };
                    tasks.push(task);
                }
            });
            
            return tasks;
        }

        // Initialize - using template data
        console.log('Projects page loaded with template data');
    </script>
</body>
</html>
