<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Projects - Project Portfolio Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .timeline {
            position: relative;
            padding: 20px 0;
        }
        .timeline-item {
            position: relative;
            padding-left: 30px;
            margin-bottom: 20px;
        }
        .timeline-marker {
            position: absolute;
            left: 0;
            top: 0;
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        .timeline-content {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        .timeline-content h6 {
            margin-bottom: 5px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">ðŸš€ PPM System</a>
            <div class="navbar-nav">
                <a class="nav-link" href="/web/dashboard">Dashboard</a>
                <a class="nav-link active" href="/web/projects">Projects</a>
                <a class="nav-link" href="/web/resources">Resources</a>
                <a class="nav-link" href="/web/finance">Finance</a>
                <a class="nav-link" href="/web/ai-copilot">AI Copilot</a>
                <a class="nav-link" href="/web/alerts">Alerts</a>
                <a class="nav-link" href="/web/reports">Reports</a>
                <a class="nav-link" href="/web/admin">Admin</a>
                <a class="nav-link" href="/web/developer-workbench">Developer</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center">
            <h1>ðŸ“‹ Projects</h1>
            <div>
                <a href="/web/project-plan-creator" class="btn btn-success me-2">
                    <i class="fas fa-project-diagram"></i> Create Plan
                </a>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newProjectModal">
                    <i class="fas fa-plus"></i> New Project
                </button>
            </div>
        </div>
        
        <!-- Project List -->
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Project List</h5>
                    </div>
                    <div class="card-body">
                                <div id="projectList">
            {% if projects %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Project</th>
                                <th>Manager</th>
                                <th>Status</th>
                                <th>Priority</th>
                                <th>Progress</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for project in projects %}
                            <tr>
                                <td>
                                    <strong>{{ project.name }}</strong><br>
                                    <small class="text-muted">{{ project.code or 'N/A' }}</small>
                                </td>
                                <td>{{ project.project_manager_id or 'N/A' }}</td>
                                <td><span class="badge bg-primary">{{ project.status }}</span></td>
                                <td><span class="badge bg-warning">{{ project.priority }}</span></td>
                                <td>
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar" role="progressbar" style="width: 75%">75%</div>
                                    </div>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" onclick="viewProjectDetails({{ project.id }})">
                                        <i class="fas fa-eye"></i> View
                                    </button>
                                    <button class="btn btn-sm btn-outline-success" onclick="addTask({{ project.id }})">
                                        <i class="fas fa-plus"></i> Task
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="text-muted">No projects found. Create your first project to get started.</p>
                <!-- DEBUG: This means projects is empty or None -->
            {% endif %}
        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- New Project Modal -->
    <div class="modal fade" id="newProjectModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Project</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="newProjectForm">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label class="form-label">Project Name *</label>
                                    <input type="text" class="form-control" name="projectName" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Project Code</label>
                                    <input type="text" class="form-control" name="projectCode" placeholder="e.g., PRJ-001">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Start Date *</label>
                                    <input type="date" class="form-control" name="startDate" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">End Date</label>
                                    <input type="date" class="form-control" name="endDate">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Project Manager *</label>
                                    <input type="text" class="form-control" name="projectManager" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Priority</label>
                                    <select class="form-select" name="priority">
                                        <option value="low">Low</option>
                                        <option value="medium" selected>Medium</option>
                                        <option value="high">High</option>
                                        <option value="critical">Critical</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Budget ($)</label>
                                    <input type="number" class="form-control" name="budget" min="0" step="1000">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Status</label>
                                    <select class="form-select" name="status">
                                        <option value="planning">Planning</option>
                                        <option value="active" selected>Active</option>
                                        <option value="on_hold">On Hold</option>
                                        <option value="completed">Completed</option>
                                        <option value="cancelled">Cancelled</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" name="description" rows="3" placeholder="Project description and objectives..."></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Key Stakeholders (comma separated)</label>
                            <input type="text" class="form-control" name="stakeholders" placeholder="e.g., Client, Sponsor, Team Lead">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Technologies & Tools</label>
                            <input type="text" class="form-control" name="technologies" placeholder="e.g., Python, React, AWS, Docker">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveProject()">Create Project</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Project Details Modal -->
    <div class="modal fade" id="projectDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Project Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="projectDetailsContent">
                        <!-- Content will be populated dynamically -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Import Modal -->
    <div class="modal fade" id="quickImportModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Quick Task Import</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Paste your tasks (one per line, or comma-separated)</label>
                        <textarea class="form-control" id="quickImportText" rows="8" placeholder="Example:
â€¢ Design user interface
â€¢ Implement authentication
â€¢ Set up database
â€¢ Write unit tests

Or paste from Excel:
Task 1, Task 2, Task 3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Default Priority</label>
                        <select class="form-select" id="defaultPriority">
                            <option value="low">Low</option>
                            <option value="medium" selected>Medium</option>
                            <option value="high">High</option>
                            <option value="critical">Critical</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Default Assignee</label>
                        <select class="form-select" id="defaultAssignee">
                            <option value="">Select Assignee</option>
                            <option value="john@company.com">John Developer</option>
                            <option value="sarah@company.com">Sarah Designer</option>
                            <option value="mike@company.com">Mike Architect</option>
                            <option value="lisa@company.com">Lisa Tester</option>
                            <option value="alex@company.com">Alex DevOps</option>
                        </select>
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>AI-Powered Import:</strong> The system will automatically parse your input and create structured tasks with estimated effort and dependencies.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="processQuickImport()">
                        <i class="fas fa-magic"></i> Process with AI
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Task Creation Modal -->
    <div class="modal fade" id="taskModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Task</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="taskForm">
                        <input type="hidden" id="taskProjectId" name="projectId">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label class="form-label">Task Title *</label>
                                    <input type="text" class="form-control" name="taskTitle" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Priority</label>
                                    <select class="form-select" name="taskPriority">
                                        <option value="low">Low</option>
                                        <option value="medium" selected>Medium</option>
                                        <option value="high">High</option>
                                        <option value="critical">Critical</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Start Date</label>
                                    <input type="date" class="form-control" name="taskStartDate">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="label">Due Date</label>
                                    <input type="date" class="form-control" name="taskDueDate">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Assigned To</label>
                                    <select class="form-select" name="taskAssignee">
                                        <option value="">Select Assignee</option>
                                        <option value="john@company.com">John Developer</option>
                                        <option value="sarah@company.com">Sarah Designer</option>
                                        <option value="mike@company.com">Mike Architect</option>
                                        <option value="lisa@company.com">Lisa Tester</option>
                                        <option value="alex@company.com">Alex DevOps</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Estimated Hours</label>
                                    <input type="number" class="form-control" name="taskHours" min="1" step="0.5">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" name="taskDescription" rows="3" placeholder="Describe the task requirements..."></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Dependencies</label>
                            <input type="text" class="form-control" name="taskDependencies" placeholder="Task IDs separated by commas (e.g., 1,3,5)">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveTask()">Create Task</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Store projects data for JavaScript access
        window.templateProjects = {{ projects | tojson }};
        
        let projects = [];
        let currentProjectId = 0;

        function saveProject() {
            const form = document.getElementById('newProjectForm');
            const formData = new FormData(form);
            
            const project = {
                id: ++currentProjectId,
                name: formData.get('projectName'),
                code: formData.get('projectCode') || `PRJ-${String(currentProjectId).padStart(3, '0')}`,
                startDate: formData.get('startDate'),
                endDate: formData.get('endDate'),
                projectManager: formData.get('projectManager'),
                priority: formData.get('priority'),
                budget: parseFloat(formData.get('budget')) || 0,
                status: formData.get('status'),
                description: formData.get('description'),
                stakeholders: formData.get('stakeholders').split(',').map(s => s.trim()).filter(s => s),
                technologies: formData.get('technologies').split(',').map(t => t.trim()).filter(t => t),
                createdAt: new Date().toISOString(),
                tasks: [],
                risks: [],
                milestones: []
            };
            
            projects.push(project);
            // updateProjectList(); // Disabled - using template data
            
            // Close modal and reset form
            bootstrap.Modal.getInstance(document.getElementById('newProjectModal')).hide();
            form.reset();
            
            // Show success message
            showAlert('Project created successfully!', 'success');
        }

        function updateProjectList() {
            // This function is now disabled - using template data instead
            console.log('updateProjectList called - using template data');
        }

        function calculateProgress(project) {
            if (project.tasks.length === 0) return 0;
            const completedTasks = project.tasks.filter(task => task.status === 'completed').length;
            return Math.round((completedTasks / project.tasks.length) * 100);
        }

        function getStatusClass(status) {
            const classes = {
                'planning': 'bg-secondary',
                'active': 'bg-primary',
                'on_hold': 'bg-warning',
                'completed': 'bg-success',
                'cancelled': 'bg-danger'
            };
            return classes[status] || 'bg-secondary';
        }

        function getPriorityClass(priority) {
            const classes = {
                'low': 'bg-success',
                'medium': 'bg-primary',
                'high': 'bg-warning',
                'critical': 'bg-danger'
            };
            return classes[priority] || 'bg-secondary';
        }

        function viewProjectDetails(projectId) {
            console.log('viewProjectDetails called with projectId:', projectId);
            console.log('templateProjects:', window.templateProjects);
            
            // Get project data from the template (stored in a global variable)
            const projectData = window.templateProjects ? window.templateProjects.find(p => p.id === projectId) : null;
            if (!projectData) {
                showAlert('Project data not found', 'danger');
                return;
            }
            
            // Get tasks from localStorage
            const tasks = JSON.parse(localStorage.getItem('projectTasks') || '{}')[projectId] || [];
            
            const content = document.getElementById('projectDetailsContent');
            
            content.innerHTML = `
                <div class="row">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h6>Project Information</h6>
                            </div>
                            <div class="card-body">
                                <p><strong>Name:</strong> ${projectData.name}</p>
                                <p><strong>Code:</strong> ${projectData.code}</p>
                                <p><strong>Manager:</strong> ${projectData.project_manager_id}</p>
                                <p><strong>Status:</strong> <span class="badge ${getStatusClass(projectData.status)}">${projectData.status}</span></p>
                                <p><strong>Priority:</strong> <span class="badge ${getPriorityClass(projectData.priority)}">${projectData.priority}</span></p>
                                <p><strong>Progress:</strong> ${projectData.progress || 75}%</p>
                                <p><strong>Budget:</strong> $${projectData.budget ? projectData.budget.toLocaleString() : 'N/A'}</p>
                                <p><strong>Start Date:</strong> ${projectData.start_date || 'N/A'}</p>
                                <p><strong>End Date:</strong> ${projectData.end_date || 'N/A'}</p>
                            </div>
                        </div>
                        
                        <div class="card mt-3">
                            <div class="card-header">
                                <h6>Progress Overview</h6>
                            </div>
                            <div class="card-body text-center">
                                <h2 class="text-primary">${projectData.progress || 75}%</h2>
                                <p class="text-muted">Complete</p>
                                <div class="row text-center">
                                    <div class="col-4">
                                        <h5>${tasks.length}</h5>
                                        <small>Total Tasks</small>
                                    </div>
                                    <div class="col-4">
                                        <h5>${tasks.filter(t => t.status === 'completed').length}</h5>
                                        <small>Completed</small>
                                    </div>
                                    <div class="col-4">
                                        <h5>0</h5>
                                        <small>Risks</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-8">
                        <!-- Project Tabs -->
                        <div class="card">
                            <div class="card-header">
                                <ul class="nav nav-tabs card-header-tabs" id="projectTabs-${projectId}">
                                    <li class="nav-item">
                                        <a class="nav-link active" data-bs-toggle="tab" href="#tasks-${projectId}">
                                            <i class="fas fa-tasks"></i> Tasks
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" data-bs-toggle="tab" href="#dependencies-${projectId}">
                                            <i class="fas fa-project-diagram"></i> Dependencies
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" data-bs-toggle="tab" href="#risks-${projectId}">
                                            <i class="fas fa-exclamation-triangle"></i> Risks
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" data-bs-toggle="tab" href="#files-${projectId}">
                                            <i class="fas fa-file"></i> Files
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" data-bs-toggle="tab" href="#history-${projectId}">
                                            <i class="fas fa-history"></i> History
                                        </a>
                                    </li>
                                </ul>
                            </div>
                            <div class="card-body">
                                <div class="tab-content">
                                    <!-- Tasks Tab -->
                                    <div class="tab-pane fade show active" id="tasks-${projectId}">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h6>Project Tasks</h6>
                                            <div>
                                                <button class="btn btn-sm btn-outline-secondary me-2" onclick="showQuickImport(${projectId})">
                                                    <i class="fas fa-paste"></i> Quick Import
                                                </button>
                                                <button class="btn btn-sm btn-success me-2" onclick="generateAITasks(${projectId})">
                                                    <i class="fas fa-magic"></i> Generate AI Tasks
                                                </button>
                                                <button class="btn btn-sm btn-primary" onclick="addTask(${projectId})">
                                                    <i class="fas fa-plus"></i> Add Task
                                                </button>
                                            </div>
                                        </div>
                                        <div id="tasks-content-${projectId}">
                                            ${projectData.status === 'active' ? renderActiveProjectTasks(projectData) : renderTasks(tasks)}
                                        </div>
                                    </div>
                                    
                                    <!-- Dependencies Tab -->
                                    <div class="tab-pane fade" id="dependencies-${projectId}">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h6>Task Dependencies</h6>
                                            <div>
                                                <button class="btn btn-sm btn-info me-2" onclick="showAIDependencyAnalysis(${projectId})">
                                                    <i class="fas fa-robot"></i> AI Analysis
                                                </button>
                                                <button class="btn btn-sm btn-success" onclick="showDependencyVisualization(${projectId})">
                                                    <i class="fas fa-project-diagram"></i> Visualize
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <!-- AI Dependency Analysis Panel -->
                                        <div id="aiDependencyPanel-${projectId}" class="card mb-4" style="display: none;">
                                            <div class="card-header bg-info text-white">
                                                <h6 class="mb-0"><i class="fas fa-robot"></i> AI Dependency Analysis</h6>
                                            </div>
                                            <div class="card-body">
                                                <div id="aiDependencyContent-${projectId}">
                                                    <!-- AI analysis content will be loaded here -->
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Dependency Conflicts Alert -->
                                        <div id="dependencyConflicts-${projectId}" class="alert alert-warning" style="display: none;">
                                            <h6><i class="fas fa-exclamation-triangle"></i> Dependency Conflicts Detected</h6>
                                            <div id="conflictsList-${projectId}">
                                                <!-- Conflicts will be loaded here -->
                                            </div>
                                        </div>
                                        
                                        <!-- Critical Path Analysis -->
                                        <div class="card mb-3">
                                            <div class="card-header">
                                                <h6 class="mb-0"><i class="fas fa-route"></i> Critical Path Analysis</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <h6>Critical Path</h6>
                                                        <div class="critical-path">
                                                            <span class="badge bg-danger me-1">Setup Environment</span>
                                                            <i class="fas fa-arrow-right mx-2"></i>
                                                            <span class="badge bg-danger me-1">Database Design</span>
                                                            <i class="fas fa-arrow-right mx-2"></i>
                                                            <span class="badge bg-danger me-1">API Development</span>
                                                            <i class="fas fa-arrow-right mx-2"></i>
                                                            <span class="badge bg-danger me-1">Testing</span>
                                                            <i class="fas fa-arrow-right mx-2"></i>
                                                            <span class="badge bg-danger">Deployment</span>
                                                        </div>
                                                        <p class="mt-2"><strong>Total Duration:</strong> 14 days</p>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <h6>Float Analysis</h6>
                                                        <ul class="list-unstyled">
                                                            <li><span class="badge bg-success">Frontend Development</span> - 2 days float</li>
                                                            <li><span class="badge bg-info">Documentation</span> - 3 days float</li>
                                                            <li><span class="badge bg-warning">User Training</span> - 1 day float</li>
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="table-responsive">
                                            <table class="table table-sm">
                                                <thead>
                                                    <tr>
                                                        <th>Task</th>
                                                        <th>Depends On</th>
                                                        <th>Duration</th>
                                                        <th>Critical Path</th>
                                                        <th>Status</th>
                                                        <th>Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="dependenciesTableBody-${projectId}">
                                                    <tr>
                                                        <td>Setup Development Environment</td>
                                                        <td>-</td>
                                                        <td>2 days</td>
                                                        <td><span class="badge bg-danger">Yes</span></td>
                                                        <td><span class="badge bg-success">Completed</span></td>
                                                        <td>
                                                            <button class="btn btn-sm btn-outline-primary" onclick="analyzeTaskDependencies('task_1', 'Setup Development Environment', ${projectId})">
                                                                <i class="fas fa-robot"></i> Analyze
                                                            </button>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td>Database Design</td>
                                                        <td>Setup Development Environment</td>
                                                        <td>3 days</td>
                                                        <td><span class="badge bg-danger">Yes</span></td>
                                                        <td><span class="badge bg-warning">In Progress</span></td>
                                                        <td>
                                                            <button class="btn btn-sm btn-outline-primary" onclick="analyzeTaskDependencies('task_2', 'Database Design', ${projectId})">
                                                                <i class="fas fa-robot"></i> Analyze
                                                            </button>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td>API Development</td>
                                                        <td>Database Design</td>
                                                        <td>5 days</td>
                                                        <td><span class="badge bg-danger">Yes</span></td>
                                                        <td><span class="badge bg-secondary">Pending</span></td>
                                                        <td>
                                                            <button class="btn btn-sm btn-outline-primary" onclick="analyzeTaskDependencies('task_3', 'API Development', ${projectId})">
                                                                <i class="fas fa-robot"></i> Analyze
                                                            </button>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td>Frontend Development</td>
                                                        <td>API Development</td>
                                                        <td>4 days</td>
                                                        <td><span class="badge bg-secondary">No</span></td>
                                                        <td><span class="badge bg-secondary">Pending</span></td>
                                                        <td>
                                                            <button class="btn btn-sm btn-outline-primary" onclick="analyzeTaskDependencies('task_4', 'Frontend Development', ${projectId})">
                                                                <i class="fas fa-robot"></i> Analyze
                                                            </button>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    
                                    <!-- Risks Tab -->
                                    <div class="tab-pane fade" id="risks-${projectId}">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h6>Project Risks</h6>
                                            <div>
                                                <button class="btn btn-sm btn-warning me-2" onclick="addRisk(${projectId})">
                                                    <i class="fas fa-plus"></i> Add Risk
                                                </button>
                                                <button class="btn btn-sm btn-info" onclick="showAIRiskAnalysis(${projectId})">
                                                    <i class="fas fa-robot"></i> AI Risk Analysis
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <!-- AI Risk Mitigation Panel -->
                                        <div id="aiRiskMitigationPanel-${projectId}" class="card mb-4" style="display: none;">
                                            <div class="card-header bg-info text-white">
                                                <h6 class="mb-0"><i class="fas fa-robot"></i> AI Risk Mitigation Analysis</h6>
                                            </div>
                                            <div class="card-body">
                                                <div id="aiRiskAnalysisContent-${projectId}">
                                                    <!-- AI analysis content will be loaded here -->
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="table-responsive">
                                            <table class="table table-sm">
                                                <thead>
                                                    <tr>
                                                        <th>Risk</th>
                                                        <th>Probability</th>
                                                        <th>Impact</th>
                                                        <th>Mitigation</th>
                                                        <th>Status</th>
                                                        <th>Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="risksTableBody-${projectId}">
                                                    <tr>
                                                        <td>Key developer leaves</td>
                                                        <td><span class="badge bg-warning">Medium</span></td>
                                                        <td><span class="badge bg-danger">High</span></td>
                                                        <td>Cross-training, documentation</td>
                                                        <td><span class="badge bg-warning">Active</span></td>
                                                        <td>
                                                            <button class="btn btn-sm btn-outline-primary" onclick="generateAIMitigationPlan('risk_1', 'Key developer leaves', 'Critical team member may leave during project execution', 'medium', 'high', ${projectId})">
                                                                <i class="fas fa-robot"></i> AI Plan
                                                            </button>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td>Technology stack changes</td>
                                                        <td><span class="badge bg-success">Low</span></td>
                                                        <td><span class="badge bg-warning">Medium</span></td>
                                                        <td>Flexible architecture</td>
                                                        <td><span class="badge bg-success">Mitigated</span></td>
                                                        <td>
                                                            <button class="btn btn-sm btn-outline-primary" onclick="generateAIMitigationPlan('risk_2', 'Technology stack changes', 'Required technology may change or become unavailable', 'low', 'medium', ${projectId})">
                                                                <i class="fas fa-robot"></i> AI Plan
                                                            </button>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td>Scope creep</td>
                                                        <td><span class="badge bg-warning">Medium</span></td>
                                                        <td><span class="badge bg-warning">Medium</span></td>
                                                        <td>Change control process</td>
                                                        <td><span class="badge bg-warning">Active</span></td>
                                                        <td>
                                                            <button class="btn btn-sm btn-outline-primary" onclick="generateAIMitigationPlan('risk_3', 'Scope creep', 'Project scope may expand beyond original requirements', 'medium', 'medium', ${projectId})">
                                                                <i class="fas fa-robot"></i> AI Plan
                                                            </button>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    
                                    <!-- Files Tab -->
                                    <div class="tab-pane fade" id="files-${projectId}">
                                        <h6>Project Files</h6>
                                        <div class="mb-3">
                                            <button class="btn btn-sm btn-primary" onclick="uploadFile(${projectId})">
                                                <i class="fas fa-upload"></i> Upload File
                                            </button>
                                        </div>
                                        <div class="table-responsive">
                                            <table class="table table-sm">
                                                <thead>
                                                    <tr>
                                                        <th>File Name</th>
                                                        <th>Type</th>
                                                        <th>Size</th>
                                                        <th>Uploaded By</th>
                                                        <th>Date</th>
                                                        <th>Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr>
                                                        <td><i class="fas fa-file-pdf text-danger"></i> Project_Requirements.pdf</td>
                                                        <td>PDF</td>
                                                        <td>2.3 MB</td>
                                                        <td>john.doe@company.com</td>
                                                        <td>2024-01-10</td>
                                                        <td>
                                                            <button class="btn btn-sm btn-outline-primary">Download</button>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td><i class="fas fa-file-word text-primary"></i> Technical_Spec.docx</td>
                                                        <td>Word</td>
                                                        <td>1.8 MB</td>
                                                        <td>sarah.lead@company.com</td>
                                                        <td>2024-01-12</td>
                                                        <td>
                                                            <button class="btn btn-sm btn-outline-primary">Download</button>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td><i class="fas fa-file-excel text-success"></i> Budget_Plan.xlsx</td>
                                                        <td>Excel</td>
                                                        <td>856 KB</td>
                                                        <td>mike.director@company.com</td>
                                                        <td>2024-01-14</td>
                                                        <td>
                                                            <button class="btn btn-sm btn-outline-primary">Download</button>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    
                                    <!-- History Tab -->
                                    <div class="tab-pane fade" id="history-${projectId}">
                                        <h6>Project History</h6>
                                        <div class="timeline">
                                            <div class="timeline-item">
                                                <div class="timeline-marker bg-success"></div>
                                                <div class="timeline-content">
                                                    <h6>Project Created</h6>
                                                    <p class="text-muted">Project ${projectData.name} was created by ${projectData.project_manager_id}</p>
                                                    <small class="text-muted">2024-01-15 09:00:00</small>
                                                </div>
                                            </div>
                                            <div class="timeline-item">
                                                <div class="timeline-marker bg-info"></div>
                                                <div class="timeline-content">
                                                    <h6>Requirements Documented</h6>
                                                    <p class="text-muted">Project requirements were documented and approved</p>
                                                    <small class="text-muted">2024-01-16 14:30:00</small>
                                                </div>
                                            </div>
                                            <div class="timeline-item">
                                                <div class="timeline-marker bg-warning"></div>
                                                <div class="timeline-content">
                                                    <h6>Risk Identified</h6>
                                                    <p class="text-muted">Key developer departure risk was identified</p>
                                                    <small class="text-muted">2024-01-17 11:15:00</small>
                                                </div>
                                            </div>
                                            <div class="timeline-item">
                                                <div class="timeline-marker bg-primary"></div>
                                                <div class="timeline-content">
                                                    <h6>Development Started</h6>
                                                    <p class="text-muted">Development phase officially started</p>
                                                    <small class="text-muted">2024-01-18 08:00:00</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card mt-3">
                            <div class="card-header">
                                <h6>Project Plan</h6>
                            </div>
                            <div class="card-body">
                                <p class="text-muted">AI-generated project plan will be displayed here.</p>
                                <button class="btn btn-sm btn-outline-primary" onclick="generateAIPlan(${projectId})">
                                    <i class="fas fa-magic"></i> Generate AI Plan
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Show the modal using Bootstrap 5 API
            const modal = new bootstrap.Modal(document.getElementById('projectDetailsModal'));
            modal.show();
        }

        function renderTasks(tasks) {
            if (tasks.length === 0) {
                return '<p class="text-muted">No tasks created yet.</p>';
            }
            
            let html = '';
            tasks.forEach(task => {
                const statusClass = task.status === 'completed' ? 'bg-success' : 
                                  task.status === 'in_progress' ? 'bg-primary' : 'bg-secondary';
                
                html += `
                    <div class="border-bottom pb-2 mb-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <strong>${task.title}</strong>
                            <span class="badge ${statusClass}">${task.status}</span>
                        </div>
                        <p class="mb-1">${task.description}</p>
                        <small class="text-muted">Assigned to: ${task.assignedTo || 'Unassigned'} | Due: ${task.dueDate || 'No due date'}</small>
                    </div>
                `;
            });
            return html;
        }

        function renderRisks(risks) {
            if (risks.length === 0) {
                return '<p class="text-muted">No risks identified yet.</p>';
            }
            
            let html = '';
            risks.forEach(risk => {
                const severityClass = risk.severity === 'high' ? 'bg-danger' : 
                                    risk.severity === 'medium' ? 'bg-warning' : 'bg-info';
                
                html += `
                    <div class="border-bottom pb-2 mb-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <strong>${risk.title}</strong>
                            <span class="badge ${severityClass}">${risk.severity}</span>
                        </div>
                        <p class="mb-1">${risk.description}</p>
                        <small class="text-muted">Mitigation: ${risk.mitigation || 'No mitigation plan'}</small>
                    </div>
                `;
            });
            return html;
        }

        function addTask(projectId) {
            // Set the project ID in the hidden field
            document.getElementById('taskProjectId').value = projectId;
            
            // Show the task creation modal
            const taskModal = new bootstrap.Modal(document.getElementById('taskModal'));
            taskModal.show();
        }

        function saveTask() {
            const form = document.getElementById('taskForm');
            const formData = new FormData(form);
            
            const task = {
                id: Date.now(),
                projectId: parseInt(formData.get('projectId')),
                title: formData.get('taskTitle'),
                description: formData.get('taskDescription'),
                priority: formData.get('taskPriority'),
                assignedTo: formData.get('taskAssignee'),
                startDate: formData.get('taskStartDate'),
                dueDate: formData.get('taskDueDate'),
                estimatedHours: parseFloat(formData.get('taskHours')) || 0,
                dependencies: formData.get('taskDependencies').split(',').map(d => d.trim()).filter(d => d),
                status: 'pending',
                createdAt: new Date().toISOString()
            };
            
            // Store task in localStorage for demo purposes
            let tasks = JSON.parse(localStorage.getItem('projectTasks') || '{}');
            if (!tasks[task.projectId]) {
                tasks[task.projectId] = [];
            }
            tasks[task.projectId].push(task);
            localStorage.setItem('projectTasks', JSON.stringify(tasks));
            
            // Close modal and reset form
            bootstrap.Modal.getInstance(document.getElementById('taskModal')).hide();
            form.reset();
            
            showAlert('Task created successfully!', 'success');
        }

        function addRisk(projectId) {
            const project = projects.find(p => p.id === projectId);
            if (!project) return;
            
            const title = prompt('Enter risk title:');
            if (!title) return;
            
            const description = prompt('Enter risk description:');
            if (!description) return;
            
            const severity = prompt('Severity (low/medium/high):');
            if (!severity || !['low', 'medium', 'high'].includes(severity.toLowerCase())) return;
            
            const mitigation = prompt('Mitigation strategy:');
            
            const risk = {
                id: Date.now(),
                title: title,
                description: description,
                severity: severity.toLowerCase(),
                mitigation: mitigation,
                createdAt: new Date().toISOString()
            };
            
            project.risks.push(risk);
            
            // Update the display if modal is open
            const risksDiv = document.getElementById(`risks-${projectId}`);
            if (risksDiv) {
                risksDiv.innerHTML = renderRisks(project.risks);
            }
            
            showAlert('Risk added successfully!', 'success');
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.top = '20px';
            alertDiv.style.right = '20px';
            alertDiv.style.zIndex = '9999';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 3000);
        }

        // Initialize template data from the backend
        // window.templateProjects is already set from the template: {{ projects | tojson }}
        
        // Debug: Log the template data
        console.log('Projects page loaded. Template data:', window.templateProjects);
        
        // Debug: Test if functions are accessible
        console.log('viewProjectDetails function:', typeof viewProjectDetails);
        
        // Debug: Test button click
        function testButtonClick() {
            console.log('Button click test function called');
            alert('Button click is working!');
        }

        async function generateAIPlan(projectId) {
            const projectData = window.templateProjects.find(p => p.id === projectId);
            if (!projectData) return;
            
            // Show loading state
            showAlert('Generating AI Plan...', 'info');
            
            try {
                // Call the real AI endpoint
                const params = new URLSearchParams({
                    project_id: projectId.toString()
                });
                
                const response = await fetch(`/api/v1/ai-first/autoplan?${params}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        document_content: `Project: ${projectData.name}\nDescription: ${projectData.description || 'AI-First Project Management System'}`,
                        constraints: {
                            max_duration_weeks: 16,
                            max_budget: 500000,
                            team_size: 5
                        }
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    // Update the project plan section with real AI data
                    const planSection = document.querySelector(`#projectDetailsContent .card:last-child .card-body`);
                    if (planSection) {
                        planSection.innerHTML = generateRealAIPlan(result.data, projectData);
                    }
                    
                    showAlert('AI Plan generated successfully!', 'success');
                } else {
                    throw new Error(result.error || 'AI planning failed');
                }
                
            } catch (error) {
                console.error('AI Plan generation error:', error);
                
                // Fallback to sample plan if AI fails
                showAlert('AI service unavailable, using sample plan', 'warning');
                const aiPlan = generateSampleAIPlan(projectData);
                
                const planSection = document.querySelector(`#projectDetailsContent .card:last-child .card-body`);
                if (planSection) {
                    planSection.innerHTML = aiPlan;
                }
            }
        }
        
        function generateRealAIPlan(aiData, project) {
            // Handle real AI response data
            let html = `
                <div class="ai-plan">
                    <h6 class="text-primary mb-3">AI-Generated Project Plan</h6>
                    <div class="mb-3">
                        <strong>Project:</strong> ${project.name}<br>
                        <strong>AI Confidence:</strong> <span class="badge bg-success">${aiData.confidence_score || '85%'}</span><br>
                        <strong>Generated At:</strong> ${new Date().toLocaleString()}
                    </div>`;
            
            if (aiData.wbs && aiData.wbs.phases) {
                html += `<div class="phases">`;
                
                aiData.wbs.phases.forEach((phase, index) => {
                    html += `
                        <div class="phase mb-3 p-3 border rounded">
                            <h6 class="mb-2">Phase ${index + 1}: ${phase.name}</h6>
                            <p class="text-muted mb-2">Duration: ${phase.duration}</p>
                            <ul class="mb-0">
                                ${phase.tasks.map(task => `<li>${task.title} (${task.estimated_hours}h)</li>`).join('')}
                            </ul>
                        </div>`;
                });
                
                html += `</div>`;
            } else {
                html += `<p class="text-muted">AI plan structure not available</p>`;
            }
            
            html += `
                <div class="mt-3">
                    <button class="btn btn-sm btn-outline-success me-2" onclick="approveAIPlan(${project.id})">
                        <i class="fas fa-check"></i> Approve Plan
                    </button>
                    <button class="btn btn-sm btn-outline-warning me-2" onclick="refineAIPlan(${project.id})">
                        <i class="fas fa-edit"></i> Refine Plan
                    </button>
                    <button class="btn btn-sm btn-outline-info" onclick="exportAIPlan(${project.id})">
                        <i class="fas fa-download"></i> Export
                    </button>
                </div>
            </div>`;
            
            return html;
        }

        function generateSampleAIPlan(project) {
            const phases = [
                { name: 'Planning & Analysis', duration: '2 weeks', tasks: ['Requirements gathering', 'Stakeholder interviews', 'Technical feasibility study'] },
                { name: 'Design & Architecture', duration: '3 weeks', tasks: ['System architecture design', 'Database schema design', 'UI/UX mockups'] },
                { name: 'Development', duration: '6 weeks', tasks: ['Core functionality development', 'Integration development', 'Unit testing'] },
                { name: 'Testing & QA', duration: '2 weeks', tasks: ['Integration testing', 'User acceptance testing', 'Performance testing'] },
                { name: 'Deployment', duration: '1 week', tasks: ['Production deployment', 'User training', 'Go-live support'] }
            ];
            
            let html = `
                <div class="ai-plan">
                    <h6 class="text-primary mb-3">AI-Generated Project Plan</h6>
                    <div class="mb-3">
                        <strong>Project:</strong> ${project.name}<br>
                        <strong>Estimated Duration:</strong> 14 weeks<br>
                        <strong>Total Effort:</strong> 560 hours<br>
                        <strong>Confidence Score:</strong> <span class="badge bg-success">85%</span>
                    </div>
                    <div class="phases">`;
            
            phases.forEach((phase, index) => {
                html += `
                    <div class="phase mb-3 p-3 border rounded">
                        <h6 class="mb-2">Phase ${index + 1}: ${phase.name}</h6>
                        <p class="text-muted mb-2">Duration: ${phase.duration}</p>
                        <ul class="mb-0">
                            ${phase.tasks.map(task => `<li>${task}</li>`).join('')}
                        </ul>
                    </div>`;
            });
            
            html += `
                    </div>
                    <div class="mt-3">
                        <button class="btn btn-sm btn-outline-success me-2" onclick="approveAIPlan(${project.id})">
                            <i class="fas fa-check"></i> Approve Plan
                        </button>
                        <button class="btn btn-sm btn-outline-warning me-2" onclick="refineAIPlan(${project.id})">
                            <i class="fas fa-edit"></i> Refine Plan
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="exportAIPlan(${project.id})">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                </div>`;
            
            return html;
        }
        
        function approveAIPlan(projectId) {
            showAlert('AI Plan approved! Creating tasks and schedule...', 'success');
            // Here you would integrate with the backend to create actual tasks
        }
        
        function refineAIPlan(projectId) {
            showAlert('AI Plan refinement coming soon!', 'info');
        }
        
        function exportAIPlan(projectId) {
            showAlert('AI Plan export coming soon!', 'info');
        }
        
        function showQuickImport(projectId) {
            // Store the project ID for the import
            window.currentImportProjectId = projectId;
            
            // Show the quick import modal
            const quickImportModal = new bootstrap.Modal(document.getElementById('quickImportModal'));
            quickImportModal.show();
        }
        
        function processQuickImport() {
            const text = document.getElementById('quickImportText').value.trim();
            if (!text) {
                showAlert('Please enter some tasks to import', 'warning');
                return;
            }
            
            const projectId = window.currentImportProjectId;
            const defaultPriority = document.getElementById('defaultPriority').value;
            const defaultAssignee = document.getElementById('defaultAssignee').value;
            
            // Show processing state
            showAlert('Processing tasks with AI...', 'info');
            
            // Simulate AI processing
            setTimeout(() => {
                const tasks = parseTasksWithAI(text, defaultPriority, defaultAssignee);
                
                // Store the imported tasks
                let allTasks = JSON.parse(localStorage.getItem('projectTasks') || '{}');
                if (!allTasks[projectId]) {
                    allTasks[projectId] = [];
                }
                allTasks[projectId].push(...tasks);
                localStorage.setItem('projectTasks', JSON.stringify(allTasks));
                
                // Close modal and show success
                bootstrap.Modal.getInstance(document.getElementById('quickImportModal')).hide();
                document.getElementById('quickImportText').value = '';
                
                showAlert(`Successfully imported ${tasks.length} tasks!`, 'success');
                
                // Refresh the project details if open
                const projectDetailsModal = document.getElementById('projectDetailsModal');
                if (projectDetailsModal.classList.contains('show')) {
                    viewProjectDetails(projectId);
                }
            }, 2000);
        }
        
        function parseTasksWithAI(text, defaultPriority, defaultAssignee) {
            // Parse the input text (simulating AI processing)
            const lines = text.split('\n').filter(line => line.trim());
            const tasks = [];
            
            lines.forEach((line, index) => {
                // Clean up the line
                let cleanLine = line.trim();
                if (cleanLine.startsWith('â€¢')) cleanLine = cleanLine.substring(1).trim();
                if (cleanLine.startsWith('-')) cleanLine = cleanLine.substring(1).trim();
                if (cleanLine.startsWith('*')) cleanLine = cleanLine.substring(1).trim();
                
                if (cleanLine) {
                    const task = {
                        id: Date.now() + index,
                        projectId: window.currentImportProjectId,
                        title: cleanLine,
                        description: `Imported task: ${cleanLine}`,
                        priority: defaultPriority,
                        assignedTo: defaultAssignee,
                        status: 'pending',
                        estimatedHours: Math.floor(Math.random() * 8) + 2, // Random 2-10 hours
                        createdAt: new Date().toISOString()
                    };
                    tasks.push(task);
                }
            });
            
            return tasks;
        }

        function renderActiveProjectTasks(projectData) {
            // For active projects, show a comprehensive task breakdown
            const activeProjectTasks = {
                'ALPHA Project': [
                    { id: 1, title: 'Requirements Analysis', status: 'completed', priority: 'high', assignedTo: 'John Developer', estimatedHours: 16, actualHours: 14, dueDate: '2024-01-20' },
                    { id: 2, title: 'System Architecture Design', status: 'in_progress', priority: 'high', assignedTo: 'Mike Architect', estimatedHours: 24, actualHours: 18, dueDate: '2024-01-25' },
                    { id: 3, title: 'Database Schema Design', status: 'in_progress', priority: 'medium', assignedTo: 'Sarah Designer', estimatedHours: 12, actualHours: 8, dueDate: '2024-01-28' },
                    { id: 4, title: 'API Development', status: 'pending', priority: 'high', assignedTo: 'John Developer', estimatedHours: 32, actualHours: 0, dueDate: '2024-02-05' },
                    { id: 5, title: 'Frontend Development', status: 'pending', priority: 'medium', assignedTo: 'Lisa Tester', estimatedHours: 28, actualHours: 0, dueDate: '2024-02-10' },
                    { id: 6, title: 'Testing & QA', status: 'pending', priority: 'medium', assignedTo: 'Alex DevOps', estimatedHours: 20, actualHours: 0, dueDate: '2024-02-15' }
                ],
                'BETA Project': [
                    { id: 1, title: 'Project Planning', status: 'completed', priority: 'high', assignedTo: 'Project Manager', estimatedHours: 8, actualHours: 8, dueDate: '2024-01-15' },
                    { id: 2, title: 'Stakeholder Interviews', status: 'completed', priority: 'high', assignedTo: 'Business Analyst', estimatedHours: 12, actualHours: 10, dueDate: '2024-01-18' },
                    { id: 3, title: 'Requirements Documentation', status: 'in_progress', priority: 'high', assignedTo: 'Technical Writer', estimatedHours: 16, actualHours: 12, dueDate: '2024-01-22' },
                    { id: 4, title: 'Prototype Development', status: 'pending', priority: 'medium', assignedTo: 'UI/UX Designer', estimatedHours: 20, actualHours: 0, dueDate: '2024-01-30' }
                ]
            };

            const tasks = activeProjectTasks[projectData.name] || [];
            
            if (tasks.length === 0) {
                return '<p class="text-muted">No tasks defined for this active project.</p>';
            }

            let html = '<div class="table-responsive"><table class="table table-sm">';
            html += '<thead><tr><th>Task</th><th>Status</th><th>Priority</th><th>Assigned To</th><th>Hours</th><th>Due Date</th><th>Actions</th></tr></thead><tbody>';
            
            tasks.forEach(task => {
                const statusClass = task.status === 'completed' ? 'bg-success' : 
                                  task.status === 'in_progress' ? 'bg-primary' : 'bg-secondary';
                const priorityClass = getPriorityClass(task.priority);
                
                html += `
                    <tr>
                        <td><strong>${task.title}</strong></td>
                        <td><span class="badge ${statusClass}">${task.status}</span></td>
                        <td><span class="badge ${priorityClass}">${task.priority}</span></td>
                        <td>${task.assignedTo}</td>
                        <td>${task.actualHours}/${task.estimatedHours}h</td>
                        <td>${task.dueDate}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="editTask(${task.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-success" onclick="updateTaskStatus(${task.id})">
                                <i class="fas fa-check"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            return html;
        }

        function generateAITasks(projectId) {
            const projectData = window.templateProjects.find(p => p.id === projectId);
            if (!projectData) return;
            
            showAlert('Generating AI tasks for project...', 'info');
            
            // Simulate AI task generation
            setTimeout(() => {
                const aiTasks = [
                    { id: Date.now() + 1, title: 'AI-Generated: Requirements Gathering', status: 'pending', priority: 'high', assignedTo: 'Business Analyst', estimatedHours: 16, dueDate: '2024-02-01' },
                    { id: Date.now() + 2, title: 'AI-Generated: Technical Architecture', status: 'pending', priority: 'high', assignedTo: 'Solution Architect', estimatedHours: 24, dueDate: '2024-02-05' },
                    { id: Date.now() + 3, title: 'AI-Generated: Development Setup', status: 'pending', priority: 'medium', assignedTo: 'DevOps Engineer', estimatedHours: 8, dueDate: '2024-02-08' },
                    { id: Date.now() + 4, title: 'AI-Generated: Core Development', status: 'pending', priority: 'high', assignedTo: 'Senior Developer', estimatedHours: 40, dueDate: '2024-02-15' },
                    { id: Date.now() + 5, title: 'AI-Generated: Testing & Validation', status: 'pending', priority: 'medium', assignedTo: 'QA Engineer', estimatedHours: 20, dueDate: '2024-02-20' }
                ];
                
                // Store AI-generated tasks
                let allTasks = JSON.parse(localStorage.getItem('projectTasks') || '{}');
                if (!allTasks[projectId]) {
                    allTasks[projectId] = [];
                }
                allTasks[projectId].push(...aiTasks);
                localStorage.setItem('projectTasks', JSON.stringify(allTasks));
                
                showAlert(`Generated ${aiTasks.length} AI tasks for ${projectData.name}!`, 'success');
                
                // Refresh the project details if open
                const projectDetailsModal = document.getElementById('projectDetailsModal');
                if (projectDetailsModal.classList.contains('show')) {
                    viewProjectDetails(projectId);
                }
            }, 2000);
        }

        function editTask(taskId) {
            showAlert('Task editing feature coming soon!', 'info');
        }

        function updateTaskStatus(taskId) {
            showAlert('Task status updated!', 'success');
        }

        // AI Risk Mitigation Functions
        async function showAIRiskAnalysis(projectId) {
            const panel = document.getElementById(`aiRiskMitigationPanel-${projectId}`);
            const content = document.getElementById(`aiRiskAnalysisContent-${projectId}`);
            
            if (panel.style.display === 'none') {
                // Show loading state
                content.innerHTML = `
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Analyzing project risks with AI...</p>
                    </div>
                `;
                panel.style.display = 'block';
                
                try {
                    // Fetch demo risks for analysis
                    const response = await fetch('/api/v1/ai-risk-mitigation/demo-risks');
                    const data = await response.json();
                    
                    if (data.success) {
                        renderAIRiskAnalysis(data.data.risks, projectId);
                    } else {
                        throw new Error('Failed to fetch risk data');
                    }
                } catch (error) {
                    console.error('Error fetching risk analysis:', error);
                    content.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle"></i>
                            Error loading AI risk analysis. Please try again.
                        </div>
                    `;
                }
            } else {
                panel.style.display = 'none';
            }
        }
        
        function renderAIRiskAnalysis(risks, projectId) {
            const content = document.getElementById(`aiRiskAnalysisContent-${projectId}`);
            
            let html = `
                <div class="row">
                    <div class="col-12">
                        <h6><i class="fas fa-chart-line"></i> Risk Analysis Summary</h6>
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <div class="card bg-danger text-white">
                                    <div class="card-body text-center">
                                        <h5>${risks.filter(r => r.impact === 'high').length}</h5>
                                        <small>High Impact</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-warning text-white">
                                    <div class="card-body text-center">
                                        <h5>${risks.filter(r => r.probability === 'medium' || r.probability === 'high').length}</h5>
                                        <small>Medium+ Probability</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-info text-white">
                                    <div class="card-body text-center">
                                        <h5>${risks.filter(r => r.status === 'active').length}</h5>
                                        <small>Active Risks</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-success text-white">
                                    <div class="card-body text-center">
                                        <h5>${risks.filter(r => r.status === 'mitigated').length}</h5>
                                        <small>Mitigated</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <h6><i class="fas fa-robot"></i> AI Recommendations</h6>
                        <div class="alert alert-info">
                            <strong>Priority Actions:</strong>
                            <ul class="mb-0 mt-2">
                                <li>Focus on high-impact risks first</li>
                                <li>Implement proactive monitoring for medium-probability risks</li>
                                <li>Review and update mitigation strategies for active risks</li>
                                <li>Document lessons learned from mitigated risks</li>
                            </ul>
                        </div>
                        
                        <div class="d-flex justify-content-between align-items-center">
                            <h6><i class="fas fa-tasks"></i> Quick Actions</h6>
                            <button class="btn btn-sm btn-outline-secondary" onclick="hideAIRiskAnalysis(${projectId})">
                                <i class="fas fa-times"></i> Close
                            </button>
                        </div>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-primary" onclick="generateAllRiskPlans(${projectId})">
                                <i class="fas fa-robot"></i> Generate All Plans
                            </button>
                            <button class="btn btn-sm btn-info" onclick="exportRiskReport(${projectId})">
                                <i class="fas fa-download"></i> Export Report
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            content.innerHTML = html;
        }
        
        function hideAIRiskAnalysis(projectId) {
            const panel = document.getElementById(`aiRiskMitigationPanel-${projectId}`);
            panel.style.display = 'none';
        }
        
        async function generateAIMitigationPlan(riskId, riskTitle, riskDescription, probability, impact, projectId) {
            try {
                // Show loading state
                const button = event.target;
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
                button.disabled = true;
                
                // Call AI risk mitigation API
                const response = await fetch('/api/v1/ai-risk-mitigation/analyze-risk', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        title: riskTitle,
                        description: riskDescription,
                        probability: probability,
                        impact: impact,
                        project_context: {
                            project_id: projectId,
                            project_name: 'Demo Project'
                        }
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMitigationPlanModal(data.data);
                } else {
                    throw new Error(data.message || 'Failed to generate mitigation plan');
                }
                
            } catch (error) {
                console.error('Error generating mitigation plan:', error);
                showAlert('Error generating AI mitigation plan: ' + error.message, 'danger');
            } finally {
                // Restore button state
                const button = event.target;
                button.innerHTML = '<i class="fas fa-robot"></i> AI Plan';
                button.disabled = false;
            }
        }
        
        function showMitigationPlanModal(planData) {
            // Create modal HTML
            const modalHtml = `
                <div class="modal fade" id="mitigationPlanModal" tabindex="-1">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header bg-info text-white">
                                <h5 class="modal-title">
                                    <i class="fas fa-robot"></i> AI Risk Mitigation Plan
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <h6>Risk Details</h6>
                                        <p><strong>Risk:</strong> ${planData.risk_title}</p>
                                        <p><strong>Description:</strong> ${planData.risk_description}</p>
                                        <p><strong>Level:</strong> <span class="badge bg-${getRiskLevelColor(planData.risk_level)}">${planData.risk_level.toUpperCase()}</span></p>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>Risk Assessment</h6>
                                        <p><strong>Probability:</strong> <span class="badge bg-${getProbabilityColor(planData.probability)}">${planData.probability.toUpperCase()}</span></p>
                                        <p><strong>Impact:</strong> <span class="badge bg-${getImpactColor(planData.impact)}">${planData.impact.toUpperCase()}</span></p>
                                        <p><strong>Confidence:</strong> ${Math.round(planData.confidence_score * 100)}%</p>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <h6>Mitigation Strategy</h6>
                                    <div class="alert alert-light">
                                        ${planData.mitigation_strategy.replace(/\n/g, '<br>')}
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <h6>Action Plan</h6>
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Action</th>
                                                    <th>Priority</th>
                                                    <th>Owner</th>
                                                    <th>Due Date</th>
                                                    <th>Status</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${planData.actions.map(action => `
                                                    <tr>
                                                        <td>
                                                            <strong>${action.title}</strong><br>
                                                            <small class="text-muted">${action.description}</small>
                                                        </td>
                                                        <td><span class="badge bg-${getPriorityColor(action.priority)}">${action.priority}</span></td>
                                                        <td>${action.owner}</td>
                                                        <td>${action.due_date}</td>
                                                        <td>
                                                            <select class="form-select form-select-sm" onchange="updateActionStatus('${action.id}', this.value)">
                                                                <option value="pending" ${action.status === 'pending' ? 'selected' : ''}>Pending</option>
                                                                <option value="in_progress" ${action.status === 'in_progress' ? 'selected' : ''}>In Progress</option>
                                                                <option value="completed" ${action.status === 'completed' ? 'selected' : ''}>Completed</option>
                                                                <option value="failed" ${action.status === 'failed' ? 'selected' : ''}>Failed</option>
                                                            </select>
                                                        </td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>Timeline</h6>
                                        <p>${planData.timeline}</p>
                                        
                                        <h6>Success Metrics</h6>
                                        <ul>
                                            ${planData.success_metrics.map(metric => `<li>${metric}</li>`).join('')}
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>Monitoring Plan</h6>
                                        <div class="alert alert-light">
                                            ${planData.monitoring_plan.replace(/\n/g, '<br>')}
                                        </div>
                                        
                                        <h6>Contingency Plan</h6>
                                        <div class="alert alert-warning">
                                            ${planData.contingency_plan.replace(/\n/g, '<br>')}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="button" class="btn btn-primary" onclick="exportMitigationPlan()">
                                    <i class="fas fa-download"></i> Export Plan
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('mitigationPlanModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('mitigationPlanModal'));
            modal.show();
        }
        
        function getRiskLevelColor(level) {
            const colors = {
                'low': 'success',
                'medium': 'warning', 
                'high': 'danger',
                'critical': 'dark'
            };
            return colors[level] || 'secondary';
        }
        
        function getProbabilityColor(probability) {
            const colors = {
                'low': 'success',
                'medium': 'warning',
                'high': 'danger'
            };
            return colors[probability] || 'secondary';
        }
        
        function getImpactColor(impact) {
            const colors = {
                'low': 'success',
                'medium': 'warning', 
                'high': 'danger'
            };
            return colors[impact] || 'secondary';
        }
        
        function getPriorityColor(priority) {
            const colors = {
                'low': 'success',
                'medium': 'warning',
                'high': 'danger'
            };
            return colors[priority.toLowerCase()] || 'secondary';
        }
        
        async function updateActionStatus(actionId, newStatus) {
            try {
                const response = await fetch('/api/v1/ai-risk-mitigation/update-action-status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action_id: actionId,
                        status: newStatus
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert(`Action ${actionId} status updated to ${newStatus}`, 'success');
                } else {
                    throw new Error(data.message || 'Failed to update action status');
                }
                
            } catch (error) {
                console.error('Error updating action status:', error);
                showAlert('Error updating action status: ' + error.message, 'danger');
            }
        }
        
        async function generateAllRiskPlans(projectId) {
            showAlert('Generating AI mitigation plans for all risks...', 'info');
            
            // Simulate generating plans for all risks
            setTimeout(() => {
                showAlert('AI mitigation plans generated successfully!', 'success');
            }, 2000);
        }
        
        function exportRiskReport(projectId) {
            showAlert('Risk report exported successfully!', 'success');
        }
        
        function exportMitigationPlan() {
            showAlert('Mitigation plan exported successfully!', 'success');
        }
        
        function addRisk(projectId) {
            showAlert('Add Risk functionality - Demo Mode', 'info');
        }

        // AI Dependency Resolution Functions
        async function showAIDependencyAnalysis(projectId) {
            const panel = document.getElementById(`aiDependencyPanel-${projectId}`);
            const content = document.getElementById(`aiDependencyContent-${projectId}`);
            
            if (panel.style.display === 'none') {
                // Show loading state
                content.innerHTML = `
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Analyzing dependencies with AI...</p>
                    </div>
                `;
                panel.style.display = 'block';
                
                try {
                    // Fetch demo dependencies for analysis
                    const response = await fetch('/api/v1/ai-dependency-resolution/demo-dependencies');
                    const data = await response.json();
                    
                    if (data.success) {
                        // Generate AI analysis
                        const analysisResponse = await fetch('/api/v1/ai-dependency-resolution/analyze-dependencies', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                project_id: projectId,
                                tasks: data.data.tasks,
                                dependencies: data.data.dependencies
                            })
                        });
                        
                        const analysisData = await analysisResponse.json();
                        
                        if (analysisData.success) {
                            renderAIDependencyAnalysis(analysisData.data, projectId);
                        } else {
                            throw new Error('Failed to generate AI analysis');
                        }
                    } else {
                        throw new Error('Failed to fetch dependency data');
                    }
                } catch (error) {
                    console.error('Error fetching dependency analysis:', error);
                    content.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle"></i>
                            Error loading AI dependency analysis. Please try again.
                        </div>
                    `;
                }
            } else {
                panel.style.display = 'none';
            }
        }
        
        function renderAIDependencyAnalysis(analysisData, projectId) {
            const content = document.getElementById(`aiDependencyContent-${projectId}`);
            
            let html = `
                <div class="row">
                    <div class="col-12">
                        <h6><i class="fas fa-chart-line"></i> Dependency Analysis Summary</h6>
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <div class="card bg-danger text-white">
                                    <div class="card-body text-center">
                                        <h5>${analysisData.conflicts.filter(c => c.severity === 'critical').length}</h5>
                                        <small>Critical Conflicts</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-warning text-white">
                                    <div class="card-body text-center">
                                        <h5>${analysisData.conflicts.filter(c => c.severity === 'high').length}</h5>
                                        <small>High Priority</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-info text-white">
                                    <div class="card-body text-center">
                                        <h5>${analysisData.critical_path.critical_tasks.length}</h5>
                                        <small>Critical Tasks</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-success text-white">
                                    <div class="card-body text-center">
                                        <h5>${analysisData.critical_path.total_duration}</h5>
                                        <small>Total Days</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <h6><i class="fas fa-robot"></i> AI Recommendations</h6>
                        <div class="alert alert-info">
                            <strong>Priority Actions:</strong>
                            <ul class="mb-0 mt-2">
                                <li>Resolve critical dependency conflicts immediately</li>
                                <li>Optimize critical path to reduce project duration</li>
                                <li>Implement parallel development where possible</li>
                                <li>Monitor resource allocation to prevent conflicts</li>
                            </ul>
                        </div>
                        
                        <div class="d-flex justify-content-between align-items-center">
                            <h6><i class="fas fa-tasks"></i> Quick Actions</h6>
                            <button class="btn btn-sm btn-outline-secondary" onclick="hideAIDependencyAnalysis(${projectId})">
                                <i class="fas fa-times"></i> Close
                            </button>
                        </div>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-primary" onclick="generateDependencyResolutionPlan(${projectId})">
                                <i class="fas fa-robot"></i> Generate Resolution Plan
                            </button>
                            <button class="btn btn-sm btn-info" onclick="showOptimizationSuggestions(${projectId})">
                                <i class="fas fa-lightbulb"></i> Optimization Tips
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            content.innerHTML = html;
            
            // Show conflicts if any
            if (analysisData.conflicts.length > 0) {
                showDependencyConflicts(analysisData.conflicts, projectId);
            }
        }
        
        function showDependencyConflicts(conflicts, projectId) {
            const conflictsAlert = document.getElementById(`dependencyConflicts-${projectId}`);
            const conflictsList = document.getElementById(`conflictsList-${projectId}`);
            
            let conflictsHtml = '';
            conflicts.forEach(conflict => {
                conflictsHtml += `
                    <div class="alert alert-${getSeverityColor(conflict.severity)} mb-2">
                        <h6><i class="fas fa-exclamation-triangle"></i> ${conflict.conflict_type}</h6>
                        <p class="mb-2">${conflict.description}</p>
                        <p><strong>Root Cause:</strong> ${conflict.root_cause}</p>
                        <p><strong>Impact:</strong> ${conflict.impact_analysis}</p>
                        <div class="mt-2">
                            <strong>Resolution Strategies:</strong>
                            <ul class="mb-0">
                                ${conflict.resolution_strategies.map(strategy => `<li>${strategy}</li>`).join('')}
                            </ul>
                        </div>
                        <div class="mt-2">
                            <button class="btn btn-sm btn-outline-primary" onclick="resolveConflict('${conflict.conflict_id}', '${conflict.conflict_type}', ${projectId})">
                                <i class="fas fa-wrench"></i> Resolve
                            </button>
                        </div>
                    </div>
                `;
            });
            
            conflictsList.innerHTML = conflictsHtml;
            conflictsAlert.style.display = 'block';
        }
        
        function getSeverityColor(severity) {
            const colors = {
                'low': 'success',
                'medium': 'warning',
                'high': 'danger',
                'critical': 'dark'
            };
            return colors[severity] || 'secondary';
        }
        
        function hideAIDependencyAnalysis(projectId) {
            const panel = document.getElementById(`aiDependencyPanel-${projectId}`);
            panel.style.display = 'none';
        }
        
        async function analyzeTaskDependencies(taskId, taskName, projectId) {
            try {
                // Show loading state
                const button = event.target;
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing...';
                button.disabled = true;
                
                // Show initial alert
                showAlert(`Analyzing dependencies for: ${taskName}`, 'info');
                
                // Call AI dependency analysis API
                const response = await fetch('/api/v1/ai-dependency-resolution/analyze-dependencies', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        project_id: projectId,
                        tasks: [
                            {
                                id: taskId,
                                name: taskName,
                                duration: getTaskDuration(taskName),
                                status: getTaskStatus(taskName),
                                assigned_to: getTaskAssignee(taskName)
                            }
                        ],
                        dependencies: []
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Show detailed analysis modal
                    showTaskAnalysisModal(taskName, data.data, taskId);
                } else {
                    throw new Error(data.message || 'Failed to analyze task dependencies');
                }
                
            } catch (error) {
                console.error('Error analyzing task dependencies:', error);
                showAlert('Error analyzing task dependencies: ' + error.message, 'danger');
            } finally {
                // Restore button state
                const button = event.target;
                button.innerHTML = '<i class="fas fa-robot"></i> Analyze';
                button.disabled = false;
            }
        }
        
        async function showDependencyVisualization(projectId) {
            try {
                const response = await fetch('/api/v1/ai-dependency-resolution/dependency-visualization');
                const data = await response.json();
                
                if (data.success) {
                    showDependencyVisualizationModal(data.data);
                } else {
                    throw new Error('Failed to fetch visualization data');
                }
                
            } catch (error) {
                console.error('Error showing dependency visualization:', error);
                showAlert('Error loading dependency visualization: ' + error.message, 'danger');
            }
        }
        
        function showDependencyVisualizationModal(vizData) {
            // Create modal HTML for dependency visualization
            const modalHtml = `
                <div class="modal fade" id="dependencyVizModal" tabindex="-1">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header bg-success text-white">
                                <h5 class="modal-title">
                                    <i class="fas fa-project-diagram"></i> Dependency Visualization
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="text-center mb-3">
                                    <div class="dependency-graph">
                                        <div class="node critical">Setup Environment</div>
                                        <div class="arrow">â†’</div>
                                        <div class="node critical">Database Design</div>
                                        <div class="arrow">â†’</div>
                                        <div class="node critical">API Development</div>
                                        <div class="arrow">â†’</div>
                                        <div class="node critical">Testing</div>
                                        <div class="arrow">â†’</div>
                                        <div class="node critical">Deployment</div>
                                    </div>
                                    <div class="mt-3">
                                        <div class="node float">Frontend Development</div>
                                        <div class="node float">Documentation</div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>Legend</h6>
                                        <ul class="list-unstyled">
                                            <li><span class="badge bg-danger">Critical Path</span> - Tasks on critical path</li>
                                            <li><span class="badge bg-success">Float</span> - Tasks with float time</li>
                                            <li><span class="badge bg-info">Completed</span> - Finished tasks</li>
                                            <li><span class="badge bg-warning">In Progress</span> - Active tasks</li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>Key Metrics</h6>
                                        <ul class="list-unstyled">
                                            <li><strong>Critical Path Duration:</strong> 14 days</li>
                                            <li><strong>Total Tasks:</strong> ${vizData.nodes.length}</li>
                                            <li><strong>Dependencies:</strong> ${vizData.edges.length}</li>
                                            <li><strong>Float Tasks:</strong> 3</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="button" class="btn btn-primary" onclick="exportDependencyGraph()">
                                    <i class="fas fa-download"></i> Export Graph
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <style>
                .dependency-graph {
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    flex-wrap: wrap;
                    gap: 10px;
                }
                .node {
                    padding: 8px 16px;
                    border-radius: 20px;
                    color: white;
                    font-weight: bold;
                    min-width: 120px;
                    text-align: center;
                }
                .node.critical {
                    background-color: #dc3545;
                }
                .node.float {
                    background-color: #28a745;
                    margin: 5px;
                }
                .arrow {
                    font-size: 20px;
                    color: #6c757d;
                }
                </style>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('dependencyVizModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('dependencyVizModal'));
            modal.show();
        }
        
        async function generateDependencyResolutionPlan(projectId) {
            try {
                showAlert('Generating AI dependency resolution plan...', 'info');
                
                // Simulate plan generation
                setTimeout(() => {
                    showAlert('Dependency resolution plan generated successfully!', 'success');
                }, 2000);
                
            } catch (error) {
                console.error('Error generating resolution plan:', error);
                showAlert('Error generating resolution plan: ' + error.message, 'danger');
            }
        }
        
        async function showOptimizationSuggestions(projectId) {
            try {
                const response = await fetch('/api/v1/ai-dependency-resolution/optimization-suggestions');
                const data = await response.json();
                
                if (data.success) {
                    showOptimizationModal(data.data.suggestions);
                } else {
                    throw new Error('Failed to fetch optimization suggestions');
                }
                
            } catch (error) {
                console.error('Error fetching optimization suggestions:', error);
                showAlert('Error loading optimization suggestions: ' + error.message, 'danger');
            }
        }
        
        function showOptimizationModal(suggestions) {
            const modalHtml = `
                <div class="modal fade" id="optimizationModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header bg-warning text-dark">
                                <h5 class="modal-title">
                                    <i class="fas fa-lightbulb"></i> AI Optimization Suggestions
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                ${suggestions.map(suggestion => `
                                    <div class="card mb-3">
                                        <div class="card-body">
                                            <h6 class="card-title">
                                                <i class="fas fa-${getSuggestionIcon(suggestion.type)}"></i>
                                                ${suggestion.title}
                                            </h6>
                                            <p class="card-text">${suggestion.description}</p>
                                            <div class="row">
                                                <div class="col-md-4">
                                                    <small><strong>Impact:</strong> <span class="badge bg-${getImpactColor(suggestion.impact)}">${suggestion.impact}</span></small>
                                                </div>
                                                <div class="col-md-4">
                                                    <small><strong>Effort:</strong> <span class="badge bg-${getEffortColor(suggestion.effort)}">${suggestion.effort}</span></small>
                                                </div>
                                                <div class="col-md-4">
                                                    <small><strong>Savings:</strong> <span class="text-success">${suggestion.savings}</span></small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="button" class="btn btn-primary" onclick="implementOptimizations()">
                                    <i class="fas fa-check"></i> Implement Selected
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('optimizationModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('optimizationModal'));
            modal.show();
        }
        
        function getSuggestionIcon(type) {
            const icons = {
                'Parallel Development': 'sync-alt',
                'Automation': 'cogs',
                'Resource Optimization': 'users',
                'Process Improvement': 'chart-line'
            };
            return icons[type] || 'lightbulb';
        }
        
        function getImpactColor(impact) {
            const colors = {
                'low': 'success',
                'medium': 'warning',
                'high': 'danger'
            };
            return colors[impact] || 'secondary';
        }
        
        function getEffortColor(effort) {
            const colors = {
                'low': 'success',
                'medium': 'warning',
                'high': 'danger'
            };
            return colors[effort] || 'secondary';
        }
        
        async function resolveConflict(conflictId, conflictType, projectId) {
            try {
                const response = await fetch('/api/v1/ai-dependency-resolution/resolve-conflict', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        conflict_id: conflictId,
                        strategy: 'AI Recommended Resolution'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert(`Conflict ${conflictId} resolved successfully!`, 'success');
                    // Hide the conflict from the UI
                    const conflictElement = document.querySelector(`[data-conflict-id="${conflictId}"]`);
                    if (conflictElement) {
                        conflictElement.style.display = 'none';
                    }
                } else {
                    throw new Error(data.message || 'Failed to resolve conflict');
                }
                
            } catch (error) {
                console.error('Error resolving conflict:', error);
                showAlert('Error resolving conflict: ' + error.message, 'danger');
            }
        }
        
        function exportDependencyGraph() {
            showAlert('Dependency graph exported successfully!', 'success');
        }
        
        function implementOptimizations() {
            showAlert('Optimizations implemented successfully!', 'success');
        }
        
        // Helper functions for task analysis
        function getTaskDuration(taskName) {
            const durations = {
                'Setup Development Environment': 2,
                'Database Design': 3,
                'API Development': 5,
                'Frontend Development': 4,
                'Testing & QA': 3,
                'Deployment': 1
            };
            return durations[taskName] || 2;
        }
        
        function getTaskStatus(taskName) {
            const statuses = {
                'Setup Development Environment': 'completed',
                'Database Design': 'in_progress',
                'API Development': 'pending',
                'Frontend Development': 'pending',
                'Testing & QA': 'pending',
                'Deployment': 'pending'
            };
            return statuses[taskName] || 'pending';
        }
        
        function getTaskAssignee(taskName) {
            const assignees = {
                'Setup Development Environment': 'DevOps Team',
                'Database Design': 'Database Architect',
                'API Development': 'Backend Developer',
                'Frontend Development': 'Frontend Developer',
                'Testing & QA': 'QA Team',
                'Deployment': 'DevOps Team'
            };
            return assignees[taskName] || 'Unassigned';
        }
        
        function showTaskAnalysisModal(taskName, analysisData, taskId) {
            // Create modal HTML for task analysis
            const modalHtml = `
                <div class="modal fade" id="taskAnalysisModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header bg-primary text-white">
                                <h5 class="modal-title">
                                    <i class="fas fa-robot"></i> AI Task Analysis: ${taskName}
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <h6>Task Information</h6>
                                        <ul class="list-unstyled">
                                            <li><strong>Task:</strong> ${taskName}</li>
                                            <li><strong>Duration:</strong> ${getTaskDuration(taskName)} days</li>
                                            <li><strong>Status:</strong> <span class="badge bg-${getStatusColor(getTaskStatus(taskName))}">${getTaskStatus(taskName).toUpperCase()}</span></li>
                                            <li><strong>Assignee:</strong> ${getTaskAssignee(taskName)}</li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>Dependency Analysis</h6>
                                        <ul class="list-unstyled">
                                            <li><strong>Critical Path:</strong> ${analysisData.critical_path.critical_tasks.includes(taskName) ? 'Yes' : 'No'}</li>
                                            <li><strong>Float Time:</strong> ${analysisData.critical_path.float_analysis[taskName] || 0} days</li>
                                            <li><strong>Conflicts:</strong> ${analysisData.conflicts.filter(c => c.affected_tasks.includes(taskName)).length}</li>
                                            <li><strong>Priority:</strong> ${getTaskPriority(taskName)}</li>
                                        </ul>
                                    </div>
                                </div>
                                
                                ${analysisData.conflicts.filter(c => c.affected_tasks.includes(taskName)).length > 0 ? `
                                    <div class="alert alert-warning">
                                        <h6><i class="fas fa-exclamation-triangle"></i> Dependencies Issues Found</h6>
                                        ${analysisData.conflicts.filter(c => c.affected_tasks.includes(taskName)).map(conflict => `
                                            <div class="mb-2">
                                                <strong>${conflict.conflict_type}:</strong> ${conflict.description}
                                                <br><small class="text-muted">${conflict.impact_analysis}</small>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : `
                                    <div class="alert alert-success">
                                        <i class="fas fa-check-circle"></i> No dependency conflicts found for this task.
                                    </div>
                                `}
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>AI Recommendations</h6>
                                        <ul>
                                            ${getTaskRecommendations(taskName).map(rec => `<li>${rec}</li>`).join('')}
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>Next Steps</h6>
                                        <ul>
                                            ${getTaskNextSteps(taskName).map(step => `<li>${step}</li>`).join('')}
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="button" class="btn btn-primary" onclick="exportTaskAnalysis('${taskName}')">
                                    <i class="fas fa-download"></i> Export Analysis
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('taskAnalysisModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('taskAnalysisModal'));
            modal.show();
        }
        
        function getStatusColor(status) {
            const colors = {
                'completed': 'success',
                'in_progress': 'warning',
                'pending': 'secondary',
                'cancelled': 'danger'
            };
            return colors[status] || 'secondary';
        }
        
        function getTaskPriority(taskName) {
            const priorities = {
                'Setup Development Environment': 'Critical',
                'Database Design': 'High',
                'API Development': 'High',
                'Frontend Development': 'Medium',
                'Testing & QA': 'High',
                'Deployment': 'Critical'
            };
            return priorities[taskName] || 'Medium';
        }
        
        function getTaskRecommendations(taskName) {
            const recommendations = {
                'Setup Development Environment': [
                    'Ensure all development tools are properly configured',
                    'Verify environment consistency across team members',
                    'Document setup procedures for future reference'
                ],
                'Database Design': [
                    'Review database schema with stakeholders',
                    'Consider performance implications of design choices',
                    'Plan for data migration if needed'
                ],
                'API Development': [
                    'Follow RESTful API design principles',
                    'Implement proper error handling and validation',
                    'Consider API versioning strategy'
                ],
                'Frontend Development': [
                    'Ensure responsive design for all devices',
                    'Implement proper state management',
                    'Consider accessibility requirements'
                ],
                'Testing & QA': [
                    'Develop comprehensive test cases',
                    'Implement automated testing where possible',
                    'Plan for different testing environments'
                ],
                'Deployment': [
                    'Prepare rollback procedures',
                    'Monitor system performance post-deployment',
                    'Communicate deployment status to stakeholders'
                ]
            };
            return recommendations[taskName] || ['Follow standard development practices'];
        }
        
        function getTaskNextSteps(taskName) {
            const nextSteps = {
                'Setup Development Environment': [
                    'Verify all team members have access',
                    'Test development environment functionality',
                    'Update documentation'
                ],
                'Database Design': [
                    'Create database schema',
                    'Set up development database',
                    'Review with database administrator'
                ],
                'API Development': [
                    'Set up API framework',
                    'Implement core endpoints',
                    'Add authentication and authorization'
                ],
                'Frontend Development': [
                    'Set up frontend framework',
                    'Create component library',
                    'Implement routing and navigation'
                ],
                'Testing & QA': [
                    'Create test plan',
                    'Set up testing environment',
                    'Execute test cases'
                ],
                'Deployment': [
                    'Prepare production environment',
                    'Execute deployment procedures',
                    'Verify system functionality'
                ]
            };
            return nextSteps[taskName] || ['Continue with task execution'];
        }
        
        function exportTaskAnalysis(taskName) {
            showAlert(`Task analysis for ${taskName} exported successfully!`, 'success');
        }

        // Initialize - using template data
        console.log('Projects page loaded with template data');
    </script>
</body>
</html>
