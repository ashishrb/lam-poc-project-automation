{% extends "base.html" %}
{% block content %}
<h1>Manager Dashboard</h1>
<script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
<div class="grid">
  <section>
    <h3>Demo Controls</h3>
    <p class="text-muted">Enable Demo Mode to force server-side sample data for all charts. Use Reset to reseed the database with fresh demo content.</p>
    <div class="d-flex gap-2 align-items-center flex-wrap">
      <input id="admin-token" class="form-control form-control-sm" placeholder="Admin Token (optional)" style="max-width:220px" />
      <button id="save-token" class="btn btn-sm btn-secondary">Save Token</button>
      <button id="toggle-demo" class="btn btn-sm btn-primary">Toggle Demo Mode</button>
      <button id="reset-demo" class="btn btn-sm btn-outline-light">Reset Demo Data</button>
      <span id="demo-indicator" class="badge rounded-pill text-bg-secondary">Checking…</span>
    </div>
  </section>
  <section>
    <h3>Project Health Heatmap</h3>
    <div id="health-heatmap" style="height:320px;"></div>
  </section>
  <section>
    <h3>Autonomous Actions</h3>
    <div class="d-flex gap-2 align-items-center">
      <button id="run-analysis" class="btn btn-sm btn-warning">Run Autonomous Analysis</button>
      <button id="gen-comm" class="btn btn-sm btn-info">Generate Executive Update</button>
      <button id="email-test" class="btn btn-sm btn-outline-secondary">Send Test Email</button>
      <span id="action-status" class="text-muted"></span>
    </div>
  </section>
  <section>
    <h3>RAG Tools</h3>
    <div class="mb-2">
      <label class="form-label">Upload Documents (txt, md, csv, json, html)</label>
      <input type="file" id="rag-files" class="form-control form-control-sm" multiple>
      <button id="rag-upload" class="btn btn-sm btn-primary mt-2">Upload & Index</button>
      <span id="rag-upload-status" class="text-muted"></span>
    </div>
    <div class="mt-2">
      <label class="form-label">Ask with RAG</label>
      <textarea id="rag-query" class="form-control" rows="2" placeholder="E.g., Summarize recent updates and risks for PROJ001"></textarea>
      <button id="rag-ask" class="btn btn-sm btn-outline-info mt-2">Ask</button>
      <pre id="rag-answer" class="mt-2" style="white-space:pre-wrap"></pre>
    </div>
  </section>
  <section>
    <h3>NLP Operations</h3>
    <div class="row g-2">
      <div class="col-md-3">
        <label class="form-label">Provider</label>
        <select id="nlp-provider" class="form-select form-select-sm">
          <option value="auto" selected>Auto (Route)</option>
          <option value="gpt">gpt-oss:20b (Ollama)</option>
          <option value="xlam">xLAM</option>
        </select>
        <div class="form-check mt-2">
          <input class="form-check-input" type="checkbox" value="1" id="nlp-use-rag" checked>
          <label class="form-check-label" for="nlp-use-rag">Augment with RAG</label>
        </div>
      </div>
      <div class="col-md-9">
        <label class="form-label">Instruction</label>
        <textarea id="nlp-prompt" class="form-control" rows="2" placeholder="E.g., Draft an executive update for current portfolio and email it."></textarea>
        <button id="nlp-run" class="btn btn-sm btn-success mt-2">Run</button>
      </div>
    </div>
    <pre id="nlp-output" class="mt-2" style="white-space:pre-wrap"></pre>
  </section>
  <section>
    <h3>Tool Actions (xLAM-backed)</h3>
    <div class="row g-3">
      <div class="col-md-6">
        <h6>Write File</h6>
        <input id="wf-path" class="form-control form-control-sm" placeholder="subdir/note.txt" />
        <textarea id="wf-content" class="form-control mt-1" rows="3" placeholder="File content..."></textarea>
        <button id="wf-run" class="btn btn-sm btn-outline-warning mt-2">Write</button>
        <div id="wf-status" class="text-muted"></div>
      </div>
      <div class="col-md-6">
        <h6>Team Message</h6>
        <input id="tm-project" class="form-control form-control-sm" placeholder="Project ID (e.g., PROJ001)" />
        <input id="tm-recipients" class="form-control form-control-sm mt-1" placeholder="Emails (comma-separated)" />
        <input id="tm-subject" class="form-control form-control-sm mt-1" placeholder="Subject" />
        <textarea id="tm-message" class="form-control mt-1" rows="3" placeholder="Message"></textarea>
        <button id="tm-run" class="btn btn-sm btn-outline-primary mt-2">Send</button>
        <div id="tm-status" class="text-muted"></div>
      </div>
      <div class="col-md-6">
        <h6>Executive Email</h6>
        <input id="ee-recipients" class="form-control form-control-sm" placeholder="Emails (blank = use LEADERSHIP_EMAILS)" />
        <input id="ee-subject" class="form-control form-control-sm mt-1" placeholder="Subject" />
        <textarea id="ee-body" class="form-control mt-1" rows="3" placeholder="Body"></textarea>
        <button id="ee-run" class="btn btn-sm btn-outline-success mt-2">Send</button>
        <div id="ee-status" class="text-muted"></div>
      </div>
      <div class="col-md-6">
        <h6>Leadership Update</h6>
        <input id="lu-name" class="form-control form-control-sm" placeholder="Your Name" />
        <input id="lu-project" class="form-control form-control-sm mt-1" placeholder="Project (e.g., PROJ001)" />
        <textarea id="lu-update" class="form-control mt-1" rows="3" placeholder="Update text"></textarea>
        <button id="lu-run" class="btn btn-sm btn-outline-light mt-2">Post</button>
        <div id="lu-status" class="text-muted"></div>
      </div>
    </div>
  </section>
  <section>
    <h3>Activity Log</h3>
    <div class="row g-3">
      <div class="col-md-6">
        <h6>Recent Communications</h6>
        <table class="table table-sm"><thead>
          <tr><th>Time</th><th>Project</th><th>Channel</th><th>Subject</th><th>Status</th></tr>
        </thead><tbody id="tbl-comm"></tbody></table>
      </div>
      <div class="col-md-6">
        <h6>Recent Files</h6>
        <table class="table table-sm"><thead>
          <tr><th>Modified</th><th>Path</th><th>Size</th><th></th></tr>
        </thead><tbody id="tbl-files"></tbody></table>
      </div>
    </div>
  </section>
  <section>
    <h3>Resource Utilization</h3>
    <div id="utilization-bar" style="height:320px;"></div>
  </section>
  <section>
    <h3>Budget Burn-down</h3>
    <div id="budget-burndown" style="height:320px;"></div>
  </section>
  <section>
    <h3>Timeline Adherence</h3>
    <div id="timeline-gauge" style="height:320px;"></div>
  </section>
  <section>
    <h3>Team Performance (Radar)</h3>
    <div id="team-radar" style="height:320px;"></div>
  </section>
  <section>
    <h3>Predictive Trend</h3>
    <div id="predictive-line" style="height:320px;"></div>
  </section>
</div>
<script>
async function fetchJSON(url){ try { const r = await fetch(url); return await r.json(); } catch(e){ return {success:false}; } }
function safeGet(obj, path, fallback){
  try {
    let cur = obj;
    for(const k of path){ if(cur && (k in cur)) cur = cur[k]; else return fallback; }
    return (cur === undefined || cur === null) ? fallback : cur;
  } catch(e){ return fallback; }
}

const DARK_LAYOUT = {
  paper_bgcolor: 'rgba(0,0,0,0)',
  plot_bgcolor: 'rgba(0,0,0,0)',
  font: { color: '#e5e7eb' },
  margin: { t: 10 },
  xaxis: { gridcolor: '#1f2937', zerolinecolor: '#1f2937' },
  yaxis: { gridcolor: '#1f2937', zerolinecolor: '#1f2937' }
};

async function drawHealthHeatmap(){
  const data = await fetchJSON('/api/v1/projects/health');
  const projects = (data && data.success && data.projects && data.projects.length)
    ? data.projects
    : [
        {name:'Proj A', budget_health:'healthy', schedule_health:'warning', team_health:'healthy'},
        {name:'Proj B', budget_health:'warning', schedule_health:'healthy', team_health:'critical'}
      ];
  const metrics = ['budget_health','schedule_health','team_health'];
  const toScore = h => ({healthy:8, warning:5, critical:2}[h]||5);
  const z = metrics.map(m=>projects.map(p=>toScore(p[m])));
  const x = projects.map(p=>p.name);
  const y = ['Budget','Schedule','Team'];
  Plotly.newPlot('health-heatmap', [{type:'heatmap', z, x, y, colorscale:'RdYlGn'}], {...DARK_LAYOUT});
}

async function drawUtilization(){
  const d = await fetchJSON('/api/v1/projects/resource-utilization');
  const util = (d && d.success && d.utilization) ? d.utilization : {Backend:.82, Frontend:.64, QA:.58, DevOps:.76, Data:.61};
  const labels = Object.keys(util), vals = Object.values(util).map(v=>v*100);
  Plotly.newPlot('utilization-bar', [{type:'bar', x:labels, y:vals, marker:{color:'#60a5fa'}}], {...DARK_LAYOUT, yaxis:{...DARK_LAYOUT.yaxis, title:'%'}});
}

async function drawBurndown(){
  const d = await fetchJSON('/api/v1/projects/budget-burndown');
  let dates, spent, alloc;
  if(d && d.success && d.series && d.series.length){
    dates = d.series.map(s=>s.date);
    spent = d.series.map(s=>s.spent);
    alloc = d.series.map(s=>s.allocated);
  } else {
    const now = new Date();
    dates = [...Array(14)].map((_,i)=>new Date(now.getTime()+i*86400000).toISOString().slice(0,10));
    alloc = dates.map(()=>200000);
    spent = dates.map((_,i)=> 10000 + i*9000);
  }
  Plotly.newPlot('budget-burndown', [
    {x:dates, y:alloc, type:'scatter', name:'Allocated', line:{color:'#93c5fd'}},
    {x:dates, y:spent, type:'scatter', name:'Spent', line:{color:'#22d3ee'}}
  ], {...DARK_LAYOUT});
}

async function drawTimeline(){
  const d = await fetchJSON('/api/v1/projects/timeline');
  const actual = (d && d.success && typeof d.actual === 'number') ? d.actual : 62;
  const fig = [
    {type:'indicator', mode:'gauge+number', value:actual, title:{text:'Actual %', font:{color:'#e5e7eb'}}, gauge:{axis:{range:[0,100], tickcolor:'#9ca3af'}, bar:{color:'#38bdf8'}, bgcolor:'rgba(0,0,0,0)'}},
  ];
  Plotly.newPlot('timeline-gauge', fig, {...DARK_LAYOUT});
}

async function drawTeamRadar(){
  const d = await fetchJSON('/api/v1/projects/team-performance');
  const cats = ['quality','collaboration','innovation'];
  const vals = (d && d.success && d.averages) ? cats.map(c=>d.averages[c]) : [7.8, 7.2, 8.1];
  Plotly.newPlot('team-radar', [{type:'scatterpolar', r:vals, theta:['Quality','Collaboration','Innovation'], fill:'toself', line:{color:'#34d399'}}], { ...DARK_LAYOUT, polar:{bgcolor:'rgba(0,0,0,0)', radialaxis:{visible:true,range:[0,10], gridcolor:'#1f2937', tickfont:{color:'#e5e7eb'}}}});
}

async function drawPredictive(){
  const d = await fetchJSON('/api/v1/analytics/predictions');
  const now = new Date();
  const xs = [...Array(12)].map((_,i)=>new Date(now.getTime()+i*86400000).toISOString().slice(0,10));
  const base = (d && d.success && d.prediction) ? d.prediction : 0.78;
  const ys = xs.map((_,i)=> Math.min(1, Math.max(0.5, base + 0.05*Math.sin(i/2))));
  Plotly.newPlot('predictive-line', [{x:xs, y:ys, type:'scatter', line:{color:'#a78bfa'}}], { ...DARK_LAYOUT, yaxis:{...DARK_LAYOUT.yaxis, range:[0,1], ticksuffix:'', title:'Success Probability'} });
}

(async ()=>{
  // Demo controls wiring
  try {
    const health = await fetchJSON('/api/v1/health');
    const enabled = safeGet(health, ['data','demo_mode','enabled'], false) === true;
    document.getElementById('demo-indicator').textContent = enabled ? 'Demo Mode: ON' : 'Demo Mode: OFF';
    document.getElementById('demo-indicator').className = enabled ? 'badge rounded-pill text-bg-success' : 'badge rounded-pill text-bg-secondary';
  } catch(e) {}

  // Load admin token
  const tokenInput = document.getElementById('admin-token');
  tokenInput.value = localStorage.getItem('ADMIN_TOKEN') || '';
  document.getElementById('save-token').addEventListener('click', ()=>{
    localStorage.setItem('ADMIN_TOKEN', tokenInput.value || '');
    alert('Saved');
  });

  document.getElementById('toggle-demo').addEventListener('click', async () => {
    const current = (document.getElementById('demo-indicator').textContent||'').includes('ON');
    const headers={'Content-Type':'application/json'}; const tok=localStorage.getItem('ADMIN_TOKEN'); if(tok) headers['X-Admin-Token']=tok;
    const resp = await fetch('/api/v1/admin/demo-mode', { method:'POST', headers, body: JSON.stringify({enabled: !current}) });
    const js = await resp.json();
    if(js.success){ location.reload(); }
  });
  document.getElementById('reset-demo').addEventListener('click', async () => {
    if(!confirm('This will reset and reseed demo data. Continue?')) return;
    const headers={}; const tok=localStorage.getItem('ADMIN_TOKEN'); if(tok) headers['X-Admin-Token']=tok;
    const resp = await fetch('/api/v1/admin/reset-demo-data', { method:'POST', headers });
    const js = await resp.json();
    if(js.success){ location.reload(); }
  });

  await drawHealthHeatmap();
  await drawUtilization();
  await drawBurndown();
  await drawTimeline();
  await drawTeamRadar();
  await drawPredictive();
})();

// Action handlers
document.getElementById('run-analysis').addEventListener('click', async () => {
  const el = document.getElementById('action-status');
  el.textContent = 'Running analysis…';
  try{
    const r = await fetch('/api/v1/projects/autonomous-analysis');
    const j = await r.json();
    el.textContent = j.success ? 'Analysis complete.' : ('Error: ' + (j.error||'failed'));
  }catch(e){ el.textContent = 'Error running analysis'; }
});

document.getElementById('gen-comm').addEventListener('click', async () => {
  const el = document.getElementById('action-status');
  el.textContent = 'Generating executive update…';
  try{
    const r = await fetch('/api/v1/communications/generate', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({audience:'executive'})});
    const j = await r.json();
    el.textContent = j.success ? 'Executive update drafted.' : ('Error: ' + (j.error||'failed'));
  }catch(e){ el.textContent = 'Error generating update'; }
});

// SMTP test
document.getElementById('email-test').addEventListener('click', async () => {
  const el = document.getElementById('action-status');
  el.textContent = 'Sending test email…';
  try{
    const headers={'Content-Type':'application/json'}; const tok=localStorage.getItem('ADMIN_TOKEN'); if(tok) headers['X-Admin-Token']=tok;
    const r = await fetch('/api/v1/email/test', {method:'POST', headers, body: JSON.stringify({})});
    const j = await r.json();
    el.textContent = j.success ? `Test email sent to ${j.to}` : ('Error: ' + (j.error||'failed'));
  }catch(e){ el.textContent = 'Error sending test email'; }
});

// RAG upload
document.getElementById('rag-upload').addEventListener('click', async ()=>{
  const files = document.getElementById('rag-files').files;
  const status = document.getElementById('rag-upload-status');
  if(!files || files.length===0){ status.textContent = 'Select files first.'; return; }
  const fd = new FormData();
  [...files].forEach(f => fd.append('files', f));
  status.textContent = 'Uploading & indexing…';
  try{
    const headers={}; const tok=localStorage.getItem('ADMIN_TOKEN'); if(tok) headers['X-Admin-Token']=tok;
    const r = await fetch('/api/v1/files/upload', { method:'POST', headers, body: fd });
    const j = await r.json();
    status.textContent = j.success ? `Indexed ${j.indexed} docs.` : `Error: ${j.error}`;
  }catch(e){ status.textContent = 'Upload failed'; }
});

// RAG ask
document.getElementById('rag-ask').addEventListener('click', async ()=>{
  const q = document.getElementById('rag-query').value;
  const out = document.getElementById('rag-answer');
  out.textContent = 'Querying…';
  try{
    const r = await fetch('/api/v1/rag/query', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({query:q})});
    const j = await r.json();
    if(!j.success){ out.textContent = 'Error: ' + (j.error||'failed'); return; }
    const ctx = (j.contexts||[]).map(c=>{ const m=c.metadata||{}; const label=m.title||m.project||c.id; return `- ${label}`; }).join('\n');
    out.textContent = (j.augmented_query||q) + '\n\nContexts:\n' + ctx;
  }catch(e){ out.textContent = 'Query failed'; }
});

// NLP execute
document.getElementById('nlp-run').addEventListener('click', async ()=>{
  const prompt = document.getElementById('nlp-prompt').value;
  const provider = document.getElementById('nlp-provider').value;
  const use_rag = document.getElementById('nlp-use-rag').checked;
  const out = document.getElementById('nlp-output');
  out.textContent = 'Running…';
  try{
    const headers={'Content-Type':'application/json'}; const tok=localStorage.getItem('ADMIN_TOKEN'); if(tok) headers['X-Admin-Token']=tok;
    const r = await fetch('/api/v1/nlp/execute', {method:'POST', headers, body: JSON.stringify({prompt, provider, use_rag})});
    const j = await r.json();
    if(j.requires_confirmation && j.inferred_intent){
      out.textContent = `Intent: ${j.inferred_intent}\nPreview: ${JSON.stringify(j.inferred_args)}`;
      if(confirm('Detected intent: ' + j.inferred_intent + '. Execute?')){
        const headers2={'Content-Type':'application/json'}; const tok2=localStorage.getItem('ADMIN_TOKEN'); if(tok2) headers2['X-Admin-Token']=tok2;
        const r2= await fetch('/api/v1/nlp/execute', {method:'POST', headers: headers2, body: JSON.stringify({intent: j.inferred_intent, args: j.inferred_args, confirm:true})});
        const j2= await r2.json();
        out.textContent = j2.success ? ('Executed: ' + JSON.stringify(j2)) : ('Error: ' + (j2.error||'failed'));
      }
      return;
    }
    if(!j.success){ out.textContent = 'Error: ' + (j.error||'failed'); return; }
    out.textContent = `[${j.provider} -> ${j.model}]\n\n` + (j.response||'')
  }catch(e){ out.textContent = 'Execution failed'; }
});

function confirmAndRun(intent, args, statusEl){
  if(!confirm('Proceed with this action?')) return;
  statusEl.textContent = 'Executing…';
  const headers={'Content-Type':'application/json'}; const tok=localStorage.getItem('ADMIN_TOKEN'); if(tok) headers['X-Admin-Token']=tok;
  fetch('/api/v1/nlp/execute', {method:'POST', headers, body: JSON.stringify({intent, args, confirm:true})})
    .then(r=>r.json()).then(j=>{
      statusEl.textContent = j.success ? ('Done: ' + (j.preview ? JSON.stringify(j.preview) : 'ok')) : ('Error: ' + (j.error||'failed'));
    }).catch(()=> statusEl.textContent='Request failed');
}

document.getElementById('wf-run').addEventListener('click', ()=>{
  const path = document.getElementById('wf-path').value || 'note.txt';
  const content = document.getElementById('wf-content').value || 'Hello from Autonomous PM';
  confirmAndRun('write_file', {path, content}, document.getElementById('wf-status'));
});

// Activity log
async function loadActivity(){
  try{
    const c = await fetchJSON('/api/v1/activity/communications');
    const f = await fetchJSON('/api/v1/activity/files');
    const comm = (c.items||[]).slice(0,10).map(it=>`<tr><td>${it.sent_at||''}</td><td>${it.project_id||''}</td><td>${it.channel||''}</td><td>${it.subject||''}</td><td>${it.status||''}</td></tr>`).join('');
    document.getElementById('tbl-comm').innerHTML = comm || '<tr><td colspan="5" class="text-muted">No communications yet</td></tr>';
    const files = (f.files||[]).slice(0,10).map(it=>`<tr><td>${it.modified||''}</td><td>${it.path||''}</td><td>${it.size||0}</td><td><button class='btn btn-sm btn-outline-light' data-path='${it.path}'>View</button></td></tr>`).join('');
    document.getElementById('tbl-files').innerHTML = files || '<tr><td colspan="4" class="text-muted">No files yet</td></tr>';
    document.querySelectorAll('#tbl-files button[data-path]').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const p = btn.getAttribute('data-path');
        const r = await fetch('/api/v1/ops/file?path=' + encodeURIComponent(p));
        const j = await r.json();
        alert(j.success ? (j.content||'') : (j.error||'Failed'));
      });
    });
  }catch(e){}
}
await loadActivity();

document.getElementById('tm-run').addEventListener('click', ()=>{
  const project_id = document.getElementById('tm-project').value || null;
  const recipients = (document.getElementById('tm-recipients').value||'').split(',').map(s=>s.trim()).filter(Boolean);
  const subject = document.getElementById('tm-subject').value || 'Team Update';
  const message = document.getElementById('tm-message').value || 'Status update from Autonomous PM';
  confirmAndRun('team_message', {project_id, recipients, subject, message}, document.getElementById('tm-status'));
});

document.getElementById('ee-run').addEventListener('click', ()=>{
  const recipients = (document.getElementById('ee-recipients').value||'').split(',').map(s=>s.trim()).filter(Boolean);
  const subject = document.getElementById('ee-subject').value || 'Executive Update';
  const body = document.getElementById('ee-body').value || 'Summary from Autonomous PM';
  confirmAndRun('exec_email', {recipients, subject, body}, document.getElementById('ee-status'));
});

document.getElementById('lu-run').addEventListener('click', ()=>{
  const name = document.getElementById('lu-name').value || 'Autonomous PM';
  const project = document.getElementById('lu-project').value || 'N/A';
  const update = document.getElementById('lu-update').value || 'Automated update.';
  confirmAndRun('leadership_update', {name, project, update}, document.getElementById('lu-status'));
});
</script>
{% endblock %}
